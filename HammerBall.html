<!-- Construction HammerBall (Pong) Game -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=900, initial-scale=1.0">
    <title>Construction HammerBall</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(ellipse at 60% 40%, #ffd70033 0%, #23232b 100%), linear-gradient(135deg, #23232b 0%, #2d2d3a 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            min-width: 100vw;
             overflow: hidden;
        }
        .animated-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .bg-shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.18;
            filter: blur(18px);
            animation: floatBg 8s ease-in-out infinite alternate;
        }
        .bg-shape1 { width: 340px; height: 340px; background: #ffd700; left: 8vw; top: 10vh; animation-delay: 0s; }
        .bg-shape2 { width: 220px; height: 220px; background: #ff4e00; right: 10vw; top: 30vh; animation-delay: 2s; }
        .bg-shape3 { width: 180px; height: 180px; background: #00cfff; left: 30vw; bottom: 8vh; animation-delay: 4s; }
        @keyframes floatBg {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-30px) scale(1.08); }
        }
        #game-container {
            position: relative;
            width: 900px;
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.95);
            border: 8px solid #e0a106;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 24px;
            overflow: hidden;
        }
        #game-canvas {
            background: #d1c089;
            display: block;
            margin: 0 auto 16px auto;
            border: 4px solid #bfa14a;
        }
        #score-area {
            text-align: center;
            margin: 12px 0;
        }
        #score-label {
            font-size: 1.3em;
            color: #e0a106;
            font-weight: bold;
            background: rgba(255,255,255,0.7);
            padding: 6px 24px;
            border-radius: 12px;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.08);
        }
        #main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.2rem;
            padding: 2.5rem 0 2rem 0;
        }
        #main-menu input[type="text"] {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 2px solid #e0a106;
            width: 260px;
            margin-bottom: 0.5rem;
        }
        #main-menu button {
            font-size: 1.2rem;
            padding: 0.7rem 2.2rem;
            background: linear-gradient(90deg,#e0a106,#ff4e00);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(224,161,6,0.13);
            transition: transform 0.13s;
        }
        #main-menu button:hover {
            transform: scale(1.06);
        }
        #main-menu label {
            font-size: 1.1rem;
            color: #bfa14a;
            font-weight: 500;
        }
        #difficulty-meter {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }
        #difficulty-bar {
            height: 100%;
            background: linear-gradient(90deg, #e0a106, #ff4e00);
            transition: width 0.3s;
        }
        /* Construction field details */
        #game-canvas.construction-bg {
            background-image: repeating-linear-gradient(135deg, #e0a10622 0 10px, transparent 10px 20px);
        }
        /* Paddle hit animation */
        /* .paddle-hit {
            animation: paddle-bounce 0.18s cubic-bezier(.5,1.8,.5,1) 1;
        }
        @keyframes paddle-bounce {
            0% { transform: scaleY(1); }
            40% { transform: scaleY(1.18); }
            100% { transform: scaleY(1); }
        }
        .ball-squash {
            animation: ball-squash 0.18s cubic-bezier(.5,1.8,.5,1) 1;
        }
        @keyframes ball-squash {
            0% { transform: scale(1,1); }
            40% { transform: scale(1.2,0.8); }
            100% { transform: scale(1,1); }
        } */
        /* Score pop */
        #score-label.score-pop {
            animation: score-pop 0.3s cubic-bezier(.5,1.8,.5,1) 1;
        }
        @keyframes score-pop {
            0% { transform: scale(1); }
            40% { transform: scale(1.18); }
            100% { transform: scale(1); }
        }
        /* HUD panel */
        .hud-panel {
            position: absolute;
            top: 18px;
            left: 18px;
            background: rgba(255,255,255,0.85);
            border: 2px solid #e0a106;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(224,161,6,0.13);
            padding: 10px 18px 10px 12px;
            z-index: 10;
        }
        /* Leaderboard styles (copied and adapted from Construction Snake) */
        #leaderboard {
            margin: 32px auto 0 auto;
            max-width: 420px;
            background: rgba(255,255,255,0.97);
            border-radius: 16px;
            box-shadow: 0 4px 24px #0002, 0 0 0 2px #ffd70033;
            padding: 18px 24px 24px 24px;
            border: 2.5px solid #e0a106;
            display: none;
            position: relative;
            z-index: 2;
        }
        #leaderboard h2 {
            color: #e0a106;
            font-size: 1.5rem;
            margin: 0 0 18px 0;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 700;
        }
        #leaderboard-entries {
            min-height: 120px;
        }
        .score-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.10);
            margin-bottom: 10px;
            padding: 8px 18px 8px 38px;
            position: relative;
            font-size: 1.08em;
            font-family: 'Segoe UI', Arial, sans-serif;
            border-left: 4px solid #e0a106;
            transition: background 0.18s, box-shadow 0.18s;
        }
        .score-entry:last-child { margin-bottom: 0; }
        .score-entry::before {
            content: attr(data-rank);
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e0a106;
            font-weight: bold;
            font-size: 1.1em;
            opacity: 0.85;
        }
        .score-entry .player-name {
            color: #000;
            margin-right: 10px;
            background-color: rgba(255,255,255,0.85);
            padding: 4px 12px;
            border-radius: 12px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
            text-shadow: none;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .score-entry small {
            display: inline-block;
            color: #555;
            background-color: rgba(255,255,255,0.7);
            font-weight: normal;
            margin-left: 5px;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.8em;
            vertical-align: middle;
        }
        .score-entry .player-score {
            color: #000;
            font-size: 1.2em;
            background-color: rgba(255,255,255,0.9);
            padding: 4px 12px;
            border-radius: 12px;
            min-width: 70px;
            text-align: center;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .score-entry.current-player {
            background-color: rgba(255,250,235,0.5);
            border-left: 5px solid #ff9900;
            animation: pulse-glow 2s infinite;
        }
        .score-entry.current-player .player-name {
            background-color: rgba(255,236,179,0.95);
            border: 1px solid rgba(255,153,0,0.6);
            font-weight: 700;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px rgba(255,153,0,0.3); }
            50% { box-shadow: 0 0 15px rgba(255,153,0,0.6); }
            100% { box-shadow: 0 0 5px rgba(255,153,0,0.3); }
        }
        #leaderboard-entries.loading {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(224,161,6,0.3);
            border-top: 4px solid #e0a106;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 1000px) {
            #game-container { width: 98vw; }
            #game-canvas { width: 98vw !important; height: 98vw !important; max-width: 98vw; max-height: 98vw; }
        }
    </style>
</head>
<body>
    <div class="animated-bg">
        <div class="bg-shape bg-shape1"></div>
        <div class="bg-shape bg-shape2"></div>
        <div class="bg-shape bg-shape3"></div>
    </div>
    <div id="game-container">
        <h1 style="color:#e0a106;text-align:center;">üî® Construction HammerBall üî®</h1>
        <div id="main-menu">
            <label for="player-name">Enter your name to play:</label>
            <input type="text" id="player-name" maxlength="16" placeholder="Your name..." autocomplete="off" />
            <div style="margin:1.2rem 0;display:flex;gap:1.2rem;">
                <button id="single-btn">Single Player</button>
                <button id="versus-btn">Ultra Single Player</button>
                <button id="twoplayer-btn">Classic 2 Player</button>
            </div>
            <button id="start-btn" style="display:none;margin-top:1.5rem;min-width:180px;opacity:0;transform:translateY(20px);transition:opacity 0.4s,transform 0.4s;">Start Game</button>
        </div>
        <canvas id="game-canvas" width="800" height="600" style="display:none;"></canvas>
        <div id="score-area" style="display:none;">
            <span id="score-label">Score: 0</span>
        </div>
        <div id="difficulty-meter" style="display:none;">
            <div id="difficulty-bar"></div>
        </div>
        <!-- Leaderboard and other UI elements can be added here if needed -->
        <div id="leaderboard" style="display:none;">
            <h2>Leaderboard</h2>
            <div id="leaderboard-entries">Loading...</div>
        </div>
    </div>
    <script>
    // --- Construction HammerBall Game JS ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const mainMenu = document.getElementById('main-menu');
    const playerNameInput = document.getElementById('player-name');
    const scoreArea = document.getElementById('score-area');
    const scoreLabel = document.getElementById('score-label');
    const singleButton = document.getElementById('single-btn');
    const versusButton = document.getElementById('versus-btn');
    const twoPlayerButton = document.getElementById('twoplayer-btn');
    const startButton = document.getElementById('start-btn');
    const difficultyMeter = document.createElement('div');
    difficultyMeter.id = 'difficulty-meter';
    const difficultyBar = document.createElement('div');
    difficultyBar.id = 'difficulty-bar';
    difficultyMeter.appendChild(difficultyBar);
    document.getElementById('game-container').insertBefore(difficultyMeter, canvas);
    difficultyMeter.style.display = 'none';

    let selectedMode = null;
    let twoPlayerControls = false;

    // Animate menu and button
    function showStartButton() {
        startButton.style.display = 'block';
        setTimeout(() => {
            startButton.style.opacity = '1';
            startButton.style.transform = 'translateY(0)';
        }, 10);
    }
    function hideStartButton() {
        startButton.style.opacity = '0';
        startButton.style.transform = 'translateY(20px)';
        setTimeout(() => {
            startButton.style.display = 'none';
        }, 400);
    }

    singleButton.addEventListener('click', () => {
        selectedMode = 'single';
        twoPlayerControls = false;
        singleButton.classList.add('selected');
        versusButton.classList.remove('selected');
        twoPlayerButton.classList.remove('selected');
        showStartButton();
    });
    versusButton.addEventListener('click', () => {
        selectedMode = 'ultra-single';
        twoPlayerControls = false;
        versusButton.classList.add('selected');
        singleButton.classList.remove('selected');
        twoPlayerButton.classList.remove('selected');
        showStartButton();
    });
    twoPlayerButton.addEventListener('click', () => {
        selectedMode = 'two-player';
        twoPlayerControls = true;
        twoPlayerButton.classList.add('selected');
        singleButton.classList.remove('selected');
        versusButton.classList.remove('selected');
        showStartButton();
    });
    startButton.addEventListener('click', () => {
        if (!selectedMode) return;
        playerName = playerNameInput.value.trim() || "Anonymous";
        // Animate menu out
        mainMenu.style.transition = 'opacity 0.5s, transform 0.5s';
        mainMenu.style.opacity = '0';
        mainMenu.style.transform = 'translateY(-30px)';
        setTimeout(() => {
            mainMenu.style.display = 'none';
            mainMenu.style.opacity = '';
            mainMenu.style.transform = '';
            if (selectedMode === 'single') resetGame('single');
            else if (selectedMode === 'ultra-single') resetGame('ultra-single');
            else if (selectedMode === 'two-player') resetGame('two-player');
        }, 500);
    });

    // Add selected button style
    const style = document.createElement('style');
    style.textContent = `
        #main-menu button.selected {
            box-shadow: 0 0 0 3px #e0a10699;
            background: linear-gradient(90deg,#ffe066,#ffb347);
            color: #b36a00;
            font-weight: 700;
            transform: scale(1.08);
        }
        #main-menu button.selected:hover {
            transform: scale(1.12);
        }
    `;
    document.head.appendChild(style);

    // Game constants
    const PADDLE_WIDTH = 18;
    const PADDLE_HEIGHT = 100;
    const BALL_SIZE = 22;
    const FIELD_WIDTH = 800;
    const FIELD_HEIGHT = 600;
    const PADDLE_SPEED = 7;
    const BALL_SPEED = 7;
    const ULTRA_POWERUP_DURATION = 300; // frames
    const POWERUP_SIZE = 32;
    const POWERUP_TYPES = [
        { type: "magnet", color: "#4ecaff", icon: "üß≤" },
        { type: "ghost", color: "#b3b3ff", icon: "üëª" },
        { type: "shield", color: "#76e6cd", icon: "üõ°Ô∏è" },
        { type: "drill", color: "#c0c0c0", icon: "üî©" }
    ];

    // Game state
    let gameMode = "classic"; // "classic" or "ultra"
    let running = false;
    let playerName = "";
    let score = 0;
    let intervalId = null;
    let leftPaddle, rightPaddle, ball, powerups, activePowerups, powerupTimer, aiEnabled;
    let baseBallSpeed = BALL_SPEED;
    let maxBallSpeed = 16;
    let difficultyProgress = 0;

    function resetGame(mode) {
        gameMode = mode;
        running = true;
        score = 0;
        leftPaddle = { x: 30, y: FIELD_HEIGHT/2 - PADDLE_HEIGHT/2, vy: 0 };
        rightPaddle = { x: FIELD_WIDTH-48, y: FIELD_HEIGHT/2 - PADDLE_HEIGHT/2, vy: 0 };
        baseBallSpeed = BALL_SPEED;
        ball = {
            x: FIELD_WIDTH/2 - BALL_SIZE/2,
            y: FIELD_HEIGHT/2 - BALL_SIZE/2,
            vx: baseBallSpeed * (Math.random() > 0.5 ? 1 : -1),
            vy: baseBallSpeed * (Math.random()*2-1)
        };
        powerups = [];
        activePowerups = [];
        powerupTimer = 0;
        aiEnabled = (mode === "single" || mode === "ultra-single");
        twoPlayerControls = (mode === "two-player");
        scoreLabel.textContent = "Score: 0";
        canvas.style.display = 'block';
        scoreArea.style.display = 'block';
        mainMenu.style.display = 'none';
        difficultyMeter.style.display = (mode === 'ultra-single') ? 'block' : 'none';
        updateDifficultyBar();
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(gameLoop, 1000/60);
    }

    function updateDifficultyBar() {
        // Progress is based on ball speed
        const percent = Math.min(100, 100 * (Math.abs(ball.vx) - BALL_SPEED) / (maxBallSpeed - BALL_SPEED));
        difficultyBar.style.width = percent + '%';
        difficultyBar.style.height = '100%';
        difficultyBar.style.background = 'linear-gradient(90deg, #e0a106, #ff4e00)';
        difficultyBar.style.transition = 'width 0.3s';
    }

    // --- Add construction field background ---
    canvas.classList.add('construction-bg');

    // --- Animate paddle and ball on hit ---
    // function animatePaddleHit(isLeft) {
    //     const el = canvas;
    //     el.classList.remove('paddle-hit');
    //     void el.offsetWidth; // force reflow
    //     el.classList.add('paddle-hit');
    // }
    // function animateBallSquash() {
    //     const el = canvas;
    //     el.classList.remove('ball-squash');
    //     void el.offsetWidth;
    //     el.classList.add('ball-squash');
    // }
    function animateScorePop() {
        scoreLabel.classList.remove('score-pop');
        void scoreLabel.offsetWidth;
        scoreLabel.classList.add('score-pop');
    }

    // --- Enhanced drawField ---
    function drawField() {
        ctx.fillStyle = '#e8ddb7';
        ctx.fillRect(0, 0, FIELD_WIDTH, FIELD_HEIGHT);
        // Center line with animated dashes
        ctx.save();
        ctx.strokeStyle = '#bfa14a';
        ctx.setLineDash([16, 16]);
        ctx.lineWidth = 4;
        ctx.globalAlpha = 0.7;
        ctx.beginPath();
        const dashOffset = (Date.now()/30)%32;
        ctx.setLineDash([16, 16]);
        ctx.lineDashOffset = -dashOffset;
        ctx.moveTo(FIELD_WIDTH/2, 0);
        ctx.lineTo(FIELD_WIDTH/2, FIELD_HEIGHT);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.globalAlpha = 1;
        // Construction cones
        for (let i=0; i<3; i++) {
            const cx = FIELD_WIDTH/2-18 + (i-1)*60;
            const cy = 60 + i*120 + 20*Math.sin(Date.now()/600+i);
            ctx.save();
            ctx.translate(cx, cy);
            ctx.beginPath();
            ctx.moveTo(0, 18); ctx.lineTo(-12, -18); ctx.lineTo(12, -18); ctx.closePath();
            ctx.fillStyle = '#ff4e00'; ctx.fill();
            ctx.fillStyle = '#fff'; ctx.fillRect(-8, -8, 16, 4);
            ctx.restore();
        }
        ctx.restore();
    }

    // --- Enhanced drawPaddle ---
    function drawPaddle(paddle, isLeft) {
        ctx.save();
        ctx.fillStyle = isLeft ? '#e0a106' : '#ff4e00';
        ctx.shadowColor = '#bfa14a';
        ctx.shadowBlur = 8;
        ctx.fillRect(paddle.x, paddle.y, PADDLE_WIDTH, PADDLE_HEIGHT);
        // Bolts
        for (let i=0; i<3; i++) {
            ctx.beginPath();
            ctx.arc(paddle.x+PADDLE_WIDTH/2, paddle.y+18+i*32, 3, 0, 2*Math.PI);
            ctx.fillStyle = '#bfa14a';
            ctx.fill();
        }
        ctx.restore();
    }

    // --- Enhanced drawBall ---
    function drawBall() {
        ctx.save();
        // Ball trail if powerup
        if (activePowerups.length > 0) {
            for (let i=0; i<6; i++) {
                ctx.globalAlpha = 0.08 + 0.04*i;
                ctx.beginPath();
                ctx.arc(ball.x + BALL_SIZE/2 - ball.vx*i*2, ball.y + BALL_SIZE/2 - ball.vy*i*2, BALL_SIZE/2, 0, 2*Math.PI);
                ctx.fillStyle = '#e0a106';
                ctx.fill();
            }
        }
        ctx.globalAlpha = 1;
        ctx.fillStyle = '#fffbe6';
        ctx.strokeStyle = '#e0a106';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(ball.x + BALL_SIZE/2, ball.y + BALL_SIZE/2, BALL_SIZE/2, 0, 2*Math.PI);
        ctx.fill();
        ctx.stroke();
        // Construction hat
        ctx.save();
        ctx.translate(ball.x + BALL_SIZE/2, ball.y + BALL_SIZE/2 - 8);
        ctx.beginPath();
        ctx.arc(0, 0, 8, Math.PI, 2*Math.PI);
        ctx.fillStyle = '#e0a106';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(0, 0, 8, 0, Math.PI);
        ctx.fillStyle = '#fffbe6';
        ctx.globalAlpha = 0.7;
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.restore();
        ctx.restore();
    }

    // --- Enhanced drawPowerups ---
    function drawPowerups() {
        for (const p of powerups) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(p.x + POWERUP_SIZE/2, p.y + POWERUP_SIZE/2, POWERUP_SIZE/2, 0, 2*Math.PI);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = 0.7 + 0.3 * Math.sin(Date.now()/200);
            ctx.shadowColor = p.color;
            ctx.shadowBlur = 12;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 1;
            ctx.font = '24px Segoe UI';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // Animate float
            const floatY = 4*Math.sin(Date.now()/180 + p.x);
            ctx.fillText(p.icon, p.x + POWERUP_SIZE/2, p.y + POWERUP_SIZE/2 + 1 + floatY);
            ctx.restore();
        }
    }

    // --- Enhanced drawHUD ---
    function drawHUD() {
        if ((gameMode === "ultra" || gameMode === "ultra-single") && activePowerups.length > 0) {
            ctx.save();
            ctx.globalAlpha = 1;
            ctx.font = 'bold 18px Segoe UI';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            // HUD panel
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(12, 12); ctx.lineTo(160, 12); ctx.lineTo(160, 18+activePowerups.length*36); ctx.lineTo(12, 18+activePowerups.length*36); ctx.closePath();
            ctx.fillStyle = 'rgba(255,255,255,0.85)';
            ctx.strokeStyle = '#e0a106';
            ctx.lineWidth = 2;
            ctx.fill(); ctx.stroke();
            ctx.restore();
            let hudY = 18;
            for (const ap of activePowerups) {
                const details = POWERUP_TYPES.find(p => p.type === ap.type);
                if (!details) continue;
                // Animate icon pulse
                const pulse = 1 + 0.08 * Math.sin(Date.now()/180 + hudY);
                ctx.save();
                ctx.translate(32, hudY+12);
                ctx.scale(pulse, pulse);
                ctx.fillText(details.icon, 0, 0);
                ctx.restore();
                ctx.fillStyle = details.color;
                ctx.fillText(` ${details.type.charAt(0).toUpperCase() + details.type.slice(1)}`, 48, hudY);
                // Timer bar
                ctx.save();
                ctx.fillStyle = 'rgba(60,60,60,0.75)';
                ctx.fillRect(20, hudY+22, 100, 7);
                ctx.fillStyle = details.color;
                ctx.fillRect(20, hudY+22, 100 * (ap.timer/ULTRA_POWERUP_DURATION), 7);
                ctx.restore();
                hudY += 36;
            }
            ctx.restore();
        }
    }

    // --- Enhanced applyPowerupEffects ---
    function applyPowerupEffects() {
        // Magnet: ball curves toward left paddle
        if (activePowerups.some(p => p.type === "magnet")) {
            if (ball.vx < 0) {
                const paddleCenter = leftPaddle.y + PADDLE_HEIGHT/2;
                const ballCenter = ball.y + BALL_SIZE/2;
                const diff = paddleCenter - ballCenter;
                ball.vy += 0.13 * Math.sign(diff);
                ball.vy = Math.max(-maxBallSpeed, Math.min(maxBallSpeed, ball.vy));
                // Magnet lines
                ctx.save();
                ctx.strokeStyle = '#4ecaff';
                ctx.globalAlpha = 0.5;
                ctx.beginPath();
                ctx.moveTo(ball.x + BALL_SIZE/2, ball.y + BALL_SIZE/2);
                ctx.lineTo(leftPaddle.x + PADDLE_WIDTH, paddleCenter);
                ctx.stroke();
                ctx.restore();
            }
        }
        // Ghost: ball passes through left paddle once
        if (activePowerups.some(p => p.type === "ghost")) {
            if (ball.x <= leftPaddle.x + PADDLE_WIDTH && ball.y + BALL_SIZE > leftPaddle.y && ball.y < leftPaddle.y + PADDLE_HEIGHT && ball.vx < 0) {
                const idx = activePowerups.findIndex(p => p.type === "ghost");
                if (idx !== -1) {
                    // Animate ghost effect
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            ctx.save();
                            ctx.globalAlpha = 0.15 + 0.1 * Math.sin(Date.now()/60 + i);
                            ctx.beginPath();
                            ctx.arc(ball.x + BALL_SIZE/2, ball.y + BALL_SIZE/2, BALL_SIZE/2 + i*2, 0, 2*Math.PI);
                            ctx.fillStyle = '#b3b3ff';
                            ctx.fill();
                            ctx.restore();
                        }, i*12);
                    }
                    activePowerups.splice(idx, 1);
                    ball.x = leftPaddle.x + PADDLE_WIDTH + 2;
                }
            }
        }
        // Shield: ball reflects off left wall once
        if (activePowerups.some(p => p.type === "shield")) {
            if (ball.x < 0 && ball.vx < 0) {
                const idx = activePowerups.findIndex(p => p.type === "shield");
                if (idx !== -1) {
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            ctx.save();
                            ctx.globalAlpha = 0.12 + 0.1 * Math.sin(Date.now()/60 + i);
                            ctx.beginPath();
                            ctx.arc(0, ball.y + BALL_SIZE/2, 24 + i*2, 0, 2*Math.PI);
                            ctx.fillStyle = '#76e6cd';
                            ctx.fill();
                            ctx.restore();
                        }, i*12);
                    }
                    activePowerups.splice(idx, 1);
                    ball.x = 2;
                    ball.vx *= -1;
                }
            }
        }
        // Drill: ball pierces through left paddle, bounces off left wall
        if (activePowerups.some(p => p.type === "drill")) {
            if (ball.x <= leftPaddle.x + PADDLE_WIDTH && ball.y + BALL_SIZE > leftPaddle.y && ball.y < leftPaddle.y + PADDLE_HEIGHT && ball.vx < 0) {
                const idx = activePowerups.findIndex(p => p.type === "drill");
                if (idx !== -1) {
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            ctx.save();
                            ctx.globalAlpha = 0.13 + 0.1 * Math.sin(Date.now()/60 + i);
                            ctx.beginPath();
                            ctx.arc(ball.x + BALL_SIZE/2, ball.y + BALL_SIZE/2, BALL_SIZE/2 + i*2, 0, 2*Math.PI);
                            ctx.fillStyle = '#c0c0c0';
                            ctx.fill();
                            ctx.restore();
                        }, i*12);
                    }
                    activePowerups.splice(idx, 1);
                    ball.x = 2;
                    ball.vx *= -1;
                }
            }
        }
    }

    // --- Enhanced gameLoop ---
    function gameLoop() {
        // Move paddles
        if (leftPaddle.vy) leftPaddle.y += leftPaddle.vy;
        if (rightPaddle.vy) rightPaddle.y += rightPaddle.vy;
        leftPaddle.y = Math.max(0, Math.min(FIELD_HEIGHT-PADDLE_HEIGHT, leftPaddle.y));
        rightPaddle.y = Math.max(0, Math.min(FIELD_HEIGHT-PADDLE_HEIGHT, rightPaddle.y));
        if (aiEnabled) {
            if (ball.y + BALL_SIZE/2 < rightPaddle.y + PADDLE_HEIGHT/2 - 10) rightPaddle.vy = -PADDLE_SPEED;
            else if (ball.y + BALL_SIZE/2 > rightPaddle.y + PADDLE_HEIGHT/2 + 10) rightPaddle.vy = PADDLE_SPEED;
            else rightPaddle.vy = 0;
        }
        ball.x += ball.vx;
        ball.y += ball.vy;
        // Ball collision with top/bottom
        if (ball.y <= 0 || ball.y + BALL_SIZE >= FIELD_HEIGHT) {
            ball.vy *= -1;
            // animateBallSquash(); // removed to prevent wobble
        }
        // Powerup effects
        if ((gameMode === 'ultra' || gameMode === 'ultra-single') && activePowerups.length > 0) {
            applyPowerupEffects();
        }
        // Ball collision with paddles
        if (ball.x <= leftPaddle.x + PADDLE_WIDTH && ball.y + BALL_SIZE > leftPaddle.y && ball.y < leftPaddle.y + PADDLE_HEIGHT) {
            ball.x = leftPaddle.x + PADDLE_WIDTH;
            ball.vx *= -1;
            // animatePaddleHit(true); // removed to prevent wobble
            // animateBallSquash(); // removed to prevent wobble
        }
        if (ball.x + BALL_SIZE >= rightPaddle.x && ball.y + BALL_SIZE > rightPaddle.y && ball.y < rightPaddle.y + PADDLE_HEIGHT) {
            ball.x = rightPaddle.x - BALL_SIZE;
            ball.vx *= -1;
            // animatePaddleHit(false); // removed to prevent wobble
            // animateBallSquash(); // removed to prevent wobble
        }
        // Ball out of bounds (score)
        if (ball.x < 0 || ball.x > FIELD_WIDTH) {
            endGame();
            return;
        }
        // Ultra single mode: spawn powerups, increase difficulty
        if (gameMode === 'ultra-single') {
            if (Math.random() < 0.008 && powerups.length < 1) {
                const ptype = POWERUP_TYPES[Math.floor(Math.random()*POWERUP_TYPES.length)];
                powerups.push({
                    ...ptype,
                    x: Math.random()*(FIELD_WIDTH-POWERUP_SIZE-40)+20,
                    y: Math.random()*(FIELD_HEIGHT-POWERUP_SIZE-40)+20
                });
            }
            for (let i=powerups.length-1; i>=0; i--) {
                const p = powerups[i];
                const dx = (ball.x+BALL_SIZE/2)-(p.x+POWERUP_SIZE/2);
                const dy = (ball.y+BALL_SIZE/2)-(p.y+POWERUP_SIZE/2);
                if (Math.sqrt(dx*dx+dy*dy) < BALL_SIZE/2 + POWERUP_SIZE/2) {
                    activePowerups.push({ type: p.type, timer: ULTRA_POWERUP_DURATION });
                    powerups.splice(i,1);
                }
            }
            for (let i=activePowerups.length-1; i>=0; i--) {
                activePowerups[i].timer--;
                if (activePowerups[i].timer <= 0) activePowerups.splice(i,1);
            }
            if (score > 0 && score % 100 === 0 && Math.abs(ball.vx) < maxBallSpeed) {
                ball.vx *= 1.12;
                ball.vy *= 1.12;
                updateDifficultyBar();
            }
            updateDifficultyBar();
        }
        // Update score
        score++;
        animateScorePop();
        scoreLabel.textContent = `Score: ${score}`;
        ctx.clearRect(0,0,FIELD_WIDTH,FIELD_HEIGHT);
        drawGame();
    }

    // --- Draw everything per frame ---
    function drawGame() {
        drawField();
        drawPaddle(leftPaddle, true);
        drawPaddle(rightPaddle, false);
        drawBall();
        if (gameMode === 'ultra-single') drawPowerups();
        drawHUD();
    }

    // Controls
    let leftPaddleUp = false, leftPaddleDown = false, rightPaddleUp = false, rightPaddleDown = false;
    document.addEventListener('keydown', e => {
        if (!running) return;
        if (twoPlayerControls) {
            if (e.key === 'w' || e.key === 'W') leftPaddleUp = true;
            if (e.key === 's' || e.key === 'S') leftPaddleDown = true;
            if (e.key === 'ArrowUp') rightPaddleUp = true;
            if (e.key === 'ArrowDown') rightPaddleDown = true;
        } else {
            if (e.key === 'w' || e.key === 'ArrowUp') leftPaddle.vy = -PADDLE_SPEED;
            if (e.key === 's' || e.key === 'ArrowDown') leftPaddle.vy = PADDLE_SPEED;
        }
    });
    document.addEventListener('keyup', e => {
        if (!running) return;
        if (twoPlayerControls) {
            if (e.key === 'w' || e.key === 'W') leftPaddleUp = false;
            if (e.key === 's' || e.key === 'S') leftPaddleDown = false;
            if (e.key === 'ArrowUp') rightPaddleUp = false;
            if (e.key === 'ArrowDown') rightPaddleDown = false;
        } else {
            if (e.key === 'w' || e.key === 'ArrowUp') leftPaddle.vy = 0;
            if (e.key === 's' || e.key === 'ArrowDown') leftPaddle.vy = 0;
        }
    });

    // Main menu buttons
    singleButton.addEventListener('click', () => {
        selectedMode = 'single';
        singleButton.classList.add('selected');
        versusButton.classList.remove('selected');
        twoPlayerButton.classList.remove('selected');
        showStartButton();
    });
    versusButton.addEventListener('click', () => {
        selectedMode = 'ultra-single';
        versusButton.classList.add('selected');
        singleButton.classList.remove('selected');
        twoPlayerButton.classList.remove('selected');
        showStartButton();
    });
    twoPlayerButton.addEventListener('click', () => {
        selectedMode = 'two-player';
        twoPlayerButton.classList.add('selected');
        singleButton.classList.remove('selected');
        versusButton.classList.remove('selected');
        showStartButton();
    });
    startButton.addEventListener('click', () => {
        if (!selectedMode) return;
        playerName = playerNameInput.value.trim() || "Anonymous";
        mainMenu.style.transition = 'opacity 0.5s, transform 0.5s';
        mainMenu.style.opacity = '0';
        mainMenu.style.transform = 'translateY(-30px)';
        setTimeout(() => {
            mainMenu.style.display = 'none';
            mainMenu.style.opacity = '';
            mainMenu.style.transform = '';
            if (selectedMode === 'single') resetGame('single');
            else if (selectedMode === 'ultra-single') resetGame('ultra-single');
            else if (selectedMode === 'two-player') resetGame('two-player');
        }, 500);
    });

    // --- Firebase logic for leaderboard (uses window.firebase* globals set by module script) ---
    var db, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp;

    (function() {
        function assignFirebaseGlobals() {
            db = window.firebaseFirestore;
            collection = window.firebaseCollection;
            addDoc = window.firebaseAddDoc;
            query = window.firebaseQuery;
            orderBy = window.firebaseOrderBy;
            limit = window.firebaseLimit;
            getDocs = window.firebaseGetDocs;
            serverTimestamp = window.firebaseServerTimestamp;
        }
        if (window.firebaseFirestore) {
            assignFirebaseGlobals();
        } else {
            document.addEventListener('firebase-ready', assignFirebaseGlobals);
        }
    })();

    const leaderboardCollectionName = "hammerballLeaderboard";
    const leaderboard = document.getElementById('leaderboard');
    const leaderboardEntries = document.getElementById('leaderboard-entries');
    const LEADERBOARD_SIZE = 6;

    function submitScore(name, finalScore) {
        if (!db || !collection) return;
        // Prevent leaderboard submission for two-player mode
        if (selectedMode === 'two-player' || gameMode === 'two-player' || finalScore <= 0) {
            updateLeaderboard();
            return;
        }
        const scoresCollection = collection(db, leaderboardCollectionName);
        addDoc(scoresCollection, {
            name: name,
            score: finalScore,
            mode: gameMode,
            timestamp: serverTimestamp()
        }).then(() => {
            updateLeaderboard();
        }).catch(error => {
            console.error("Error submitting score to Firebase: ", error);
        });
    }

    async function updateLeaderboard() {
        if (!db || !collection) return;
        leaderboardEntries.className = 'loading';
        leaderboardEntries.innerHTML = '<div class="loading-spinner"></div>';
        const scoresCollection = collection(db, leaderboardCollectionName);
        const q = query(scoresCollection, orderBy("score", "desc"), limit(LEADERBOARD_SIZE));
        try {
            const querySnapshot = await getDocs(q);
            leaderboardEntries.className = '';
            leaderboardEntries.innerHTML = '';
            if (querySnapshot.empty) {
                leaderboardEntries.innerHTML = `<div style="text-align:center;padding:30px;color:#ffcc33;"><div style="font-size:38px;margin-bottom:12px;animation: bounce 2s infinite;">üèÜ</div><div>No scores yet!</div></div>`;
                return;
            }
            let rank = 1;
            querySnapshot.forEach(doc => {
                const s = doc.data();
                const entry = document.createElement('div');
                entry.className = 'score-entry';
                entry.setAttribute('data-rank', rank);
                const modeClass = s.mode === 'ultra-single' ? 'ultra-mode' : 'classic-mode';
                entry.innerHTML = `<span class="player-name">${s.name} <small class="${modeClass}">(${s.mode})</small></span><span class="player-score">${s.score}</span>`;
                leaderboardEntries.appendChild(entry);
                rank++;
            });
        } catch (error) {
            console.error("Error fetching leaderboard from Firebase: ", error);
            leaderboardEntries.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;"><div style="font-size:24px;margin-bottom:10px;">‚ö†Ô∏è</div><div>Error loading scores</div><div style="font-size:0.9em;opacity:0.7;margin-top:5px;">Please try again later</div></div>`;
        }
    }

    function endGame() {
        running = false;
        clearInterval(intervalId);
        mainMenu.style.display = 'flex';
        canvas.style.display = 'none';
        scoreArea.style.display = 'none';
        difficultyMeter.style.display = 'none';
        leaderboard.style.display = 'block';
        submitScore(playerName, score);
        updateLeaderboard();
    }

    // Show leaderboard on main menu
    mainMenu.style.display = 'flex';
    leaderboard.style.display = 'block';
    updateLeaderboard();
    </script>
    <script type="module">
    // --- Firebase Imports and setup for global use ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
        authDomain: "cusumano-website.firebaseapp.com",
        projectId: "cusumano-website",
        storageBucket: "cusumano-website.firebasestorage.app",
        messagingSenderId: "20051552210",
        appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"
    };
    const app = initializeApp(firebaseConfig);
    window.firebaseApp = app;
    window.firebaseFirestore = getFirestore(app);
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
    window.firebaseLimit = limit;
    window.firebaseGetDocs = getDocs;
    window.firebaseServerTimestamp = serverTimestamp;

    document.dispatchEvent(new Event('firebase-ready'));
    </script>
</body>
</html>
