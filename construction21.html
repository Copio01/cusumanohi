<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction 21</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlMGExMDYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUuMDUgNWEzIDMgMCAwIDEgNC41IDBIM15NMTUuMDUgNU0xOSA4LjVjMCAxLjUtLjUgMy41LTIgNC41di4wNUgxN2EyIDIgMCAwIDAgLTIgLTIgYSAyIDIgMCAwIDAgLTIgMkgxM3YtNkgxNlY4LjVNOSA2LjVWNE02IDcgTDUuNSAxNC41TWwwIDE1IDguOTkgMy04IGMxLjUgLTRoMmMwIDAuNSAwLjUgMSAwLjUgMnYxSDEwdjNjMCAxIDAgMi40IC0xIDN2XzIgYzAgMC41IDAuMiAwLjUgMC41IDAuNXMwLjUgLTAuMiAwLjUgLTAuNVYyMUg0LjA3bDEuOCAtMTQuMjUgYTEgMSAwIDAgMSAwLjE5IC0wLjA3IHoiLz48L3N2Zz4=" type="image/svg+xml">
    <!-- NOTE: For production, use a built Tailwind CSS file. See https://tailwindcss.com/docs/installation for instructions. -->
    <link href="css/tailwind.output.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(ellipse at 60% 40%, #ffd70033 0%, #23232b 100%), linear-gradient(135deg, #23232b 0%, #2d2d3a 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            color: #EAEAEA;
        }
        .animated-bg {
            position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden;
        }
        .bg-shape {
            position: absolute; border-radius: 50%; opacity: 0.18; filter: blur(18px); animation: floatBg 8s ease-in-out infinite alternate;
        }
        .bg-shape1 { width: 340px; height: 340px; background: #ffd700; left: 8vw; top: 10vh; animation-delay: 0s; }
        .bg-shape2 { width: 220px; height: 220px; background: #ff4e00; right: 10vw; top: 30vh; animation-delay: 2s; }
        .bg-shape3 { width: 180px; height: 180px; background: #00cfff; left: 30vw; bottom: 8vh; animation-delay: 4s; }
        @keyframes floatBg {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-25px) scale(1.05); }
        }
        #game-container {
            width: 100%; max-width: 800px; margin: 0 auto; padding: 20px;
        }
        .card-table {
            display: flex; flex-direction: column; gap: 30px; padding: 20px;
            background: linear-gradient(135deg, #05392d 0%, #083f2e 100%);
            border-radius: 15px;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.3), 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 6px solid #05392d;
        }
        .dealer-area, .player-area {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.15); padding: 20px; border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
        }
        .hand-label {
            color: white; font-size: 18px; margin-bottom: 12px; font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); background: rgba(255,215,0,0.15);
            padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .cards {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; min-height: 180px; align-items: center; padding: 10px;
        }
        .card {
            width: 120px; height: 170px; background: white; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card.hidden {
            transform: rotateY(180deg);
        }
        .card .card-face, .card .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 12px;
        }
        .card .card-face {
            display: flex; flex-direction: column; justify-content: space-between;
            box-sizing: border-box; padding: 10px; background: white;
            border: 1px solid #e0e0e0;
        }
        .card.red .card-face { color: #e63946; }
        .card.black .card-face { color: #1d3557; }
        .card .card-back {
            background: repeating-linear-gradient(135deg, #0a4d68, #0a4d68 10px, #088395 10px, #088395 20px);
            transform: rotateY(180deg); display: flex; align-items: center; justify-content: center;
        }
        .card .card-back::after { content: "üî®"; font-size: 50px; color: rgba(255, 255, 255, 0.85); text-shadow: 0 0 5px rgba(0, 0, 0, 0.3); }
        .card .corner { display: flex; flex-direction: column; align-items: center; font-weight: bold; line-height: 1; }
        .card .top-left { align-self: flex-start; }
        .card .bottom-right { align-self: flex-end; transform: rotate(180deg); }
        .card .value { font-size: 22px; }
        .card .suit { font-size: 24px; }
        .card .center-suit, .card .face-design { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .card .center-suit { font-size: 60px; }
        .card .face-design { font-size: 48px; }
        .card .face-K::after { content: 'üë∑‚Äç‚ôÇÔ∏è'; }
        .card .face-Q::after { content: 'üë∑‚Äç‚ôÄÔ∏è'; }
        .card .face-J::after { content: 'üèóÔ∏è'; }
        .card .face-A { font-size: 72px; }
        @keyframes dealCard {
            from { transform: translateY(-300px) translateX(400px) rotate(180deg) scale(0.3); opacity: 0; }
            to { transform: translateY(0) translateX(0) rotate(0deg) scale(1); opacity: 1; }
        }
        .card.dealing { animation: dealCard 0.5s cubic-bezier(0.215, 0.61, 0.355, 1) forwards; }
        .control-btn, .auth-btn, .primary-btn, .secondary-btn {
            padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: all 0.2s; border: none;
        }
        .control-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        .chip {
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px; color: white; margin: 5px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); position: relative; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.3); transition: transform 0.15s, box-shadow 0.15s;
        }
        .chip:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .chip-5 { background: linear-gradient(135deg, #f55 0%, #900 100%); }
        .chip-10 { background: linear-gradient(135deg, #55f 0%, #006 100%); }
        .chip-25 { background: linear-gradient(135deg, #5f5 0%, #060 100%); }
        .chip-100 { background: linear-gradient(135deg, #000 0%, #333 100%); }
        #game-result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(5px);
            z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1.5rem; opacity: 0; pointer-events: none; transition: opacity 0.4s;
            border-radius: 15px;
        }
        #game-result-screen.active { opacity: 1; pointer-events: all; }
        #leaderboard {
             background: rgba(17, 24, 39, 0.8);
             backdrop-filter: blur(5px);
             border: 1px solid rgba(255,255,255,0.1);
        }
        .auth-tab-content { display: none; }
        .auth-tab-content.active { display: block; }
        .auth-tab-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="animated-bg">
        <div class="bg-shape bg-shape1"></div>
        <div class="bg-shape bg-shape2"></div>
        <div class="bg-shape bg-shape3"></div>
    </div>
    <div id="game-container" class="p-4 mx-auto max-w-4xl">
        <h1 class="text-4xl font-bold text-center text-yellow-400 mb-4">üî® Construction 21 üî®</h1>
        <!-- Main Menu -->
        <div id="main-menu" class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
            <div id="auth-section">
                 <!-- Auth content will be injected by JS -->
            </div>
            <div id="user-profile" class="hidden">
                <h3 class="text-2xl mb-2">Welcome, <span id="profile-name" class="font-bold text-yellow-400"></span>!</h3>
                <div class="text-lg mb-4">Your Chips: <span id="profile-chips" class="font-bold"></span></div>
                <button id="play-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto">Play Game</button>
                <button id="logout-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white w-full sm:w-auto mt-2 sm:mt-0 sm:ml-2">Logout</button>
            </div>
        </div>
        <!-- Game Canvas -->
        <div id="game-canvas" class="hidden mt-4">
            <div class="card-table">
                <div class="dealer-area">
                    <div class="hand-label">Dealer's Hand: <span id="dealer-score">0</span></div>
                    <div id="dealer-cards" class="cards"></div>
                </div>
                <div class="player-area">
                    <div class="hand-label">Your Hand: <span id="player-score">0</span></div>
                    <div id="player-hands-display" class="cards"></div>
                </div>
                <div id="betting-controls" class="mt-4 space-y-2">
                    <h3 class="text-lg font-semibold">Place Your Bets</h3>
                    <div class="flex items-center space-x-2">
                        <label for="bet-amount" class="text-sm">Main Bet:</label>
                        <input type="number" id="bet-amount" value="10" min="1" class="p-1 border rounded w-20 text-black">
                        <span class="text-sm">Current: <span id="current-bet">0</span></span>
                    </div>
                    <!-- Side Bet Inputs -->
                    <div class="flex items-center space-x-2">
                        <label for="perfect-pairs-bet" class="text-sm">Perfect Pairs:</label>
                        <input type="number" id="perfect-pairs-bet" value="0" min="0" class="p-1 border rounded w-20 text-black">
                        <span class="text-sm">Current: <span id="current-pp-bet">0</span></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="twenty-one-plus-three-bet" class="text-sm">21+3:</label>
                        <input type="number" id="twenty-one-plus-three-bet" value="0" min="0" class="p-1 border rounded w-20 text-black">
                        <span class="text-sm">Current: <span id="current-21plus3-bet">0</span></span>
                    </div>
                    <button id="place-bet-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Place Bet</button>
                </div>
                <div id="game-area" class="hidden mt-4">
                    <h2 class="text-xl font-bold">Dealer's Hand</h2>
                    <div id="dealer-score" class="text-lg">Score: 0</div>
                    <div id="dealer-cards" class="flex space-x-2 mt-2 min-h-[100px]"></div>
                    <h2 class="text-xl font-bold mt-4">Your Hand(s)</h2>
                    <div id="side-bet-results" class="hidden my-2 p-2 border rounded bg-blue-100 text-blue-800"></div>
                    <div id="player-hands-display" class="mt-2 space-y-4"></div>
                    <div id="game-controls" class="mt-4 space-x-2 hidden">
                        <button id="hit-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Hit</button>
                        <button id="stand-btn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Stand</button>
                        <button id="split-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded hidden">Split</button>
                    </div>
                </div>
            </div>
            <!-- Result Screen -->
            <div id="game-result-screen">
                <h2 id="result-message" class="text-4xl font-bold text-yellow-400">You Win!</h2>
                <div class="text-2xl">Final Chips: <span id="final-chips" class="font-bold">0</span></div>
                <div>
                    <button id="play-again-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white">Play Again</button>
                    <button id="return-menu-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white ml-2">Main Menu</button>
                </div>
            </div>
        </div>
        <!-- Leaderboard -->
        <div id="leaderboard" class="mt-6 p-4 rounded-lg shadow-lg hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Top Players</h2>
            <ul id="leaderboard-entries" class="space-y-2"></ul>
        </div>
    </div>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, getDocs, limit, orderBy as firestoreOrderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- DOM Elements ---
        const mainMenu = document.getElementById('main-menu');
        const gameCanvas = document.getElementById('game-canvas');
        const authSection = document.getElementById('auth-section');
        const userProfile = document.getElementById('user-profile');
        const dealerCardsEl = document.getElementById('dealer-cards');
        const dealerScoreEl = document.getElementById('dealer-score');
        const bettingControls = document.getElementById('betting-controls');
        const gameControls = document.getElementById('game-controls');
        const gameResultScreen = document.getElementById('game-result-screen');
        const playerHandsDisplay = document.getElementById('player-hands-display');
        const sideBetResultsEl = document.getElementById('side-bet-results');
        const hitBtn = document.getElementById('hit-btn');
        const standBtn = document.getElementById('stand-btn');
        const doubleDownBtn = document.getElementById('double-down-btn');
        const splitButton = document.getElementById('split-btn');

        // --- Game State ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = null; 
        let currentPlayerName = "Guest";
        let deck = [];
        let dealerHand = {};
        let playerHands = [];
        let activeHandIndex = 0;
        let playerChips = 100; // Changed from 1000 to 100
        let currentBet = 0;
        let perfectPairsBetAmount = 0;
        let twentyOnePlusThreeBetAmount = 0;

        const suits = ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        // --- Side Bet Payouts ---
        const PERFECT_PAIRS_PAYOUTS = {
            perfect: 25, // Same rank, same suit
            colored: 12, // Same rank, same color
            mixed: 6,    // Same rank, different color
        };
        const TWENTY_ONE_PLUS_THREE_PAYOUTS = {
            suitedTrips: 100,
            straightFlush: 40,
            threeOfAKind: 30,
            straight: 10,
            flush: 5,
        };

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        // --- Firebase & Auth ---
        
        function initializeFirebase() {
            let firebaseConfig = {};
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    // Removed console.warn about config fallback for cleaner production logs
                    firebaseConfig = {
                        apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
                        authDomain: "cusumano-website.firebaseapp.com",
                        projectId: "cusumano-website",
                    };
                }
            } catch (e) {
                console.error("Could not initialize Firebase.", e);
                authSection.innerHTML = `<p class="text-red-500">Error: Firebase configuration is invalid.</p>`;
                return;
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await setupUserSession(user);
                } else {
                    currentUser = null;
                    showAuthForms();
                }
            });
        }

        async function setupUserSession(user) {
            const userData = await getUserDataFromFirestore(user.uid);
            if (!userData) { return; }
            currentUser = { uid: user.uid, displayName: userData.displayName, chips: userData.chips };
            currentPlayerName = currentUser.displayName;
            playerChips = currentUser.chips;
            showUserProfile();
        }

        async function getUserDataFromFirestore(userId) {
            const userDocRef = doc(db, "game_users_custom_auth", userId);
            const userDoc = await getDoc(userDocRef);
            return userDoc.exists() ? userDoc.data() : null;
        }
        
        function showAuthForms() {
            authSection.classList.remove('hidden');
            userProfile.classList.add('hidden');
            gameCanvas.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            authSection.innerHTML = `
                <div class="border-b border-gray-600 mb-4">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button data-tab="login" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Login</button>
                        <button data-tab="signup" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Sign Up</button>
                    </nav>
                </div>
                <div id="login-tab" class="auth-tab-content space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 p-2 rounded">
                    <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700 p-2 rounded">
                    <button id="login-btn" class="auth-btn bg-indigo-600 hover:bg-indigo-700 w-full">Login</button>
                    <p id="login-message" class="text-sm text-red-400 h-4"></p>
                </div>
                <div id="signup-tab" class="auth-tab-content space-y-4">
                    <input type="text" id="signup-name" placeholder="Display Name" class="w-full bg-gray-700 p-2 rounded">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full bg-gray-700 p-2 rounded">
                    <input type="password" id="signup-password" placeholder="Password (6+ characters)" class="w-full bg-gray-700 p-2 rounded">
                    <button id="signup-btn" class="auth-btn bg-indigo-600 hover:bg-indigo-700 w-full">Create Account</button>
                    <p id="signup-message" class="text-sm text-red-400 h-4"></p>
                </div>`;
            const tabs = authSection.querySelectorAll('.auth-tab-btn');
            const contents = authSection.querySelectorAll('.auth-tab-content');
            tabs[0].classList.add('active');
            contents[0].classList.add('active');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const messageEl = document.getElementById('login-message');
            messageEl.textContent = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                messageEl.textContent = error.message;
            }
        }
        
        async function handleSignUp() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const messageEl = document.getElementById('signup-message');
            if (!name) { messageEl.textContent = "Display name is required."; return; }
            messageEl.textContent = 'Creating account...';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "game_users_custom_auth", user.uid), {
                    displayName: name,
                    chips: 100 // Changed from 1000 to 100
                });
                messageEl.textContent = 'Success! Logging in...';
            } catch (error) {
                 messageEl.textContent = error.message;
            }
        }

        function showUserProfile() {
            mainMenu.classList.remove('hidden');
            authSection.classList.add('hidden');
            userProfile.classList.remove('hidden');
            document.getElementById('profile-name').textContent = currentPlayerName;
            updateChipDisplay();
        }

        async function handleLogout() {
            await signOut(auth);
        }
        
        // --- Game Logic (Core) ---
        function resetGameState() { /* Unchanged */ }
        async function startNewHand() { /* Unchanged */ }
        function createDeck() { /* Unchanged */ }
        function calculateScore(cards) { /* Unchanged */ }
        function updateScoresAndUI() { /* Unchanged */ }
        function createPlayerHandDisplay(hand, index) { /* Unchanged */ }
        async function dealCard(hand, cardsContainer, isHidden = false) { /* Unchanged */ }
        async function dealCardToPlayer(hand) { /* Unchanged */ }
        async function dealCardToDealer(isFaceUp) { /* Unchanged */ }
        async function hit() { /* Unchanged */ }
        async function stand() { /* Unchanged */ }
        async function doubleDown() { /* Unchanged */ }
        async function handleSplit() { /* Unchanged */ }
        async function advanceToNextHandOrDealer() { /* Unchanged */ }
        async function dealerTurn() { /* Unchanged */ }
        async function endHand() { /* Unchanged */ }
        
        // --- Side Bet Logic (Fully Implemented) ---
        function evaluateSideBets() {
            let sideBetWinnings = 0;
            let resultsHTML = '';
            const playerCard1 = playerHands[0].cards[0];
            const playerCard2 = playerHands[0].cards[1];
            const dealerUpCard = dealerHand.cards.find(card => card); // First dealer card

            // 1. Perfect Pairs Evaluation
            if (perfectPairsBetAmount > 0) {
                let pairResult = checkPerfectPairs(playerCard1, playerCard2);
                if (pairResult.payout > 0) {
                    const winnings = perfectPairsBetAmount * pairResult.payout;
                    sideBetWinnings += winnings + perfectPairsBetAmount;
                    resultsHTML += `<p>Perfect Pairs: You hit a ${pairResult.type}! Win ${winnings}.</p>`;
                } else {
                    resultsHTML += `<p>Perfect Pairs: No pair. Lost bet.</p>`;
                }
            }
            
            // 2. 21+3 Evaluation
            if (twentyOnePlusThreeBetAmount > 0 && dealerUpCard) {
                const threeCards = [playerCard1, playerCard2, dealerUpCard];
                let pokerResult = check21Plus3(threeCards);
                if (pokerResult.payout > 0) {
                    const winnings = twentyOnePlusThreeBetAmount * pokerResult.payout;
                    sideBetWinnings += winnings + twentyOnePlusThreeBetAmount;
                    resultsHTML += `<p>21+3: You hit a ${pokerResult.type}! Win ${winnings}.</p>`;
                } else {
                    resultsHTML += `<p>21+3: No winning hand. Lost bet.</p>`;
                }
            }
            
            if (resultsHTML) {
                playerChips += sideBetWinnings;
                updateChipDisplay();
                sideBetResultsEl.innerHTML = resultsHTML;
                sideBetResultsEl.classList.remove('hidden');
            }
        }

        function checkPerfectPairs(card1, card2) {
            if (card1.value !== card2.value) return { type: 'None', payout: 0 };

            const isRed = (suit) => ['‚ô•', '‚ô¶'].includes(suit);
            if (card1.suit === card2.suit) {
                return { type: 'Perfect Pair', payout: PERFECT_PAIRS_PAYOUTS.perfect };
            } else if (isRed(card1.suit) === isRed(card2.suit)) {
                return { type: 'Colored Pair', payout: PERFECT_PAIRS_PAYOUTS.colored };
            } else {
                return { type: 'Mixed Pair', payout: PERFECT_PAIRS_PAYOUTS.mixed };
            }
        }

        function check21Plus3(cards) {
            const cardToRank = (card) => {
                if (['J', 'Q', 'K'].includes(card.value)) return 10;
                if (card.value === 'A') return 11; // Can be 1 for straight check
                return parseInt(card.value);
            };
            const ranks = cards.map(cardToRank).sort((a, b) => a - b);
            const suits = cards.map(c => c.suit);

            const isFlush = suits.every(s => s === suits[0]);
            const isStraight = (ranks[1] === ranks[0] + 1 && ranks[2] === ranks[1] + 1) ||
                              // Ace-low straight check (A, 2, 3)
                              (ranks[0] === 2 && ranks[1] === 3 && ranks.includes(11));
            
            const isThreeOfAKind = ranks[0] === ranks[1] && ranks[1] === ranks[2];
            if (isFlush && isStraight) return { type: 'Straight Flush', payout: TWENTY_ONE_PLUS_THREE_PAYOUTS.straightFlush };
            if (isThreeOfAKind) return { type: 'Three of a Kind', payout: TWENTY_ONE_PLUS_THREE_PAYOUTS.threeOfAKind };
            if (isStraight) return { type: 'Straight', payout: TWENTY_ONE_PLUS_THREE_PAYOUTS.straight };
            if (isFlush) return { type: 'Flush', payout: TWENTY_ONE_PLUS_THREE_PAYOUTS.flush };

            return { type: 'None', payout: 0 };
                    }
        
        // --- UI & Event Listeners ---
        function setupEventListeners() { /* Unchanged */ }
        function placeBet() { /* Unchanged */ }
        function updateChipDisplay() { /* Unchanged */ }
        function toggleControls(show, mode) { /* Unchanged */ }
        function setActiveHand(index) { /* Unchanged */ }
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

    </script>
</body>
</html>
