<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction 21</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlMGExMDYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUuMDUgNWEzIDMgMCAwIDEgNC41IDBIM15NMTUuMDUgNU0xOSA4LjVjMCAxLjUtLjUgMy41LTIgNC41di4wNUgxN2EyIDIgMCAwIDAgLTIgLTIgYSAyIDIgMCAwIDAgLTIgMkgxM3YtNkgxNlY4LjVNOSA2LjVWNE02IDcgTDUuNSAxNC41TWwwIDE1IDguOTkgMy04IGMxLjUgLTRoMmMwIDAuNSAwLjUgMSAwLjUgMnYxSDEwdjNjMCAxIDAgMi40IC0xIDN2XzIgYzAgMC41IDAuMiAwLjUgMC41IDAuNXMwLjUgLTAuMiAwLjUgLTAuNVYyMUg0LjA3bDEuOCAtMTQuMjUgYTEgMSAwIDAgMSAwLjE5IC0wLjA3IHoiLz48L3N2Zz4=" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(ellipse at 60% 40%, #ffd70033 0%, #23232b 100%), linear-gradient(135deg, #23232b 0%, #2d2d3a 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            color: #EAEAEA;
        }
        .animated-bg {
            position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden;
        }
        .bg-shape {
            position: absolute; border-radius: 50%; opacity: 0.18; filter: blur(18px); animation: floatBg 8s ease-in-out infinite alternate;
        }
        .bg-shape1 { width: 340px; height: 340px; background: #ffd700; left: 8vw; top: 10vh; animation-delay: 0s; }
        .bg-shape2 { width: 220px; height: 220px; background: #ff4e00; right: 10vw; top: 30vh; animation-delay: 2s; }
        .bg-shape3 { width: 180px; height: 180px; background: #00cfff; left: 30vw; bottom: 8vh; animation-delay: 4s; }
        @keyframes floatBg {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-25px) scale(1.05); }
        }
        #game-container {
            width: 100%; max-width: 800px; margin: 0 auto; padding: 20px;
        }
        .card-table {
            display: flex; flex-direction: column; gap: 30px; padding: 20px;
            background: linear-gradient(135deg, #05392d 0%, #083f2e 100%);
            border-radius: 15px;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.3), 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 6px solid #05392d;
        }
        .dealer-area, .player-area {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.15); padding: 20px; border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
        }
        .hand-label {
            color: white; font-size: 18px; margin-bottom: 12px; font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); background: rgba(255,215,0,0.15);
            padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .cards {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; min-height: 180px; align-items: center; padding: 10px;
        }
        .card {
            width: 120px; height: 170px; background: white; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card.hidden {
            transform: rotateY(180deg);
        }
        .card .card-face, .card .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 12px;
        }
        .card .card-face {
            display: flex; flex-direction: column; justify-content: space-between;
            box-sizing: border-box; padding: 10px; background: white;
            border: 1px solid #e0e0e0;
        }
        .card.red .card-face { color: #e63946; }
        .card.black .card-face { color: #1d3557; }
        .card .card-back {
            background: repeating-linear-gradient(135deg, #0a4d68, #0a4d68 10px, #088395 10px, #088395 20px);
            transform: rotateY(180deg); display: flex; align-items: center; justify-content: center;
        }
        .card .card-back::after { content: "üî®"; font-size: 50px; color: rgba(255, 255, 255, 0.85); text-shadow: 0 0 5px rgba(0, 0, 0, 0.3); }
        .card .corner { display: flex; flex-direction: column; align-items: center; font-weight: bold; line-height: 1; }
        .card .top-left { align-self: flex-start; }
        .card .bottom-right { align-self: flex-end; transform: rotate(180deg); }
        .card .value { font-size: 22px; }
        .card .suit { font-size: 24px; }
        .card .center-suit, .card .face-design { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .card .center-suit { font-size: 60px; }
        .card .face-design { font-size: 48px; }
        .card .face-K::after { content: 'üë∑‚Äç‚ôÇÔ∏è'; }
        .card .face-Q::after { content: 'üë∑‚Äç‚ôÄÔ∏è'; }
        .card .face-J::after { content: 'üèóÔ∏è'; }
        .card .face-A { font-size: 72px; }
        @keyframes dealCard {
            from { transform: translateY(-300px) translateX(400px) rotate(180deg) scale(0.3); opacity: 0; }
            to { transform: translateY(0) translateX(0) rotate(0deg) scale(1); opacity: 1; }
        }
        .card.dealing { animation: dealCard 0.5s cubic-bezier(0.215, 0.61, 0.355, 1) forwards; }
        .control-btn, .auth-btn, .primary-btn, .secondary-btn {
            padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: all 0.2s; border: none;
        }
        .control-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        .chip {
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px; color: white; margin: 5px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); position: relative; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.3); transition: transform 0.15s, box-shadow 0.15s;
        }
        .chip:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .chip-5 { background: linear-gradient(135deg, #f55 0%, #900 100%); }
        .chip-10 { background: linear-gradient(135deg, #55f 0%, #006 100%); }
        .chip-25 { background: linear-gradient(135deg, #5f5 0%, #060 100%); }
        .chip-100 { background: linear-gradient(135deg, #000 0%, #333 100%); }
        #game-result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(5px);
            z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1.5rem; opacity: 0; pointer-events: none; transition: opacity 0.4s;
            border-radius: 15px;
        }
        #game-result-screen.active { opacity: 1; pointer-events: all; }
        #leaderboard {
             background: rgba(17, 24, 39, 0.8);
             backdrop-filter: blur(5px);
             border: 1px solid rgba(255,255,255,0.1);
        }
        .auth-tab-content { display: none; }
        .auth-tab-content.active { display: block; }
        .auth-tab-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="animated-bg">
        <div class="bg-shape bg-shape1"></div>
        <div class="bg-shape bg-shape2"></div>
        <div class="bg-shape bg-shape3"></div>
    </div>

    <div id="game-container" class="p-4 mx-auto max-w-4xl">
        <h1 class="text-4xl font-bold text-center text-yellow-400 mb-4">üî® Construction 21 üî®</h1>

        <!-- Main Menu -->
        <div id="main-menu" class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
            <div id="auth-section">
                 <!-- Auth content will be injected by JS -->
            </div>
            <div id="user-profile" class="hidden">
                <h3 class="text-2xl mb-2">Welcome, <span id="profile-name" class="font-bold text-yellow-400"></span>!</h3>
                <div class="text-lg mb-4">Your Chips: <span id="profile-chips" class="font-bold"></span></div>
                <button id="play-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto">Play Game</button>
                <button id="logout-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white w-full sm:w-auto mt-2 sm:mt-0 sm:ml-2">Logout</button>
            </div>
        </div>

        <!-- Game Canvas -->
        <div id="game-canvas" class="hidden mt-4">
            <div class="card-table">
                <div class="dealer-area">
                    <div class="hand-label">Dealer's Hand: <span id="dealer-score">0</span></div>
                    <div id="dealer-cards" class="cards"></div>
                </div>
                
                <div class="player-area">
                    <div class="hand-label">Your Hand: <span id="player-score">0</span></div>
                    <div id="player-cards" class="cards"></div>
                </div>
                
                <div id="betting-controls" class="bet-area text-center p-4 bg-black/20 rounded-lg">
                     <div class="hand-label">Your Chips: <span id="player-chips">100</span></div>
                     <div class="hand-label">Current Bet: <span id="current-bet">0</span></div>
                     <div class="chips flex justify-center my-2" id="betting-chips">
                         <div class="chip chip-5" data-value="5">5</div>
                         <div class="chip chip-10" data-value="10">10</div>
                         <div class="chip chip-25" data-value="25">25</div>
                         <div class="chip chip-100" data-value="100">100</div>
                     </div>
                     <button id="place-bet-btn" class="control-btn bg-yellow-500 hover:bg-yellow-600 text-black">Place Bet</button>
                     <button id="clear-bet-btn" class="control-btn bg-gray-500 hover:bg-gray-600 text-white ml-2">Clear Bet</button>
                </div>

                <div id="game-controls" class="controls flex justify-center p-4 hidden">
                    <button id="hit-btn" class="control-btn bg-green-500 hover:bg-green-600 text-white">Hit</button>
                    <button id="stand-btn" class="control-btn bg-red-500 hover:bg-red-600 text-white ml-2">Stand</button>
                    <button id="double-btn" class="control-btn bg-purple-500 hover:bg-purple-600 text-white ml-2">Double Down</button>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="game-result-screen">
                <h2 id="result-message" class="text-4xl font-bold text-yellow-400">You Win!</h2>
                <div class="text-2xl">Final Chips: <span id="final-chips" class="font-bold">0</span></div>
                <div>
                    <button id="play-again-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white">Play Again</button>
                    <button id="return-menu-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white ml-2">Main Menu</button>
                </div>
            </div>
        </div>
        
        <!-- Leaderboard -->
        <div id="leaderboard" class="mt-6 p-4 rounded-lg shadow-lg hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Top Players</h2>
            <ul id="leaderboard-entries" class="space-y-2">
                <!-- Entries populated by JS -->
            </ul>
        </div>
    </div>

    <script type="module">
        // Firebase Imports - Using latest modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, getDocs, limit, orderBy as firestoreOrderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- DOM Elements ---
        const mainMenu = document.getElementById('main-menu');
        const gameCanvas = document.getElementById('game-canvas');
        const leaderboardDiv = document.getElementById('leaderboard');
        const authSection = document.getElementById('auth-section');
        const userProfile = document.getElementById('user-profile');
        const dealerCardsEl = document.getElementById('dealer-cards');
        const playerCardsEl = document.getElementById('player-cards');
        const dealerScoreEl = document.getElementById('dealer-score');
        const playerScoreEl = document.getElementById('player-score');
        const bettingControls = document.getElementById('betting-controls');
        const gameControls = document.getElementById('game-controls');
        const gameResultScreen = document.getElementById('game-result-screen');

        // --- Game State ---
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = null;
        let currentPlayerName = "Guest";
        let deck = [];
        let dealerHand = [];
        let playerHand = [];
        let playerChips = 100;
        let currentBet = 0;
        const suits = ['‚ô•', '‚ô¶', '‚ô†', '‚ô£'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        // --- Helper Functions ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Firebase Initialization and Auth ---
        function initializeFirebase() {
            // Use __firebase_config global variable provided by the environment
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user && !user.isAnonymous) {
                    currentUser = user;
                    const userData = await getUserData(user.uid);
                    currentPlayerName = userData.displayName || "Player";
                    playerChips = userData.chips;
                    showUserProfile();
                } else {
                    currentUser = null;
                    currentPlayerName = "Guest";
                    playerChips = 100;
                    showAuthForms();
                }
            });

            // Sign in using the provided token or anonymously
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(err => {
                    console.error("Custom token sign-in failed, trying anonymous:", err);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
        }

        async function getUserData(userId) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'profile');
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                return userDoc.data();
            } else {
                // For new users, create a document
                const newUser = {
                    displayName: auth.currentUser.displayName || auth.currentUser.email?.split('@')[0] || "New Player",
                    email: auth.currentUser.email,
                    chips: 100,
                };
                await setDoc(userDocRef, newUser);
                return newUser;
            }
        }

        function showUserProfile() {
            authSection.innerHTML = ''; // Clear auth forms
            authSection.classList.add('hidden');
            userProfile.classList.remove('hidden');
            document.getElementById('profile-name').textContent = currentPlayerName;
            document.getElementById('profile-chips').textContent = playerChips;
        }

        /**
         * CORRECTION: This function now dynamically injects a complete, functional
         * authentication UI with tabs for Login, Sign Up, and Guest play.
         */
        function showAuthForms() {
            userProfile.classList.add('hidden');
            authSection.classList.remove('hidden');
            
            authSection.innerHTML = `
                <div class="border-b border-gray-600 mb-4">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button data-tab="login" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400">Login</button>
                        <button data-tab="signup" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Sign Up</button>
                        <button data-tab="guest" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Play as Guest</button>
                    </nav>
                </div>

                <!-- Login Form -->
                <div id="login-tab" class="auth-tab-content active text-left">
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-300">Email</label>
                            <input type="email" id="login-email" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="login-password" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <button id="login-btn" class="w-full auth-btn bg-indigo-600 hover:bg-indigo-700 text-white">Login</button>
                        <p id="login-message" class="text-sm text-red-400 h-4"></p>
                    </div>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-tab" class="auth-tab-content text-left">
                    <div class="space-y-4">
                         <div>
                            <label for="signup-name" class="block text-sm font-medium text-gray-300">Display Name</label>
                            <input type="text" id="signup-name" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Player123">
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-gray-300">Email</label>
                            <input type="email" id="signup-email" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="signup-password" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="6+ characters">
                        </div>
                        <button id="signup-btn" class="w-full auth-btn bg-indigo-600 hover:bg-indigo-700 text-white">Create Account</button>
                         <p id="signup-message" class="text-sm text-red-400 h-4"></p>
                    </div>
                </div>
                
                <!-- Guest Form -->
                 <div id="guest-tab" class="auth-tab-content text-left">
                     <p class="text-gray-400 mb-4">Play without an account. Your score will not be saved to the leaderboard.</p>
                     <button id="guest-play-btn" class="w-full auth-btn bg-green-600 hover:bg-green-700 text-white">Play as Guest</button>
                </div>
            `;
            
            // Add event listeners for the new auth UI
            const tabs = authSection.querySelectorAll('.auth-tab-btn');
            const contents = authSection.querySelectorAll('.auth-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => {
                        item.classList.remove('border-indigo-500', 'text-indigo-400');
                        item.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                    });
                    tab.classList.add('border-indigo-500', 'text-indigo-400');
                    tab.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                    
                    contents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            document.getElementById('login-btn').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const messageEl = document.getElementById('login-message');
                try {
                    messageEl.textContent = 'Logging in...';
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle the UI switch
                } catch (error) {
                    messageEl.textContent = error.message;
                }
            });

            document.getElementById('signup-btn').addEventListener('click', async () => {
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const messageEl = document.getElementById('signup-message');
                 if (!name || !email || !password) {
                    messageEl.textContent = "Please fill out all fields.";
                    return;
                }
                try {
                    messageEl.textContent = 'Creating account...';
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Explicitly create user data right after signup
                    currentPlayerName = name;
                    await updateUserData(100, userCredential.user.uid);

                    // onAuthStateChanged will handle the UI switch
                } catch (error) {
                    messageEl.textContent = error.message;
                }
            });
            
             document.getElementById('guest-play-btn').onclick = () => {
                currentPlayerName = "Guest";
                playerChips = 100;
                showUserProfile();
            };
        }


        // --- Game Logic ---
        
        function createCardElement(card, isHidden = false) {
            const cardEl = document.createElement('div');
            const isRed = ['‚ô•', '‚ô¶'].includes(card.suit);
            cardEl.className = `card ${isRed ? 'red' : 'black'} ${isHidden ? 'hidden' : ''}`;

            const valueDisplay = ['K', 'Q', 'J', 'A'].includes(card.value) ? card.value : card.suit;
            const faceContent = `
                <div class="corner top-left"><div class="value">${card.value}</div><div class="suit">${card.suit}</div></div>
                <div class="center-suit face-${card.value}">${card.value === 'A' ? card.suit : ''}</div>
                <div class="corner bottom-right"><div class="value">${card.value}</div><div class="suit">${card.suit}</div></div>
            `;

            cardEl.innerHTML = `
                <div class="card-back"></div>
                <div class="card-face">${faceContent}</div>
            `;
            if(['K', 'Q', 'J'].includes(card.value)){
                 cardEl.querySelector('.center-suit').classList.add('face-design');
            }
            
            return cardEl;
        }

        function createDeck() {
            deck = [];
            for (const suit of suits) {
                for (const value of values) {
                    deck.push({ suit, value });
                }
            }
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            for (const card of hand) {
                if (card.value === 'A') {
                    aces++;
                    score += 11;
                } else if (['K', 'Q', 'J'].includes(card.value)) {
                    score += 10;
                } else {
                    score += parseInt(card.value);
                }
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }
        
        function updateScoresAndUI() {
            playerScoreEl.textContent = calculateScore(playerHand);
            // Dealer's score only shows the face-up card initially
            const isDealerSecondCardHidden = dealerCardsEl.children[1]?.classList.contains('hidden');
            dealerScoreEl.textContent = isDealerSecondCardHidden ? calculateScore([dealerHand[0]]) : calculateScore(dealerHand);
            
            document.getElementById('player-chips').textContent = playerChips;
            document.getElementById('current-bet').textContent = currentBet;
        }
        
        async function startNewHand() {
            toggleControls(false); // Show betting controls
            if (currentBet === 0) {
                alert("Please place a bet first.");
                return;
            }

            dealerHand = [];
            playerHand = [];
            dealerCardsEl.innerHTML = '';
            playerCardsEl.innerHTML = '';
            createDeck();

            // Deal cards sequentially with a delay
            playerHand.push(deck.pop());
            playerCardsEl.appendChild(createCardElement(playerHand[0])).classList.add('dealing');
            await sleep(300);

            dealerHand.push(deck.pop());
            dealerCardsEl.appendChild(createCardElement(dealerHand[0])).classList.add('dealing');
            await sleep(300);

            playerHand.push(deck.pop());
            playerCardsEl.appendChild(createCardElement(playerHand[1])).classList.add('dealing');
            await sleep(300);
            
            dealerHand.push(deck.pop());
            dealerCardsEl.appendChild(createCardElement(dealerHand[1], true)).classList.add('dealing'); // Hidden card
            await sleep(300);
            
            updateScoresAndUI();
            toggleControls(true); // Show game controls

            const playerScore = calculateScore(playerHand);
            if (playerScore === 21) {
                // Blackjack!
                await sleep(500);
                endHand();
            }
        }
        
        async function dealerTurn() {
            toggleControls(false, true); // Disable all controls during dealer's turn
            
            const hiddenCardEl = dealerCardsEl.children[1];
            if (hiddenCardEl) {
                hiddenCardEl.classList.remove('hidden');
            }
            await sleep(600); // Wait for flip animation
            
            let dealerScore = calculateScore(dealerHand);
            dealerScoreEl.textContent = dealerScore;
            
            while(dealerScore < 17) {
                await sleep(800);
                dealerHand.push(deck.pop());
                dealerCardsEl.appendChild(createCardElement(dealerHand[dealerHand.length-1])).classList.add('dealing');
                dealerScore = calculateScore(dealerHand);
                dealerScoreEl.textContent = dealerScore;
            }
            
            endHand();
        }
        
        async function endHand() {
            toggleControls(false, true);
            const playerScore = calculateScore(playerHand);
            const dealerScore = calculateScore(dealerHand);
            let resultMessage = "";
            let winnings = 0;

            if (playerScore === 21 && playerHand.length === 2) {
                resultMessage = "Blackjack! You win!";
                winnings = Math.floor(currentBet * 2.5);
            } else if (playerScore > 21) {
                resultMessage = "Bust! You lose.";
            } else if (dealerScore > 21) {
                resultMessage = "Dealer busts! You win!";
                winnings = currentBet * 2;
            } else if (dealerScore > playerScore) {
                resultMessage = "Dealer wins.";
            } else if (playerScore > dealerScore) {
                resultMessage = "You win!";
                winnings = currentBet * 2;
            } else {
                resultMessage = "Push! It's a tie.";
                winnings = currentBet;
            }

            playerChips += winnings;
            document.getElementById('result-message').textContent = resultMessage;
            document.getElementById('final-chips').textContent = playerChips;
            gameResultScreen.classList.add('active');
            
            // Save data to Firestore for non-guest users
            if (currentUser) {
                await updateUserData(playerChips, currentUser.uid);
            }
            await fetchLeaderboard();
        }

        async function updateUserData(chips, uid) {
            if (!uid) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/data`, 'profile');
            // Use set with merge to create or update
            await setDoc(userDocRef, { chips, displayName: currentPlayerName }, { merge: true });
             // Leaderboard update
            const scoreDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, uid);
            await setDoc(scoreDocRef, {
                name: currentPlayerName,
                score: chips
            });
        }
        
        async function fetchLeaderboard() {
            const q = query(collection(db, `artifacts/${appId}/public/data/leaderboard`), firestoreOrderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const entries = [];
            querySnapshot.forEach((doc) => {
                entries.push({ id: doc.id, ...doc.data() });
            });
            
            const leaderboardEntriesEl = document.getElementById('leaderboard-entries');
            leaderboardEntriesEl.innerHTML = '';
            entries.forEach((entry, index) => {
                 const li = document.createElement('li');
                 li.className = `flex justify-between items-center p-2 rounded ${entry.id === currentUser?.uid ? 'bg-yellow-500/20' : 'bg-gray-700/50'}`;
                 li.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold text-lg w-8">${index + 1}.</span>
                        <span>${entry.name}</span>
                    </div>
                    <span class="font-bold text-yellow-400">${entry.score} Chips</span>
                 `;
                 leaderboardEntriesEl.appendChild(li);
            });
        }

        function toggleControls(showGame, disableAll = false) {
             bettingControls.classList.toggle('hidden', showGame || disableAll);
             gameControls.classList.toggle('hidden', !showGame || disableAll);
        }
        
        function resetForNewRound() {
            gameResultScreen.classList.remove('active');
            currentBet = 0;
            updateScoresAndUI();
            toggleControls(false); // Show betting controls
        }
        
        function returnToMainMenu() {
            gameResultScreen.classList.remove('active');
            gameCanvas.classList.add('hidden');
            leaderboardDiv.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            if(currentUser) {
                showUserProfile();
            } else {
                showAuthForms();
            }
        }

        // --- Event Listeners ---
        document.getElementById('play-btn').addEventListener('click', () => {
             mainMenu.classList.add('hidden');
             gameCanvas.classList.remove('hidden');
             leaderboardDiv.classList.remove('hidden');
             resetForNewRound();
             fetchLeaderboard();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
             signOut(auth);
        });
        
        document.getElementById('betting-chips').addEventListener('click', (e) => {
            const chip = e.target.closest('.chip');
            if(chip) {
                const value = parseInt(chip.dataset.value);
                if (playerChips >= value) {
                    playerChips -= value;
                    currentBet += value;
                    updateScoresAndUI();
                }
            }
        });

        document.getElementById('place-bet-btn').addEventListener('click', startNewHand);
        
        document.getElementById('clear-bet-btn').addEventListener('click', () => {
            playerChips += currentBet;
            currentBet = 0;
            updateScoresAndUI();
        });

        document.getElementById('hit-btn').addEventListener('click', async () => {
            playerHand.push(deck.pop());
            playerCardsEl.appendChild(createCardElement(playerHand[playerHand.length-1])).classList.add('dealing');
            updateScoresAndUI();
            if (calculateScore(playerHand) > 21) {
                await sleep(500);
                endHand();
            }
        });
        
        document.getElementById('stand-btn').addEventListener('click', dealerTurn);
        
        document.getElementById('double-btn').addEventListener('click', async () => {
            if (playerChips >= currentBet) {
                playerChips -= currentBet;
                currentBet *= 2;
                playerHand.push(deck.pop());
                playerCardsEl.appendChild(createCardElement(playerHand[playerHand.length - 1])).classList.add('dealing');
                updateScoresAndUI();

                if (calculateScore(playerHand) > 21) {
                    await sleep(500);
                    endHand();
                } else {
                    await sleep(800);
                    dealerTurn();
                }
            }
        });

        document.getElementById('play-again-btn').addEventListener('click', resetForNewRound);
        document.getElementById('return-menu-btn').addEventListener('click', returnToMainMenu);
        
        // --- Initial Load ---
        initializeFirebase();

    </script>
</body>
</html>
