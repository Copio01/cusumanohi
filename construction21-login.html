<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction 21 ‚Äî Login</title>
  <link rel="icon" href="https://cusumanohi.com/wp-content/uploads/2022/04/cropped-CusumanoH-Ico-1-32x32.png">
  <link href="css/tailwind.output.css" rel="stylesheet">
  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #23232b 0%, #2d2d3a 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #F8F8E6;
      display: flex; align-items: center; justify-content: center;
      overflow-x: hidden;
    }
    .login-bg-animation { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
    .bg-shape { position: absolute; border-radius: 50%; opacity: 0.12; filter: blur(22px); animation: floatBg 10s ease-in-out infinite alternate; }
    .bg-shape1 { width: 360px; height: 360px; background: #ffd700; left: 3vw; top: 12vh; animation-delay: 0s; }
    .bg-shape2 { width: 230px; height: 230px; background: #ff4e00; right: 8vw; top: 34vh; animation-delay: 1.5s; }
    .bg-shape3 { width: 140px; height: 140px; background: #202020; left: 43vw; bottom: 6vh; animation-delay: 3.5s; }
    @keyframes floatBg { 0% { transform: translateY(0) scale(1);} 100% { transform: translateY(-32px) scale(1.06);} }

    .login-container {
      background: rgba(36,36,36,0.97);
      backdrop-filter: blur(13px);
      border-radius: 19px;
      padding: 2.2rem 1.15rem 1.55rem 1.15rem;
      box-shadow: 0 6px 34px #000c, 0 0 0 2px #ffd70020;
      border: 2.2px solid #ffd70033;
      width: 100%; max-width: 370px; margin: 2vw; text-align: center; position: relative;
    }
    .barrier-tape {
      position: absolute; top: -18px; left: -22px; right: -22px; height: 24px; z-index: 2;
      background: repeating-linear-gradient(
        120deg,
        #23232b 0 16px,
        #ffd700 16px 32px
      );
      border-radius: 11px 11px 0 0;
      box-shadow: 0 3px 18px #0002;
      opacity: 0.97;
      border-bottom: 2.5px solid #000;
      pointer-events: none;
    }
    .game-title {
      font-size: 2rem; font-weight: 900; color: #ffd700;
      text-shadow: 0 0 11px #ffd70069, 0 2px 4px #23232b44;
      margin: 0.4rem 0 0.7rem 0; letter-spacing: -1.3px;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .game-title .helmet {
      font-size: 1.24em;
      filter: drop-shadow(0 2px 2px #0004);
    }
    .auth-tabs { display: flex; margin-bottom: 1.12rem; background: #22263a33; border-radius: 10px; padding: 3px; }
    .auth-tab-btn {
      flex: 1; padding: 10px 0; background: transparent; color: #bdbdbd;
      border: none; border-radius: 8px; font-weight: 700; font-size: 1.06rem; cursor: pointer;
      transition: all 0.22s;
    }
    .auth-tab-btn.active {
      background: #ffd700; color: #23232b; box-shadow: 0 3px 10px #ffd70013;
    }
    .auth-tab-content { display: none; }
    .auth-tab-content.active { display: block; }
    .form-group { margin-bottom: 1.04rem; text-align: left; }
    .form-label { color: #f9efcf; font-size: 1.01rem; font-weight: 600; margin-bottom: 0.22rem; display: block; }
    .form-input-wrap { position: relative; }
    .form-input {
      width: 100%; padding: 11px 38px 11px 12px; background: #282b36cc;
      border: 2px solid #46485e77; border-radius: 9px; color: #fff;
      font-size: 1rem; transition: border 0.15s, box-shadow 0.19s; box-sizing: border-box;
    }
    .form-input:focus {
      outline: none; border-color: #ffd700;
      background: #232440fa; box-shadow: 0 0 0 3px #ffd70018;
    }
    .form-input::placeholder { color: #b7bbbe; }
    .show-pass-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: #ffd700cc; font-size: 1.14em;
      cursor: pointer; padding: 2px 6px; border-radius: 5px; transition: background 0.18s;
    }
    .show-pass-btn:focus, .show-pass-btn:hover { background: #ffd70022; }
    .auth-btn {
      width: 100%; padding: 13px 0; margin-top: 3px;
      background: linear-gradient(90deg, #ffd700 80%, #ffb700 100%);
      color: #23232b; border: none; border-radius: 10px; font-weight: 800;
      font-size: 1.07rem; cursor: pointer; transition: all 0.17s; margin-bottom: 0.6rem;
      box-shadow: 0 2px 10px #ffd70013;
    }
    .auth-btn:hover, .auth-btn:focus {
      background: linear-gradient(90deg,#ffe066,#ffd700);
      box-shadow: 0 6px 19px #ffd70024, 0 0 0 2px #ffd70030;
      transform: scale(1.017);
    }
    .auth-btn:disabled { opacity: 0.65; cursor: not-allowed; }
    .forgot-link {
      display: inline-block; font-size: .96em; color: #ffe48b;
      margin: -4px 0 10px 2px; text-decoration: underline dotted; cursor: pointer;
      transition: color 0.16s;
    }
    .forgot-link:hover, .forgot-link:focus { color: #ffd700; }
    .message { min-height: 1.3rem; font-size: 0.98rem; font-weight: 500; margin-top: 0.13rem; text-align: left; }
    .message.error { color: #ff5959; }
    .message.success { color: #22e99a; }
    .message.info { color: #38b6ff; }
    .construction-icons { position: absolute; top: 21px; right: 14px; font-size: 1.1rem; opacity: 0.14; pointer-events: none; }
    .back-to-home {
      position: absolute; top: 5px; left: 7px; color: #ffd700; text-decoration: none;
      font-weight: 700; font-size: .96rem; padding: 6px 13px;
      border-radius: 6px; background: #23232b53; box-shadow: 0 1px 8px #ffd70010;
      transition: all 0.18s; z-index: 11;
    }
    .back-to-home:hover { background: #ffd700; color: #23232b; }
    .watermark-howard {
      position: fixed;
      bottom: 17px;
      right: 24px;
      font-size: 1.03rem;
      color: #fff;
      text-shadow:
        0 0 7px #fff,
        0 0 14px #fff,
        0 0 24px #fff,
        0 0 28px #fff9;
      opacity: 0.84;
      letter-spacing: 0.05em;
      z-index: 33333;
      font-family: 'Segoe UI', Arial, sans-serif;
      pointer-events: none;
      user-select: none;
    }
    @media (max-width: 650px) {
      .login-container { padding: 0.85rem 0.5rem; margin: 0 2px; }
      .game-title { font-size: 1.11rem; }
      .barrier-tape { top: -13px; height: 16px; }
      .back-to-home { font-size: .89rem; padding: 3px 8px; top: 2px; left: 2px;}
      .watermark-howard { right: 8px; bottom: 7px; font-size: .95rem; }
    }
  </style>
</head>
<body>
  <div class="login-bg-animation">
    <div class="bg-shape bg-shape1"></div>
    <div class="bg-shape bg-shape2"></div>
    <div class="bg-shape bg-shape3"></div>
  </div>
  <a href="Games.html" class="back-to-home">‚Üê Back to Games</a>
  <div class="login-container">
    <div class="barrier-tape"></div>
    <div style="height:20px;"></div>
    <div class="game-title">
      <span>Construction 21</span>
      <span class="helmet" aria-label="construction helmet">‚õëÔ∏è</span>
    </div>
    <div class="construction-icons">üöß üèóÔ∏è ‚öíÔ∏è</div>
    <div class="auth-tabs" style="margin-top: 6px;">
      <button class="auth-tab-btn active" data-tab="login" tabindex="0">Login</button>
      <button class="auth-tab-btn" data-tab="signup" tabindex="0">Sign Up</button>
    </div>
    <div id="login-tab" class="auth-tab-content active">
      <form id="login-form" autocomplete="on">
        <div class="form-group">
          <label class="form-label" for="login-email">Email Address</label>
          <input type="email" id="login-email" class="form-input" placeholder="Enter your email" required autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label" for="login-password">Password</label>
          <div class="form-input-wrap">
            <input type="password" id="login-password" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
            <button type="button" class="show-pass-btn" tabindex="-1" onclick="togglePassword('login-password', this)" aria-label="Show password">üëÅÔ∏è</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">
          <span></span>
          <span class="forgot-link" id="forgot-link" tabindex="0">Forgot password?</span>
        </div>
        <button id="login-btn" class="auth-btn" type="submit">Login & Play</button>
        <div id="login-message" class="message"></div>
      </form>
      <form id="forgot-form" style="display:none;">
        <div class="form-group">
          <label class="form-label" for="forgot-email">Enter your account email to reset password:</label>
          <input type="email" id="forgot-email" class="form-input" placeholder="Your email" required autocomplete="username">
        </div>
        <button id="forgot-btn" class="auth-btn" type="submit">Send Reset Email</button>
        <button type="button" class="auth-btn" style="background:#46485e;color:#fff;font-weight:600;margin-bottom:0;" id="forgot-cancel-btn">Back to Login</button>
        <div id="forgot-message" class="message"></div>
      </form>
    </div>
    <div id="signup-tab" class="auth-tab-content">
      <form id="signup-form" autocomplete="on">
        <div class="form-group">
          <label class="form-label" for="signup-name">Display Name</label>
          <input type="text" id="signup-name" class="form-input" placeholder="Your player name" required autocomplete="name">
        </div>
        <div class="form-group">
          <label class="form-label" for="signup-email">Email Address</label>
          <input type="email" id="signup-email" class="form-input" placeholder="Enter your email" required autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label" for="signup-password">Password</label>
          <div class="form-input-wrap">
            <input type="password" id="signup-password" class="form-input" placeholder="6+ characters" required autocomplete="new-password">
            <button type="button" class="show-pass-btn" tabindex="-1" onclick="togglePassword('signup-password', this)" aria-label="Show password">üëÅÔ∏è</button>
          </div>
        </div>
        <button id="signup-btn" class="auth-btn" type="submit">Create Account & Play</button>
        <div id="signup-message" class="message"></div>
      </form>
    </div>
  </div>
  <div class="watermark-howard">howard powered</div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
      authDomain: "cusumano-website.firebaseapp.com",
      projectId: "cusumano-website",
      storageBucket: "cusumano-website.appspot.com",
      messagingSenderId: "20051552210",
      appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"
    };
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (error) {
      showMessage(document.getElementById('login-message'), 'Connection error. Please refresh.', 'error');
    }

    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const loginMessage = document.getElementById('login-message');
    const signupMessage = document.getElementById('signup-message');
    const authTabs = document.querySelectorAll('.auth-tab-btn');
    const authTabContents = document.querySelectorAll('.auth-tab-content');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const forgotLink = document.getElementById('forgot-link');
    const forgotForm = document.getElementById('forgot-form');
    const forgotBtn = document.getElementById('forgot-btn');
    const forgotCancelBtn = document.getElementById('forgot-cancel-btn');
    const forgotMessage = document.getElementById('forgot-message');

    // Tab Switching
    authTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        authTabs.forEach(t => t.classList.remove('active'));
        authTabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${targetTab}-tab`).classList.add('active');
        loginMessage.textContent = '';
        signupMessage.textContent = '';
        document.getElementById('login-form').style.display = '';
        forgotForm.style.display = 'none';
        document.getElementById('forgot-message').textContent = '';
      });
    });

    // Show/hide password toggle
    window.togglePassword = function(id, btn) {
      const input = document.getElementById(id);
      if (input.type === "password") {
        input.type = "text"; btn.textContent = "üôà";
      } else {
        input.type = "password"; btn.textContent = "üëÅÔ∏è";
      }
    }

    // Auth State
    if (auth) {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const userDocRef = doc(db, "construction21_users", user.uid);
            const userDoc = await getDoc(userDocRef);
            let chips = 100;
            let displayName = user.displayName || user.email?.split('@')[0] || 'Player';
            if (!userDoc.exists()) {
              await setDoc(userDocRef, {
                displayName,
                chips,
                email: user.email,
                createdAt: new Date(),
                lastLogin: new Date()
              });
            } else {
              chips = userDoc.data().chips || 100;
              displayName = userDoc.data().displayName || displayName;
            }
            // Store user info for multiplayer handoff
            sessionStorage.setItem('c21user', JSON.stringify({
              uid: user.uid,
              displayName,
              email: user.email,
              chips
            }));
            sessionStorage.setItem('loginSuccess', 'true');
            window.location.href = 'construction21.html';
          } catch (error) {
            showMessage(loginMessage, 'Error loading user data. Try again.', 'error');
          }
        }
      });
    }

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) return showMessage(loginMessage, 'Please fill in all fields.', 'error');
      if (!email.includes('@')) return showMessage(loginMessage, 'Please enter a valid email.', 'error');
      if (!auth) return showMessage(loginMessage, 'Authentication unavailable. Refresh.', 'error');
      setButtonLoading(loginBtn, 'Logging in...');
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage(loginMessage, 'Login successful! Redirecting...', 'success');
      } catch (error) {
        setButtonLoading(loginBtn, 'Login & Play', false);
        showMessage(loginMessage, getErrorMessage(error.code), 'error');
      }
    });

    // Signup
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      if (!name || !email || !password) return showMessage(signupMessage, 'Please fill in all fields.', 'error');
      if (name.length < 2) return showMessage(signupMessage, 'Name must be at least 2 characters.', 'error');
      if (!email.includes('@')) return showMessage(signupMessage, 'Please enter a valid email.', 'error');
      if (password.length < 6) return showMessage(signupMessage, 'Password 6+ chars.', 'error');
      if (!auth || !db) return showMessage(signupMessage, 'Auth unavailable. Refresh.', 'error');
      setButtonLoading(signupBtn, 'Creating account...');
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await setDoc(doc(db, "construction21_users", user.uid), {
          displayName: name,
          chips: 100,
          email: email,
          createdAt: new Date(),
          lastLogin: new Date()
        });
        // Store user info for multiplayer handoff
        sessionStorage.setItem('c21user', JSON.stringify({
          uid: user.uid,
          displayName: name,
          email,
          chips: 100
        }));
        showMessage(signupMessage, 'Account created! Redirecting...', 'success');
      } catch (error) {
        setButtonLoading(signupBtn, 'Create Account & Play', false);
        showMessage(signupMessage, getErrorMessage(error.code), 'error');
      }
    });

    // Forgot password flow
    forgotLink.addEventListener('click', () => {
      loginForm.style.display = 'none';
      forgotForm.style.display = '';
      forgotMessage.textContent = '';
      document.getElementById('forgot-email').value = document.getElementById('login-email').value;
    });
    forgotCancelBtn.addEventListener('click', () => {
      forgotForm.style.display = 'none';
      loginForm.style.display = '';
      forgotMessage.textContent = '';
    });
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) return showMessage(forgotMessage, 'Please enter your email.', 'error');
      setButtonLoading(forgotBtn, 'Sending...');
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage(forgotMessage, 'Reset email sent! Check your inbox.', 'success');
      } catch (error) {
        setButtonLoading(forgotBtn, 'Send Reset Email', false);
        showMessage(forgotMessage, getErrorMessage(error.code), 'error');
      }
    });

    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `message ${type}`;
    }
    function setButtonLoading(button, text, loading = true) {
      button.textContent = text;
      button.disabled = loading;
    }
    function getErrorMessage(code) {
      switch (code) {
        case 'auth/user-not-found': return 'No account with this email.';
        case 'auth/wrong-password': return 'Incorrect password.';
        case 'auth/email-already-in-use': return 'Email already exists.';
        case 'auth/weak-password': return 'Password too short.';
        case 'auth/invalid-email': return 'Invalid email address.';
        case 'auth/too-many-requests': return 'Too many failed attempts. Try again later.';
        default: return 'An error occurred. Try again.';
      }
    }

    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const activeTab = document.querySelector('.auth-tab-content.active');
        if (forgotForm.style.display === '' && forgotForm.offsetParent !== null) {
          forgotBtn.click();
        } else if (activeTab.id === 'login-tab') loginBtn.click();
        else signupBtn.click();
      }
    });
  </script>
</body>
</html>
