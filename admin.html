<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Cusumano Home Improvements</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0a4d68; --secondary-color: #088395; --accent-color: #f5a623;
            --light-bg: #f7f8fc; --dark-gray: #333333; --medium-gray: #6c757d;
            --white: #ffffff; --danger-color: #e63946; --success-color: #2a9d8f;
            --font-heading: 'Poppins', sans-serif; --font-body: 'Roboto', sans-serif;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { margin: 0; font-family: var(--font-body); background: linear-gradient(to top right, #eef2f3, #f7f8fc); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-screen { background-color: var(--white); padding: 3rem; border-radius: 12px; box-shadow: var(--shadow-md); width: 100%; max-width: 420px; text-align: center; border: 1px solid #e9ecef; }
        .login-logo { font-family: var(--font-heading); font-weight: 700; font-size: 1.8rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; position: relative; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
        .btn { display: inline-block; width: 100%; padding: 0.9rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 1.1rem; font-family: var(--font-heading); background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); color: var(--white); }
        #login-error { color: var(--danger-color); background-color: rgba(230, 57, 70, 0.1); margin-top: 1.5rem; padding: 0.8rem; border-radius: 8px; display: none; }
        #admin-dashboard { width: 100%; height: 100vh; display: none; flex-direction: column; background-color: var(--light-bg); }
        .admin-header { background-color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; }
        .admin-header h1 { font-size: 1.5rem; color: var(--primary-color); }
        .logout-btn { background-color: transparent; color: var(--danger-color); border: 2px solid var(--danger-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 700; }
        .admin-main { padding: 2.5rem; flex-grow: 1; overflow-y: auto; }
        .control-card {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .control-card:hover, .control-card:focus-within {
            box-shadow: 0 8px 32px rgba(10,77,104,0.10);
            transform: translateY(-4px) scale(1.01);
        }
        .btn:focus, .logout-btn:focus, .toggle-password:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
        .btn, .logout-btn {
            transition: box-shadow 0.2s, background 0.2s, color 0.2s;
        }
        .btn:hover, .logout-btn:hover {
            box-shadow: 0 4px 16px rgba(10,77,104,0.12);
            filter: brightness(1.05);
        }
        .upload-area {
            border: 2px dashed var(--secondary-color);
            background-color: #f0f6fa;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-area:focus-within, .upload-area:hover {
            border-color: var(--accent-color);
            background: #f7f8fc;
        }
        .upload-message.success {
            border: 1px solid var(--success-color);
            background: rgba(42,157,143,0.18);
        }
        .upload-message.error {
            border: 1px solid var(--danger-color);
            background: rgba(230,57,70,0.18);
        }
        @media (max-width: 600px) {
            .admin-main { padding: 1rem; }
            .control-card { padding: 1rem; }
            .image-gallery { gap: 0.7rem; }
        }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .img-card { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .img-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .img-card .delete-btn { position: absolute; top: 8px; right: 8px; background-color: rgba(230, 57, 70, 0.8); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1rem; line-height: 30px; text-align: center; }
        .upload-area { border: 2px dashed #ced4da; border-radius: 8px; padding: 2rem; text-align: center; background-color: #f8f9fa; }
        #upload-progress { width: 100%; margin-top: 1rem; display: none; }
        
        /* Floating Button on Admin Page */
        .site-return-float { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .site-return-float a { display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--secondary-color); color: var(--white); border-radius: 50%; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .site-return-float a:hover { transform: scale(1.1); }

        .form-group.password-group { position: relative; }
        .toggle-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--medium-gray);
            font-size: 1.1rem;
            padding: 0;
        }
        .image-count {
            font-size: 1rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
            text-align: right;
        }
        .upload-preview {
            margin-bottom: 1rem;
            text-align: center;
        }
        .upload-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(10,77,104,0.10);
            margin-bottom: 0.5rem;
        }
        .upload-message {
            margin-top: 1rem;
            font-size: 1rem;
            border-radius: 8px;
            padding: 0.7rem 1rem;
            display: none;
        }
        .upload-message.success { background: rgba(42,157,143,0.12); color: var(--success-color); }
        .upload-message.error { background: rgba(230,57,70,0.12); color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="login-logo">Cusumano</h1>
        <p>Admin Panel</p>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group password-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password">
            <button type="button" class="toggle-password" id="toggle-password" aria-label="Show password" title="Show/Hide Password">üëÅÔ∏è</button>
        </div>
        <button id="login-btn" class="btn">Login</button>
        <p id="login-error">Error logging in. Check email/password.</p>
    </div>

    <div id="admin-dashboard">
        <header class="admin-header">
            <h1>Dashboard</h1>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </header>

        <main class="admin-main">
            <div class="control-card">
                <h2>Homepage Slider</h2>
                <p>Add or remove photos from the main image slider. Changes will appear on the live site instantly.</p>
                <div class="image-count" id="image-count"></div>
                <div class="image-gallery" id="image-gallery-container">
                    <!-- Images from Firebase will be loaded here -->
                </div>
                <div class="upload-area">
                    <div class="upload-preview" id="upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="upload-btn" class="btn" style="width: auto; background: var(--success-color);">Choose Image</button>
                    <progress id="upload-progress" value="0" max="100"></progress>
                    <div class="upload-message" id="upload-message"></div>
                </div>
            </div>

            <div class="control-card">
                <h2>Hero Banner Image</h2>
                <p>Upload or change the homepage hero banner image. This image appears at the top of the homepage.</p>
                <div class="upload-area" id="hero-upload-area">
                    <div class="upload-preview" id="hero-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="hero-image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="hero-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Banner Image</button>
                    <progress id="hero-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="hero-upload-message"></div>
                </div>
                <div id="current-hero-banner" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card">
                <h2>Logo Image</h2>
                <p>Upload or change the company logo. This logo will appear on the homepage and admin panel.</p>
                <div class="upload-area" id="logo-upload-area">
                    <div class="upload-preview" id="logo-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="logo-image-upload-input" accept="image/jpeg, image/png, image/webp, image/svg+xml" hidden>
                    <button id="logo-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Logo Image</button>
                    <progress id="logo-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="logo-upload-message"></div>
                </div>
                <div id="current-logo-image" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card" id="site-editor-card">
                <h2>Edit Website Text</h2>
                <form id="site-editor-form" autocomplete="off">
                    <div class="form-group">
                        <label for="about-text">About Section</label>
                        <textarea id="about-text" rows="4" class="field-element"></textarea>
                    </div>
                    <div class="form-group" id="services-fields">
                        <!-- Dynamic service fields will be inserted here -->
                    </div>
                    <div class="form-group">
                        <label for="contact-address">Contact Address</label>
                        <input type="text" id="contact-address" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">Contact Phone</label>
                        <input type="text" id="contact-phone" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-email">Contact Email</label>
                        <input type="email" id="contact-email" class="field-element">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="preview-btn" class="btn" style="width:auto; background: var(--primary-color);">Preview</button>
                        <button type="button" id="download-html-btn" class="btn" style="width:auto; background: var(--accent-color);">Download HTML</button>
                        <button type="button" id="save-btn" class="btn" style="width:auto; background: var(--success-color); margin-left:1rem;">Save to Website</button>
                    </div>
                </form>
                <div id="site-preview" style="margin-top:2rem; background:#f7f8fc; border-radius:8px; padding:1.5rem; box-shadow:0 2px 8px rgba(10,77,104,0.06);"></div>
            </div>
        </main>
        
        <div class="site-return-float">
            <a href="index.html" title="Return to Main Site">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-storage.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
            authDomain: "cusumano-website.firebaseapp.com",
            projectId: "cusumano-website",
            storageBucket: "cusumano-website.firebasestorage.app",
            messagingSenderId: "20051552210",
            appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"
        };
        // ----------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const galleryContainer = document.getElementById('image-gallery-container');
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const imageCount = document.getElementById('image-count');
        const uploadPreview = document.getElementById('upload-preview');
        const uploadMessage = document.getElementById('upload-message');
        const saveBtn = document.getElementById('save-btn');
        const heroImageUploadInput = document.getElementById('hero-image-upload-input');
        const heroUploadBtn = document.getElementById('hero-upload-btn');
        const heroUploadPreview = document.getElementById('hero-upload-preview');
        const heroUploadProgress = document.getElementById('hero-upload-progress');
        const heroUploadMessage = document.getElementById('hero-upload-message');
        const currentHeroBanner = document.getElementById('current-hero-banner');
        const logoImageUploadInput = document.getElementById('logo-image-upload-input');
        const logoUploadBtn = document.getElementById('logo-upload-btn');
        const logoUploadPreview = document.getElementById('logo-upload-preview');
        const logoUploadProgress = document.getElementById('logo-upload-progress');
        const logoUploadMessage = document.getElementById('logo-upload-message');
        const currentLogoImage = document.getElementById('current-logo-image');

        // --- Firebase logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.style.display = 'none';
                adminDashboard.style.display = 'flex';
                setupImageListener();
                setupHeroBannerListener();
                setupLogoListener();
            } else {
                adminDashboard.style.display = 'none';
                loginScreen.style.display = 'block';
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => { loginError.style.display = 'block'; });
        });

        logoutBtn.addEventListener('click', (e) => {
            if (confirm('Are you sure you want to log out?')) {
                signOut(auth);
            }
        });
        uploadBtn.addEventListener('click', () => imageUploadInput.click());
        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());
        logoUploadBtn.addEventListener('click', () => logoImageUploadInput.click());

        togglePasswordBtn.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePasswordBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                togglePasswordBtn.textContent = 'üëÅÔ∏è';
            }
        });

        function setupImageListener() {
            const imagesCol = collection(db, 'sliderImages');
            onSnapshot(imagesCol, (snapshot) => {
                galleryContainer.innerHTML = '';
                imageCount.textContent = `Total Images: ${snapshot.size}`;
                snapshot.docs.forEach(doc => {
                    const imgData = doc.data();
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `<img src="${imgData.url}" alt="Slider Image"><button class="delete-btn" data-id="${doc.id}" data-path="${imgData.path}">&times;</button>`;
                    galleryContainer.appendChild(card);
                });
            });
        }

        function setupHeroBannerListener() {
            const heroBannerDoc = doc(db, 'siteContent', 'main');
            onSnapshot(heroBannerDoc, (doc) => {
                const data = doc.data();
                currentHeroBanner.innerHTML = data.heroBanner ? `<img src="${data.heroBanner}" alt="Current Hero Banner" style="max-width:100%; border-radius:8px;">` : 'No hero banner set.';
            });
        }

        function setupLogoListener() {
            const logoDoc = doc(db, 'siteContent', 'main');
            onSnapshot(logoDoc, (docSnap) => {
                const data = docSnap.data();
                if (data && data.logoUrl) {
                    currentLogoImage.innerHTML = `<img src="${data.logoUrl}" alt="Current Logo" style="max-width:180px;max-height:120px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;">`;
                } else {
                    currentLogoImage.innerHTML = '<em>No logo image set.</em>';
                }
            });
        }
        
        galleryContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                const storagePath = e.target.dataset.path;
                if(confirm('Are you sure you want to delete this image?')){
                    try {
                        await deleteDoc(doc(db, 'sliderImages', docId));
                        const storageRef = ref(storage, storagePath);
                        await deleteObject(storageRef);
                    } catch (error) {
                        console.error("Error deleting image:", error);
                        alert("Could not delete image. See console for details.");
                    }
                }
            }
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            uploadPreview.innerHTML = '';
            uploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                uploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `sliderImages/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgress.style.display = 'block';
                    uploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    uploadMessage.textContent = 'Upload failed. See console for details.';
                    uploadMessage.className = 'upload-message error';
                    uploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        await addDoc(collection(db, 'sliderImages'), {
                            url: downloadURL,
                            path: storagePath,
                            createdAt: new Date()
                        });
                        uploadProgress.style.display = 'none';
                        imageUploadInput.value = '';
                        uploadPreview.innerHTML = '';
                        uploadMessage.textContent = 'Image uploaded successfully!';
                        uploadMessage.className = 'upload-message success';
                        uploadMessage.style.display = 'block';
                    });
                }
            );
        });

        // Load current hero banner image from Firestore
        async function loadHeroBanner() {
            try {
                const docRef = doc(db, 'siteContent', 'main');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.heroBannerUrl) {
                        currentHeroBanner.innerHTML = `<img src="${data.heroBannerUrl}" alt="Current Hero Banner" style="max-width:100%;max-height:180px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;">`;
                    } else {
                        currentHeroBanner.innerHTML = '<em>No hero banner image set.</em>';
                    }
                }
            } catch (e) {
                currentHeroBanner.innerHTML = '<em>Error loading hero banner.</em>';
            }
        }

        // Initial load
        loadHeroBanner();

        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            heroUploadPreview.innerHTML = '';
            heroUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                heroUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `banner/main-banner_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            heroUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    heroUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    heroUploadMessage.textContent = 'Upload failed. See console for details.';
                    heroUploadMessage.className = 'upload-message error';
                    heroUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { heroBannerUrl: downloadURL }, { merge: true });
                        heroUploadProgress.style.display = 'none';
                        heroImageUploadInput.value = '';
                        heroUploadPreview.innerHTML = '';
                        heroUploadMessage.textContent = 'Hero banner image uploaded and set!';
                        heroUploadMessage.className = 'upload-message success';
                        heroUploadMessage.style.display = 'block';
                        loadHeroBanner();
                    });
                }
            );
        });

        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            logoUploadPreview.innerHTML = '';
            logoUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                logoUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview" style="max-width:120px;max-height:80px;"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `logo/logo_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            logoUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    logoUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    logoUploadMessage.textContent = 'Upload failed. See console for details.';
                    logoUploadMessage.className = 'upload-message error';
                    logoUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { logoUrl: downloadURL }, { merge: true });
                        logoUploadProgress.style.display = 'none';
                        logoImageUploadInput.value = '';
                        logoUploadPreview.innerHTML = '';
                        logoUploadMessage.textContent = 'Logo image uploaded and set!';
                        logoUploadMessage.className = 'upload-message success';
                        logoUploadMessage.style.display = 'block';
                    });
                }
            );
        });
        // --- End of Firebase logic ---

        // --- Website Editor Logic ---
        // Services as an array for reordering
        let services = [
            { id: 'siding', label: 'Siding', value: '', textarea: null, icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
            { id: 'decks', label: 'Decks', value: '', textarea: null, icon: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4' },
            { id: 'dumpster', label: 'Dumpster Rentals', value: '', textarea: null, icon: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' }
        ];
        const aboutText = document.getElementById('about-text');
        const contactAddress = document.getElementById('contact-address');
        const contactPhone = document.getElementById('contact-phone');
        const contactEmail = document.getElementById('contact-email');
        const previewBtn = document.getElementById('preview-btn');
        const downloadBtn = document.getElementById('download-html-btn');
        const sitePreview = document.getElementById('site-preview');
        // Replace static service fields with dynamic ones
        const servicesContainer = document.createElement('div');
        servicesContainer.id = 'services-fields';
        const form = document.getElementById('site-editor-form');
        // Remove old service fields
        ['services-siding','services-decks','services-dumpster'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.closest('.form-group').remove();
        });
        // Insert dynamic service fields
        const insertAfter = document.getElementById('about-text').closest('.form-group');
        insertAfter.parentNode.insertBefore(servicesContainer, insertAfter.nextSibling);
        function renderServiceFields() {
            servicesContainer.innerHTML = '';
            services.forEach((service, idx) => {
                const group = document.createElement('div');
                group.className = 'form-group service-group';
                group.style.display = 'flex';
                group.style.alignItems = 'center';
                group.style.gap = '0.5rem';
                group.innerHTML = `
                    <label for="service-${service.id}" style="flex:0 0 140px;">${service.label} Description</label>
                    <textarea id="service-${service.id}" rows="2" class="field-element" style="flex:1;">${service.value}</textarea>
                    <div style="display:flex; flex-direction:column; gap:0.2rem;">
                        <button type="button" class="move-up" data-idx="${idx}" ${idx===0?'disabled':''} title="Move Up">‚¨ÜÔ∏è</button>
                        <button type="button" class="move-down" data-idx="${idx}" ${idx===services.length-1?'disabled':''} title="Move Down">‚¨áÔ∏è</button>
                        <button type="button" class="remove-service" data-idx="${idx}" title="Remove Service" style="color:#e63946;">‚ûñ</button>
                    </div>
                `;
                servicesContainer.appendChild(group);
            });
            // Add + button at the bottom
            const addBtnGroup = document.createElement('div');
            addBtnGroup.className = 'form-group';
            addBtnGroup.style.textAlign = 'center';
            addBtnGroup.innerHTML = '<button type="button" id="add-service-btn" class="btn" style="width:auto;font-size:1.5rem;">‚ûï Add Service</button>';
            servicesContainer.appendChild(addBtnGroup);
        }
        // Initial values (should match your current site)
        aboutText.value = "For over 20 years, Cusumano Home Improvements has been a family-owned and operated business proudly serving the Monroe, MI area. We are dedicated to delivering the highest quality of work, specializing in residential construction and convenient dumpster rentals. Our commitment is to our craft and, most importantly, to our customers' satisfaction.";
        services[0].value = "Enhance your home's curb appeal and protection with our wide variety of siding options, including vinyl, wood, and fiber cement.";
        services[1].value = "We design and build custom decks or repair existing ones, creating beautiful and lasting outdoor living spaces for you to enjoy.";
        services[2].value = "Convenient and competitively priced dumpster rentals for your project needs, with various sizes and flexible scheduling.";
        contactAddress.value = "Monroe, MI";
        contactPhone.value = "734-777-8158";
        contactEmail.value = "copernan@yahoo.com";
        renderServiceFields();
        // Attach textarea refs and listeners
        function updateServiceRefsAndListeners() {
            services.forEach((service, idx) => {
                service.textarea = document.getElementById(`service-${service.id}`);
                service.textarea.value = service.value;
                service.textarea.addEventListener('input', () => {
                    service.value = service.textarea.value;
                    renderPreview();
                });
            });
        }
        updateServiceRefsAndListeners();
        // Move up/down logic
        servicesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('move-up')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx > 0) {
                    [services[idx-1], services[idx]] = [services[idx], services[idx-1]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('move-down')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx < services.length-1) {
                    [services[idx], services[idx+1]] = [services[idx+1], services[idx]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('remove-service')) {
                const idx = parseInt(e.target.dataset.idx);
                if (services.length > 1 && confirm(`Remove service: ${services[idx].label}?`)) {
                    services.splice(idx, 1);
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.id === 'add-service-btn') {
                const label = prompt('Enter new service name:');
                if (!label) return;
                if (services.some(s => s.label.toLowerCase() === label.toLowerCase())) {
                    alert('Service already exists.');
                    return;
                }
                const value = prompt('Enter service description:') || '';
                const id = label.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                services.push({ id, label, value, textarea: null, icon: '' });
                renderServiceFields();
                updateServiceRefsAndListeners();
                renderPreview();
            }
        });
        // Live preview on all changes
        [aboutText, contactAddress, contactPhone, contactEmail].forEach(el => {
            el.addEventListener('input', renderPreview);
        });
        function renderPreview() {
            sitePreview.innerHTML = `
                <h3>About</h3>
                <p>${aboutText.value}</p>
                <h3>Services</h3>
                <ul>
                    ${services.map(s => `<li><strong>${s.label}:</strong> ${s.value}</li>`).join('')}
                </ul>
                <h3>Contact Info</h3>
                <ul>
                    <li><strong>Address:</strong> ${contactAddress.value}</li>
                    <li><strong>Phone:</strong> ${contactPhone.value}</li>
                    <li><strong>Email:</strong> ${contactEmail.value}</li>
                </ul>
            `;
        }
        // Initial preview
        renderPreview();
        previewBtn.addEventListener('click', renderPreview);
        downloadBtn.addEventListener('click', () => {
            // This is a basic HTML snippet for manual replacement
            const html = `<!-- About Section -->\n<p>${aboutText.value}</p>\n<!-- Services Section -->\n<ul>\n${services.map(s => `<li><strong>${s.label}:</strong> ${s.value}</li>`).join('\n')}\n</ul>\n<!-- Contact Info -->\n<ul>\n<li><strong>Address:</strong> ${contactAddress.value}</li>\n<li><strong>Phone:</strong> ${contactPhone.value}</li>\n<li><strong>Email:</strong> ${contactEmail.value}</li>\n</ul>`;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'site-content.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        // --- Firestore Live Save ---
        saveBtn.addEventListener('click', async () => {
            const about = aboutText.value;
            const contactIntro = "Contact us today for a free, no-obligation quote. We're ready to help bring your vision to life. You can reach out via the form below, or call us directly!";
            const contactAddress = document.getElementById('contact-address').value;
            const contactPhone = document.getElementById('contact-phone').value;
            const contactEmail = document.getElementById('contact-email').value;
            const servicesArr = services.map(s => ({ label: s.label, value: s.value, icon: s.icon }));
            try {
                await setDoc(doc(db, 'siteContent', 'main'), {
                    about,
                    services: servicesArr,
                    contactIntro,
                    contactAddress,
                    contactPhone,
                    contactEmail
                });
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            } catch (e) {
                saveBtn.textContent = 'Error!';
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            }
        });
    </script>
</body>
</html>
