<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Cusumano Home Improvements</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">    <style>
        :root {
            --primary-color: #0a4d68;
            --secondary-color: #088395;
            --accent-color: #f5a623;
            --light-bg: #f7f8fc;
            --dark-gray: #222b45;
            --medium-gray: #6c757d;
            --white: #ffffff;
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --warning-color: #f5a623;
            --glass-bg: rgba(255,255,255,0.75);
            --glass-blur: 16px;
            --shadow-md: 0 8px 32px rgba(10,77,104,0.10);
            --shadow-lg: 0 16px 48px rgba(10,77,104,0.18);
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Roboto', sans-serif;
        }
        
        .offline-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: var(--white);
            border: 2px solid var(--warning-color);
            border-radius: 8px;
            padding: 12px 24px;
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.5s ease-out;
            max-width: 90%;
        }
        
        .offline-message .warning-text {
            color: var(--warning-color);
            font-weight: bold;
            margin-right: 8px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        body {
            margin: 0;
            font-family: var(--font-body);
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #login-screen {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--shadow-lg);
            border-radius: 18px;
            padding: 3rem 2.5rem 2.5rem 2.5rem;
            max-width: 420px;
            width: 100%;
            text-align: center;
            border: 1.5px solid #e9ecef;
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }
        .login-logo {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #b2d8f7;
        }        .form-group {
            margin-bottom: 1.7rem;
            text-align: left;
            position: relative;
        }
        
        .password-group {
            position: relative;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--medium-gray);
            padding: 0;
            height: 24px;
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
            z-index: 10;
        }
        
        .toggle-password:hover {
            color: var(--primary-color);
        }
        
        .password-group input {
            padding-right: 45px;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-color);
            letter-spacing: 0.5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 1rem 1.1rem;
            border: 1.5px solid #d1e3f8;
            border-radius: 10px;
            font-size: 1.08rem;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            transition: border 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus {
            border: 1.5px solid var(--secondary-color);
            outline: none;
            box-shadow: 0 4px 16px rgba(10,77,104,0.10);
        }
        .btn {
            display: inline-block;
            padding: 1rem 2.2rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            font-size: 1.13rem;
            font-family: var(--font-heading);
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: var(--white);
            box-shadow: 0 2px 8px rgba(10,77,104,0.10);
            transition: box-shadow 0.2s, background 0.2s, color 0.2s, transform 0.1s;
            margin-bottom: 0.2rem;
        }
        .btn:hover, .btn:focus {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 6px 24px rgba(10,77,104,0.13);
            filter: brightness(1.07);
            transform: translateY(-2px) scale(1.03);
        }
        .logout-btn {
            background: transparent;
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.05rem;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .logout-btn:hover, .logout-btn:focus {
            background: var(--danger-color);
            color: var(--white);
            box-shadow: 0 4px 16px rgba(230,57,70,0.13);
        }
        #login-error {
            color: var(--danger-color);
            background: rgba(230, 57, 70, 0.13);
            margin-top: 1.5rem;
            padding: 0.9rem;
            border-radius: 10px;
            display: none;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        #admin-dashboard {
            width: 100vw;
            min-height: 100vh;
            display: none;
            flex-direction: column;
            background: linear-gradient(120deg, #e0eafc 0%, #f7f8fc 100%);
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }        .admin-header {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            padding: 1.2rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1.5px solid #e9ecef;
            box-shadow: 0 2px 12px rgba(10,77,104,0.06);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .admin-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            opacity: 0.6;
        }
        .admin-header h1 {
            font-size: 2rem;
            color: var(--primary-color);
            font-family: var(--font-heading);
            font-weight: 700;
            letter-spacing: 1px;
        }
        .admin-main {
            padding: 3.5rem 2.5rem 2.5rem 2.5rem;
            flex-grow: 1;
            overflow-y: auto;
            background: none;
        }        .control-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            padding: 2.5rem 2rem;
            border-radius: 18px;
            box-shadow: var(--shadow-md);
            border: 1.5px solid #e9ecef;
            margin-bottom: 2.5rem;
            transition: box-shadow 0.2s, transform 0.2s;
            animation: fadeInUp 0.7s cubic-bezier(.4,0,.2,1);
            position: relative;
            overflow: hidden;
        }
        
        .control-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color), var(--primary-color));
            opacity: 0.8;
        }
        
        .control-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .control-card:hover, .control-card:focus-within {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px) scale(1.012);
        }
        .control-card h2 {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-card h2::before {
            content: '';
            width: 4px;
            height: 1.2rem;
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            border-radius: 2px;
        }
        
        .control-card p {
            color: var(--medium-gray);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        .form-actions {
            display: flex;
            gap: 1.2rem;
            flex-wrap: wrap;
            margin-top: 2.2rem;
        }
        .upload-area {
            border: 2.5px dashed var(--secondary-color);
            background: rgba(240,246,250,0.85);
            border-radius: 12px;
            padding: 2.2rem 1.2rem;
            text-align: center;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            margin-bottom: 0.5rem;
            position: relative;
        }
        .upload-area:focus-within, .upload-area:hover {
            border-color: var(--accent-color);
            background: #f7f8fc;
            box-shadow: 0 4px 16px rgba(245,166,35,0.08);
        }
        .upload-preview {
            margin-bottom: 1.1rem;
            text-align: center;
        }
        .upload-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(10,77,104,0.10);
            margin-bottom: 0.5rem;
            background: #fff;
        }
        .upload-message {
            margin-top: 1rem;
            font-size: 1.05rem;
            border-radius: 10px;
            padding: 0.7rem 1.1rem;
            display: none;
            font-weight: 600;
        }
        .upload-message.success {
            background: rgba(42,157,143,0.12);
            color: var(--success-color);
            border: 1.5px solid var(--success-color);
        }
        .upload-message.error {
            background: rgba(230,57,70,0.12);
            color: var(--danger-color);
            border: 1.5px solid var(--danger-color);
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.7rem;
            margin-bottom: 2rem;
        }
        .img-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(10,77,104,0.10);
            background: var(--white);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .img-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
            border-radius: 12px 12px 0 0;
        }
        .img-card .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--danger-color), #ffb3b3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 34px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(230,57,70,0.13);
            transition: background 0.2s, transform 0.1s;
        }
        .img-card .delete-btn:hover {
            background: var(--danger-color);
            transform: scale(1.08);
        }
        .image-count {
            font-size: 1.08rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
            text-align: right;
            font-weight: 600;
        }
        .service-group {
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            padding: 1.2rem 1rem 1.2rem 1.2rem;
            margin-bottom: 1.2rem;
            border: 1.5px solid #e9ecef;
            transition: box-shadow 0.2s, border 0.2s;
        }
        .service-group:hover, .service-group:focus-within {
            box-shadow: 0 4px 16px rgba(10,77,104,0.10);
            border: 1.5px solid var(--secondary-color);
        }
        .service-group label {
            color: var(--primary-color);
            font-size: 1.05rem;
        }
        .service-upload-area {
            background: rgba(240,246,250,0.92);
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 1.1rem 0.7rem;
            min-width: 160px;
            max-width: 200px;
            margin-left: 0.5rem;
            margin-top: 0.2rem;
        }
        .service-upload-btn {
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: var(--white);
            border-radius: 8px;
            font-size: 1rem;
            padding: 0.6rem 1.2rem;
            margin-top: 0.3rem;
            width: 100%;
        }
        .service-upload-btn:hover {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .move-up, .move-down, .remove-service {
            background: var(--white);
            border: 1.5px solid #d1e3f8;
            color: var(--primary-color);
            border-radius: 8px;
            font-size: 1.2rem;
            padding: 0.3rem 0.7rem;
            margin-bottom: 0.2rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s, transform 0.1s;
        }
        .move-up:disabled, .move-down:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .move-up:hover:not(:disabled), .move-down:hover:not(:disabled) {
            background: var(--secondary-color);
            color: var(--white);
            border: 1.5px solid var(--secondary-color);
            transform: scale(1.08);
        }
        .remove-service {
            color: var(--danger-color);
            border: 1.5px solid var(--danger-color);
        }
        .remove-service:hover {
            background: var(--danger-color);
            color: var(--white);
            transform: scale(1.08);
        }
        #add-service-btn {
            background: var(--secondary-color);
            color: var(--white);
            border-radius: 10px;
            font-size: 1.3rem;
            padding: 0.7rem 2rem;
            margin-top: 0.7rem;
            width: auto;
            box-shadow: 0 2px 8px rgba(245,166,35,0.10);
        }
        #add-service-btn:hover {
            background: var(--primary-color);
        }
        .toggle-password {
            position: absolute;
            right: 1.1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--medium-gray);
            font-size: 1.2rem;
            padding: 0;
            transition: color 0.2s;
        }
        .toggle-password:hover {
            color: var(--primary-color);
        }
        #site-preview {
            background: rgba(255,255,255,0.92);
            border-radius: 12px;
            padding: 1.7rem 1.2rem;
            box-shadow: 0 2px 8px rgba(10,77,104,0.06);
            font-size: 1.08rem;
            color: var(--dark-gray);
            margin-top: 2rem;
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }
        .site-return-float {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
        }
        .site-return-float a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            border-radius: 50%;
            text-decoration: none;
            box-shadow: 0 4px 16px rgba(10,77,104,0.18);
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1.5rem;
        }
        .site-return-float a:hover {
            transform: scale(1.13);
            box-shadow: 0 8px 32px rgba(10,77,104,0.22);
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: none; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(32px); }
            to { opacity: 1; transform: none; }
        }
        /* Responsive Design */
        @media (max-width: 900px) {
            .admin-main {
                padding: 1.2rem 0.5rem;
            }
            .control-card {
                padding: 1.2rem 0.7rem;
            }
        }
        @media (max-width: 600px) {
            #login-screen {
                padding: 1.2rem 0.5rem;
            }
            .admin-header {
                padding: 0.7rem 0.7rem;
            }
            .admin-header h1 {
                font-size: 1.3rem;
            }
            .admin-main {
                padding: 0.5rem 0.1rem;
            }
            .control-card {
                padding: 0.7rem 0.3rem;
            }
            .image-gallery {
                gap: 0.7rem;
            }
            .service-group {
                flex-direction: column;
                padding: 0.7rem 0.3rem;
            }
            .service-upload-area {
                min-width: 100px;
                max-width: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="login-logo">Cusumano</h1>
        <p>Admin Panel</p>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group password-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password">
            <button type="button" class="toggle-password" id="toggle-password" aria-label="Show password" title="Show/Hide Password">üëÅÔ∏è</button>
        </div>
        <button id="login-btn" class="btn">Login</button>        <a href="#" id="play-games-launcher" style="display:inline-block;margin-left:1.2rem;padding:0.6rem 1.3rem;font-size:1.1rem;background:linear-gradient(90deg,#e0a106,#ff4e00);color:#fff;text-decoration:none;border-radius:8px;box-shadow:0 2px 8px rgba(224,161,6,0.13);font-weight:600;vertical-align:middle;transition:transform 0.15s;">
            üéÆ Games Launcher
        </a>
        <script>
        document.getElementById('play-games-launcher').onclick = function(e) {
            e.preventDefault();
            window.location.href = 'Games.html';
        };
        </script>
        <p id="login-error">Error logging in. Check email/password.</p>
    </div>

    <div id="admin-dashboard">
        <header class="admin-header">
            <h1>Dashboard</h1>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </header>

        <main class="admin-main">
            <div class="control-card">
                <h2>Homepage Slider</h2>
                <p>Add or remove photos from the main image slider. Changes will appear on the live site instantly.</p>
                <div class="image-count" id="image-count"></div>
                <div class="image-gallery" id="image-gallery-container">
                    <!-- Images from Firebase will be loaded here -->
                </div>
                <div class="upload-area">
                    <div class="upload-preview" id="upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="upload-btn" class="btn" style="width: auto; background: var(--success-color);">Choose Image</button>
                    <progress id="upload-progress" value="0" max="100"></progress>
                    <div class="upload-message" id="upload-message"></div>
                </div>
            </div>

            <div class="control-card">
                <h2>Hero Banner Image</h2>
                <p>Upload or change the homepage hero banner image. This image appears at the top of the homepage.</p>
                <div class="upload-area" id="hero-upload-area">
                    <div class="upload-preview" id="hero-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="hero-image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="hero-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Banner Image</button>
                    <progress id="hero-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="hero-upload-message"></div>
                </div>
                <div id="current-hero-banner" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card">
                <h2>Logo Image</h2>
                <p>Upload or change the company logo. This logo will appear on the homepage and admin panel.</p>
                <div class="upload-area" id="logo-upload-area">
                    <div class="upload-preview" id="logo-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="logo-image-upload-input" accept="image/jpeg, image/png, image/webp, image/svg+xml" hidden>
                    <button id="logo-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Logo Image</button>
                    <progress id="logo-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="logo-upload-message"></div>
                </div>
                <div id="current-logo-image" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card" id="site-editor-card">
                <h2>Edit Website Text</h2>
                <form id="site-editor-form" autocomplete="off">
                    <div class="form-group">
                        <label for="about-text">About Section</label>
                        <textarea id="about-text" rows="4" class="field-element"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="contact-address">Contact Address</label>
                        <input type="text" id="contact-address" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">Contact Phone</label>
                        <input type="text" id="contact-phone" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-email">Contact Email</label>
                        <input type="email" id="contact-email" class="field-element">
                    </div>
                    <div class="form-group" id="services-fields">
                        <!-- Dynamic service fields will be inserted here -->
                    </div>
                    <div class="form-actions">
                        <button type="button" id="preview-btn" class="btn" style="width:auto; background: var(--primary-color);">Preview</button>
                        <button type="button" id="download-html-btn" class="btn" style="width:auto; background: var(--accent-color);">Download HTML</button>
                        <button type="button" id="save-btn" class="btn" style="width:auto; background: var(--success-color); margin-left:1rem;">Save to Website</button>
                    </div>
                </form>
                <div id="site-preview" style="margin-top:2rem; background:#f7f8fc; border-radius:8px; padding:1.5rem; box-shadow:0 2px 8px rgba(10,77,104,0.06);"></div>
            </div>

            <div class="control-card" id="grant-chips-card">
                <h2 style="display:flex;align-items:center;gap:0.5rem;"><span style="color:var(--primary-color);font-size:1.5em;">üí∞</span> Grant Chips to Player</h2>
                <p style="margin-bottom:1.2rem;">Give chips to a player by selecting their display name. (Case sensitive, exact match)</p>
                <form id="grant-chips-form" style="display:flex;flex-wrap:wrap;gap:1.2rem;align-items:center;background:rgba(240,246,250,0.85);padding:1.2rem 1.2rem 0.7rem 1.2rem;border-radius:12px;box-shadow:0 2px 8px #0a4d6810;">
                    <div class="form-group" style="margin-bottom:0;min-width:220px;">
                        <label for="grant-player-select">Player</label>
                        <select id="grant-player-select" required style="width:100%;padding:0.7rem 1.1rem;border-radius:8px;border:1.5px solid #d1e3f8;font-size:1.08rem;background:#fff;">
                            <option value="" disabled selected>Loading players...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;min-width:160px;">
                        <label for="grant-chips-amount">Chips to Add</label>
                        <input type="number" id="grant-chips-amount" placeholder="Amount" min="1" required style="width:100%;padding:0.7rem 1.1rem;border-radius:8px;border:1.5px solid #d1e3f8;font-size:1.08rem;background:#fff;">
                    </div>
                    <button type="submit" class="btn" style="background:var(--success-color);margin-top:1.7rem;min-width:160px;">Grant Chips</button>
                </form>
                <div id="grant-chips-message" class="upload-message" style="display:none;margin-top:1.1rem;"></div>
            </div>
        </main>
        
        <div class="site-return-float">
            <a href="index.html" title="Return to Main Site">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>

        <div style="text-align:center;margin:2.5rem 0 0 0;">
            <a href="constructionsnake.html" style="display:inline-block;padding:1rem 2.2rem;font-size:1.3rem;background:linear-gradient(90deg,#e0a106,#ff4e00);color:#fff;text-decoration:none;border-radius:12px;box-shadow:0 2px 8px rgba(224,161,6,0.13);font-weight:600;transition:transform 0.15s;">
                üèóÔ∏è Play Snake
            </a>
        </div>
    </div>

    <script type="module">        // --- Firebase Imports (Fixed with stable version 9.22.0) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            setDoc, 
            getDoc,
            enableIndexedDbPersistence,
            CACHE_SIZE_UNLIMITED 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL, 
            deleteObject 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // --- Your Firebase Configuration (Fixed storage bucket URL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
            authDomain: "cusumano-website.firebaseapp.com",
            projectId: "cusumano-website",
            storageBucket: "cusumano-website.appspot.com", // Fixed URL
            messagingSenderId: "20051552210",
            appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"
        };
        // ----------------------------------------------------        // Initialize Firebase with enhanced error handling and retry logic
        let app, auth, db, storage;
        let connectionRetries = 0;
        const MAX_RETRIES = 3;
        let firebaseListeners = {};
        
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                
                // Set auth persistence to local for better reliability
                setPersistence(auth, browserLocalPersistence)
                    .catch(error => {
                        console.error("Auth persistence error:", error);
                        // Continue without persistence - authentication might still work
                    });
                
                // Enable offline persistence for Firestore with advanced settings
                enableIndexedDbPersistence(db, {cacheSizeBytes: CACHE_SIZE_UNLIMITED})
                    .catch(error => {
                        if (error.code === 'failed-precondition') {
                            console.warn("Firestore persistence unavailable: Multiple tabs open");
                            // Continue without persistence - this isn't fatal
                        } else if (error.code === 'unimplemented') {
                            console.warn("Firestore persistence unavailable: Browser not supported");
                            // Try to implement local fallbacks
                            setupOfflineFallbacks();
                        } else {
                            console.error("Firestore persistence error:", error);
                            setupOfflineFallbacks();
                        }
                    });
                
                // Set up network status monitoring
                window.addEventListener('online', handleOnlineStatus);
                window.addEventListener('offline', handleOfflineStatus);
                
                console.log("Firebase initialized successfully");
                connectionRetries = 0;
                
                // Remove offline message if it exists
                const existingMsg = document.querySelector('.offline-message');
                if (existingMsg) existingMsg.remove();
                
                // Setup auth listener after successful initialization
                setTimeout(setupAuthListener, 500);
            } catch (error) {
                connectionRetries++;
                console.error(`Firebase initialization error (attempt ${connectionRetries}/${MAX_RETRIES}):`, error);
                
                if (connectionRetries < MAX_RETRIES) {
                    const retryDelay = Math.pow(2, connectionRetries) * 1000; // Exponential backoff: 2s, 4s, 8s
                    console.log(`Retrying Firebase initialization in ${retryDelay/1000}s...`);
                    setTimeout(initializeFirebase, retryDelay);
                } else {
                    console.error("Firebase initialization failed after max retries");
                    setupOfflineFallbacks();
                    showOfflineMessage("Firebase connection issues. Limited functionality available.");
                }
            }
        }
        
        function handleOnlineStatus() {
            console.log("Application is online");
            const existingMsg = document.querySelector('.offline-message');
            if (existingMsg) existingMsg.remove();
            
            // Retry any failed operations
            if (db) {
                loadHeroBanner();
            } else if (connectionRetries >= MAX_RETRIES) {
                // If we previously failed completely, try initialization again
                connectionRetries = 0;
                initializeFirebase();
            }
        }
        
        function handleOfflineStatus() {
            console.log("Application is offline");
            showOfflineMessage("You are currently offline. Limited functionality available.");
        }
          function setupOfflineFallbacks() {
            console.log("Setting up offline fallbacks");
            
            // Check for cached data and set up UI to show offline state
            const cachedBanner = localStorage.getItem('cached_heroBanner');
            const cachedContent = localStorage.getItem('cached_siteContent');
              // Set up local cache expiration (24 hours)
            const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            
            // Try-catch entire localStorage operations in case private browsing mode is enabled
            try {
                // Clean up expired cache entries
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cached_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data.timestamp && (new Date().getTime() - data.timestamp > CACHE_EXPIRY)) {
                                console.log(`Removing expired cache entry: ${key}`);
                                localStorage.removeItem(key);
                            }
                        } catch (e) {
                            console.warn(`Error processing cache entry ${key}:`, e);
                            // Remove corrupt cache entries
                            try {
                                localStorage.removeItem(key);
                            } catch (removeErr) {
                                console.error("Failed to remove corrupt cache entry:", removeErr);
                            }
                        }
                    }
                });
            } catch (storageError) {
                // Handle case where localStorage is completely unavailable
                console.warn("LocalStorage unavailable - operating in no-cache mode:", storageError);
            }
            
            // Add visual indicator for offline mode
            document.body.classList.add('offline-mode');
            
            // Allow basic admin panel navigation with cached data
            showOfflineMessage("Operating in offline mode. Some functions are limited until connection is restored.");
        }
          // Clean up all Firebase listeners when needed (e.g., page unload or logout)
        function cleanupFirebaseListeners() {
            // Unsubscribe from any listeners stored in the global firebaseListeners object
            Object.values(firebaseListeners).forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    try {
                        unsubscribe();
                    } catch (e) {
                        console.error("Error unsubscribing:", e);
                    }
                }
            });
            
            // Also check for any legacy listeners stored in the window._firebaseListeners object
            if (window._firebaseListeners) {
                Object.values(window._firebaseListeners).forEach(unsubscribe => {
                    if (typeof unsubscribe === 'function') {
                        try {
                            unsubscribe();
                        } catch (e) {
                            console.error("Error unsubscribing from legacy listener:", e);
                        }
                    }
                });
                window._firebaseListeners = {};
            }
            
            firebaseListeners = {};
        }
          initializeFirebase();
        
        // Add page cleanup handlers for when the user leaves or refreshes the page
        window.addEventListener('beforeunload', () => {
            try {
                cleanupFirebaseListeners();
                console.log("Firebase listeners cleaned up before page unload");
            } catch (e) {
                console.error("Error during page unload cleanup:", e);
            }
        });

        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const galleryContainer = document.getElementById('image-gallery-container');
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const imageCount = document.getElementById('image-count');
        const uploadPreview = document.getElementById('upload-preview');
        const uploadMessage = document.getElementById('upload-message');
        const saveBtn = document.getElementById('save-btn');
        const heroImageUploadInput = document.getElementById('hero-image-upload-input');
        const heroUploadBtn = document.getElementById('hero-upload-btn');
        const heroUploadPreview = document.getElementById('hero-upload-preview');
        const heroUploadProgress = document.getElementById('hero-upload-progress');
        const heroUploadMessage = document.getElementById('hero-upload-message');
        const currentHeroBanner = document.getElementById('current-hero-banner');
        const logoImageUploadInput = document.getElementById('logo-image-upload-input');
        const logoUploadBtn = document.getElementById('logo-upload-btn');
        const logoUploadPreview = document.getElementById('logo-upload-preview');
        const logoUploadProgress = document.getElementById('logo-upload-progress');
        const logoUploadMessage = document.getElementById('logo-upload-message');
        const currentLogoImage = document.getElementById('current-logo-image');

        // --- Static SVG Icon Picker ---
        const iconOptions = [
            { name: 'Home', value: 'home', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>' },
            { name: 'Tool', value: 'tool', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0-1.4 0l-1.3 1.3a1 1 0 0 0 0 1.4l1.3 1.3a1 1 0 0 0 1.4 0l1.3-1.3a1 1 0 0 0 0-1.4l-1.3-1.3z"></path><path d="M19.4 15.4a7 7 0 1 1-9.9-9.9"></path></svg>' },
            { name: 'Truck', value: 'truck', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>' },
            { name: 'Hammer', value: 'hammer', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M17 3a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2v-2H7a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2V7H7a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h10z"></path></svg>' },
            { name: 'Wrench', value: 'wrench', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22.7 19.3a1 1 0 0 1-1.4 0l-7.3-7.3a1 1 0 0 1 0-1.4l7.3-7.3a1 1 0 0 1 1.4 1.4l-6.6 6.6 6.6 6.6a1 1 0 0 1 0 1.4z"></path></svg>' },
            { name: 'Paint', value: 'paint', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Ruler', value: 'ruler', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Saw', value: 'saw', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 16v-2a2 2 0 0 0-2-2h-4V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2z"></path></svg>' },
            { name: 'Clipboard', value: 'clipboard', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="4" rx="1"></rect><rect x="3" y="6" width="18" height="16" rx="2"></rect></svg>' },
            { name: 'Check', value: 'check', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>' },
            { name: 'Users', value: 'users', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>' },
            { name: 'Phone', value: 'phone', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92V21a2 2 0 0 1-2.18 2A19.72 19.72 0 0 1 3 5.18 2 2 0 0 1 5 3h4.09a2 2 0 0 1 2 1.72c.13 1.13.37 2.23.72 3.28a2 2 0 0 1-.45 2.11l-1.27 1.27a16 16 0 0 0 6.29 6.29l1.27-1.27a2 2 0 0 1 2.11-.45c1.05.35 2.15.59 3.28.72A2 2 0 0 1 21 18.91V21z"></path></svg>' },
            { name: 'Mail', value: 'mail', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><polyline points="3 7 12 13 21 7"></polyline></svg>' },
            { name: 'Calendar', value: 'calendar', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' },
            { name: 'Star', value: 'star', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>' },
            { name: 'Shield', value: 'shield', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' },
            { name: 'Briefcase', value: 'briefcase', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Award', value: 'award', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20.13 17 23 15.79 13.88"></polyline></svg>' }
        ];
        const serviceIconSVGs = Object.fromEntries(iconOptions.map(opt => [opt.value, opt.svg]));        // Function to display offline message
        function showOfflineMessage(message = "Connection issues detected. Some functions may be limited.") {
            // Remove any existing messages first
            const existingMsg = document.querySelector('.offline-message');
            if (existingMsg) existingMsg.remove();
            
            const offlineEl = document.createElement('div');
            offlineEl.className = 'offline-message';
            offlineEl.innerHTML = `
                <div style="display:flex;align-items:center;font-size:0.9rem;
                            background:#fff;border:1px solid #f5a623;border-radius:4px;padding:10px 20px;
                            box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                    <span style="color:#f5a623;font-weight:bold;">‚ö†Ô∏è</span>
                    <span style="margin-left:8px;">${message}</span>
                    <button id="dismiss-offline-msg" style="margin-left:12px;background:none;border:none;font-size:1rem;cursor:pointer;color:#aaa;">&times;</button>
                </div>
            `;
            document.body.appendChild(offlineEl);
            
            // Add event listener to dismiss button
            document.getElementById('dismiss-offline-msg').addEventListener('click', () => {
                offlineEl.remove();
            });
            
            // Auto-hide after 10 seconds if we're actually online
            if (navigator.onLine) {
                setTimeout(() => {
                    if (document.body.contains(offlineEl)) {
                        offlineEl.style.opacity = '0';
                        setTimeout(() => {
                            if (document.body.contains(offlineEl)) {
                                offlineEl.remove();
                            }
                        }, 500);
                    }
                }, 10000);
            }
        }
        
        // --- Firebase logic with better error handling ---
        function setupAuthListener() {
            if (!auth) {
                console.error("Auth not initialized");
                return;
            }

            onAuthStateChanged(auth, user => {
                try {
                    if (user) {
                        loginScreen.style.display = 'none';
                        adminDashboard.style.display = 'flex';
                        
                        // Setup all listeners with error handling
                        try { setupImageListener(); } catch (e) { console.error("Image listener error:", e); }
                        try { setupHeroBannerListener(); } catch (e) { console.error("Banner listener error:", e); }
                        try { setupLogoListener(); } catch (e) { console.error("Logo listener error:", e); }
                    } else {
                        adminDashboard.style.display = 'none';
                        loginScreen.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Auth state change processing error:", error);
                }
            }, error => {
                console.error("Auth state observer error:", error);
                loginScreen.style.display = 'block';
                showOfflineMessage();
            });
        }
        
        // Call this after Firebase init
        setTimeout(setupAuthListener, 500);

        loginBtn.addEventListener('click', () => {
            loginError.style.display = 'none';
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            if (!email || !pass) {
                loginError.textContent = "Please enter both email and password.";
                loginError.style.display = 'block';
                return;
            }
            
            if (!auth) {
                loginError.textContent = "Authentication service unavailable. Please try again later.";
                loginError.style.display = 'block';
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = "Logging in...";
            
            signInWithEmailAndPassword(auth, email, pass)
                .then(userCredential => {
                    // Success handled by onAuthStateChanged
                    loginBtn.textContent = "Login";
                    loginBtn.disabled = false;
                })
                .catch(err => {
                    console.error("Login error:", err.code, err.message);
                    loginBtn.textContent = "Login";
                    loginBtn.disabled = false;
                    
                    // More helpful error messages
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || 
                        err.code === 'auth/wrong-password') {
                        loginError.textContent = "Invalid email or password. Please try again.";
                    } else if (err.code === 'auth/network-request-failed') {
                        loginError.textContent = "Network connection issue. Please check your internet connection.";
                    } else {
                        loginError.textContent = "Login failed: " + (err.message || "Unknown error");
                    }
                    loginError.style.display = 'block';
                });
        });        logoutBtn.addEventListener('click', (e) => {
            if (confirm('Are you sure you want to log out?')) {
                try {
                    // First clean up any active Firebase listeners
                    cleanupFirebaseListeners();
                    
                    // Clear any cached user-specific data before logging out
                    // Don't clear cached images as they can be reused on next login
                    
                    // Log out
                    signOut(auth).catch(error => {
                        console.error("Error during logout:", error);
                        // Attempt to force reload if logout fails
                        if (confirm("Logout encountered an error. Would you like to refresh the page?")) {
                            window.location.reload();
                        }
                    });
                } catch (e) {
                    console.error("Error during logout process:", e);
                    alert("There was an issue during logout. The page will be refreshed.");
                    window.location.reload();
                }
            }
        });
        uploadBtn.addEventListener('click', () => imageUploadInput.click());
        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());
        logoUploadBtn.addEventListener('click', () => logoImageUploadInput.click());

        togglePasswordBtn.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePasswordBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                togglePasswordBtn.textContent = 'üëÅÔ∏è';
            }
        });        function setupImageListener() {
            if (!db) {
                console.error("Firestore not initialized");
                galleryContainer.innerHTML = '<div class="error-message">Database connection not available.</div>';
                return;
            }
            
            try {
                const imagesCol = collection(db, 'sliderImages');
                const unsubscribe = onSnapshot(imagesCol, (snapshot) => {
                    try {
                        galleryContainer.innerHTML = '';
                        imageCount.textContent = `Total Images: ${snapshot.size}`;
                        
                        if (snapshot.empty) {
                            galleryContainer.innerHTML = '<div class="empty-gallery">No images available. Upload images using the button above.</div>';
                            return;
                        }
                        
                        snapshot.docs.forEach(doc => {
                            try {
                                const imgData = doc.data();
                                const card = document.createElement('div');
                                card.className = 'img-card';
                                

                                // Create image with error handling
                                const img = document.createElement('img');
                                img.alt = "Slider Image";
                                img.onerror = () => {
                                    img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23f5a623" stroke-width="2"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
                                    img.style.padding = '20px';
                                    img.style.background = '#f8f9fa';
                                };
                                img.src = imgData.url;
                                
                                // Delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'delete-btn';
                                deleteBtn.innerHTML = '&times;';
                                deleteBtn.dataset.id = doc.id;
                                deleteBtn.dataset.path = imgData.path || '';
                                
                                // Add elements to card
                                card.appendChild(img);
                                card.appendChild(deleteBtn);
                                galleryContainer.appendChild(card);
                            } catch (err) {
                                console.error("Error rendering image card:", err);
                            }
                        });
                    } catch (error) {
                        console.error("Error processing snapshot:", error);
                        galleryContainer.innerHTML = '<div class="error-message">Error loading images.</div>';
                    }
                }, error => {
                    console.error("Snapshot listener error:", error);
                    galleryContainer.innerHTML = '<div class="error-message">Error connecting to database. Please check your connection.</div>';
                });
                
                // Store unsubscribe function to clean up
                window._firebaseListeners = window._firebaseListeners || {};
                window._firebaseListeners.images = unsubscribe;
            } catch (error) {
                console.error("setupImageListener error:", error);
                galleryContainer.innerHTML = '<div class="error-message">Failed to set up image gallery.</div>';
            }
        }

        function setupHeroBannerListener() {
            if (!db) {
                console.error("Firestore not initialized");
                return;
            }
            
            try {
                const heroBannerDoc = doc(db, 'siteContent', 'main');
                const unsubscribe = onSnapshot(heroBannerDoc, (docSnap) => {
                    try {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.heroBanner) {
                                // Create image with error handling
                                const img = new Image();
                                img.onload = function() {
                                    currentHeroBanner.innerHTML = '';
                                    currentHeroBanner.appendChild(img);
                                };
                                img.onerror = function() {
                                    currentHeroBanner.innerHTML = '<em>Error loading image.</em>';
                                };
                                img.src = data.heroBanner;
                                img.alt = "Current Hero Banner";
                                img.style.cssText = "max-width:100%; border-radius:8px;";
                            } else {
                                currentHeroBanner.innerHTML = '<em>No hero banner set.</em>';
                            }
                        } else {
                            currentHeroBanner.innerHTML = '<em>Hero banner configuration not found.</em>';
                        }
                    } catch (error) {
                        console.error("Error processing hero banner data:", error);
                        currentHeroBanner.innerHTML = '<em>Error loading hero banner.</em>';
                    }
                }, error => {
                    console.error("Hero banner listener error:", error);
                    currentHeroBanner.innerHTML = '<em>Connection error. Please refresh the page.</em>';
                });
                
                // Store unsubscribe function
                window._firebaseListeners = window._firebaseListeners || {};
                window._firebaseListeners.heroBanner = unsubscribe;
            } catch (error) {
                console.error("setupHeroBannerListener error:", error);
            }
        }

        function setupLogoListener() {
            if (!db) {
                console.error("Firestore not initialized");
                return;
            }
            try {
                const logoDoc = doc(db, 'siteContent', 'main');
                const unsubscribe = onSnapshot(logoDoc, (docSnap) => {
                    try {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data && data.logoUrl) {
                                currentLogoImage.innerHTML = `<img src="${data.logoUrl}" alt="Current Logo" style="max-width:180px;max-height:120px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;">`;
                            } else {
                                currentLogoImage.innerHTML = '<em>No logo image set.</em>';
                            }
                        } else {
                            currentLogoImage.innerHTML = '<em>No logo image set.</em>';
                        }
                    } catch (err) {
                        currentLogoImage.innerHTML = '<em>Error loading logo image.</em>';
                        console.error("Error processing logo data:", err);
                    }
                }, error => {
                    console.error("Logo listener error:", error);
                    currentLogoImage.innerHTML = '<em>Connection error. Please refresh the page.</em>';
                });
                // Store unsubscribe function
                window._firebaseListeners = window._firebaseListeners || {};
                window._firebaseListeners.logo = unsubscribe;
            } catch (error) {
                console.error("setupLogoListener error:", error);
            }
        }

        galleryContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                const storagePath = e.target.dataset.path;
                if(confirm('Are you sure you want to delete this image?')){
                    try {
                        await deleteDoc(doc(db, 'sliderImages', docId));
                        const storageRef = ref(storage, storagePath);
                        await deleteObject(storageRef);
                    } catch (error) {
                        console.error("Error deleting image:", error);
                        alert("Could not delete image. See console for details.");
                    }
                }
            }
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            uploadPreview.innerHTML = '';
            uploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                uploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `sliderImages/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgress.style.display = 'block';
                    uploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    uploadMessage.textContent = 'Upload failed. See console for details.';
                    uploadMessage.className = 'upload-message error';
                    uploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        await addDoc(collection(db, 'sliderImages'), {
                            url: downloadURL,
                            path: storagePath,
                            createdAt: new Date()
                        });
                        uploadProgress.style.display = 'none';
                        imageUploadInput.value = '';
                        uploadPreview.innerHTML = '';
                        uploadMessage.textContent = 'Image uploaded successfully!';
                        uploadMessage.className = 'upload-message success';
                        uploadMessage.style.display = 'block';
                    });
                }
            );
        });        // Load current hero banner image from Firestore with enhanced retry logic and error handling
        async function loadHeroBanner(retryCount = 0) {
            // Helper function for displaying cached data
            const loadFromCache = (showCacheMessage = true) => {
                const cachedData = localStorage.getItem('cached_heroBanner');
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        // Check if cache is fresh enough (less than 24 hours old)
                        const isCacheFresh = data.timestamp && 
                            (new Date().getTime() - data.timestamp < 24 * 60 * 60 * 1000);
                        
                        if (data.heroBannerUrl) {
                            // Only show "cached" indicator if explicitly requested AND cache isn't fresh
                            displayHeroBannerFromUrl(
                                data.heroBannerUrl, 
                                showCacheMessage && !isCacheFresh
                            );
                            return true;
                        }
                    } catch (e) {
                        console.error("Error parsing cached hero banner data:", e);
                    }
                }
                return false;
            };
            
            // If Firebase not initialized, try to use cached data
            if (!db) {
                console.error("Firestore not initialized");
                currentHeroBanner.innerHTML = '<em>Database connection not available.</em>';
                
                if (loadFromCache(true)) {
                    return;
                }
                return;
            }
            
            try {
                // Show loading indicator for better UX
                if (retryCount === 0) {
                    currentHeroBanner.innerHTML = '<em>Loading hero banner...</em>';
                    
                    // Immediately show cached version while waiting for fresh data (if available)
                    loadFromCache(false);
                }
                
                const docRef = doc(db, 'siteContent', 'main');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Cache the data for offline use with timestamp
                    try {
                        localStorage.setItem('cached_heroBanner', JSON.stringify({
                            heroBannerUrl: data.heroBannerUrl || null,
                            timestamp: new Date().getTime()
                        }));
                    } catch (e) {
                        console.warn("Could not cache hero banner data:", e);
                    }
                    
                    if (data.heroBannerUrl) {
                        // Use helper function to display banner
                        displayHeroBannerFromUrl(data.heroBannerUrl, false);
                    } else {
                        currentHeroBanner.innerHTML = '<em>No hero banner image set.</em>';
                    }
                } else {
                    // Document doesn't exist
                    currentHeroBanner.innerHTML = '<em>No hero banner configuration found.</em>';
                }
            } catch (error) {
                console.error("Error loading hero banner:", error);
                
                // Check for specific Firebase errors to handle appropriately
                if (error.name === "FirebaseError") {
                    if (error.code === "permission-denied" || error.code === "unauthenticated") {
                        // Auth error - may need to refresh tokens
                        currentHeroBanner.innerHTML = 
                            `<em>Authentication error. You may need to log in again.</em>
                             <button onclick="signOut(auth).then(() => { window.location.reload(); })" style="display:block;margin-top:8px;padding:4px 10px;background:#e63946;color:white;border:none;border-radius:4px;cursor:pointer;">
                                Log Out
                             </button>`;
                        return;
                    } else if (error.code === "unavailable" || error.code === "resource-exhausted") {
                        // Server-side transient issue - these should definitely retry
                        console.log("Transient server issue. Will retry with higher priority.");
                        setTimeout(() => loadHeroBanner(retryCount + 1), 800);
                        return;
                    }
                }
                
                // Network or other error - try to retry
                const MAX_RETRIES = 3;
                if (retryCount < MAX_RETRIES) {
                    // Retry with exponential backoff
                    const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
                    console.log(`Retrying loadHeroBanner (attempt ${retryCount + 1}/${MAX_RETRIES}) in ${delay/1000}s...`);
                    setTimeout(() => loadHeroBanner(retryCount + 1), delay);
                } else {
                    // Try to use cached data after max retries
                    if (loadFromCache(true)) {
                        return;
                    }
                    
                    // Display error after max retries with more user-friendly message
                    currentHeroBanner.innerHTML = 
                        `<div style="padding:10px;background:#fff3cd;border:1px solid #ffeeba;border-radius:4px;">
                            <em>Unable to load hero banner. Connection issue detected.</em>
                            <button onclick="loadHeroBanner(0)" style="display:block;margin-top:8px;padding:4px 10px;background:#088395;color:white;border:none;border-radius:4px;cursor:pointer;">
                                Try Again
                            </button>
                        </div>`;
                        
                    // Show offline message to notify of connection problems
                    showOfflineMessage("Connection issues detected. Some functions may be limited.");
                }
            }
        }
          // Helper function to display hero banner from URL with enhanced error handling
        function displayHeroBannerFromUrl(url, isFromCache = false) {
            // Create image with comprehensive error handling
            const img = new Image();
            
            // Set a timeout to detect slow-loading images
            const loadingTimeout = setTimeout(() => {
                if (!img.complete) {
                    // Add loading indicator if image is taking time
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'loading-indicator';
                    loadingIndicator.innerHTML = '<em>Loading image...</em>';
                    // Only show loading indicator if currentHeroBanner is empty or just contains loading text
                    if (currentHeroBanner.childElementCount === 0 || 
                        (currentHeroBanner.childElementCount === 1 && 
                         currentHeroBanner.firstChild.nodeName === 'EM')) {
                        currentHeroBanner.innerHTML = '';
                        currentHeroBanner.appendChild(loadingIndicator);
                    }
                }
            }, 500); // Show loading indicator if image takes more than 500ms to load
            
            img.onload = function() {
                clearTimeout(loadingTimeout);
                currentHeroBanner.innerHTML = '';
                currentHeroBanner.appendChild(img);
                
                if (isFromCache) {
                    const cacheNote = document.createElement('div');
                    cacheNote.innerHTML = '<small style="color:#6c757d;"><i>Showing cached version</i></small>';
                    currentHeroBanner.appendChild(cacheNote);
                }
            };
            
            img.onerror = function() {
                clearTimeout(loadingTimeout);
                console.error(`Failed to load image: ${url}`);
                
                if (isFromCache) {
                    // If cached image fails, try to load fresh version
                    currentHeroBanner.innerHTML = '<em>Cached image unavailable. Attempting to refresh...</em>';
                    loadHeroBanner(0); 
                } else {
                    currentHeroBanner.innerHTML = 
                        `<div style="padding:8px;background:#f8d7da;border:1px solid #f5c6cb;border-radius:4px;color:#721c24;">
                            <em>Error loading banner image.</em>
                            <button onclick="loadHeroBanner(0)" style="display:block;margin-top:6px;padding:3px 8px;background:#088395;color:white;border:none;border-radius:3px;cursor:pointer;font-size:0.8rem;">
                                Try Again
                            </button>
                        </div>`;
                }
            };
            
            img.src = url;
            img.alt = "Current Hero Banner";
            img.style.cssText = "max-width:100%;max-height:180px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;";
        }

        // Initial load with slight delay to ensure Firebase is ready
        setTimeout(() => loadHeroBanner(), 500);

        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            heroUploadPreview.innerHTML = '';
            heroUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                heroUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `banner/main-banner_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            heroUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    heroUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    heroUploadMessage.textContent = 'Upload failed. See console for details.';
                    heroUploadMessage.className = 'upload-message error';
                    heroUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { heroBannerUrl: downloadURL }, { merge: true });
                        heroUploadProgress.style.display = 'none';
                        heroImageUploadInput.value = '';
                        heroUploadPreview.innerHTML = '';
                        heroUploadMessage.textContent = 'Hero banner image uploaded and set!';
                        heroUploadMessage.className = 'upload-message success';
                        heroUploadMessage.style.display = 'block';
                        loadHeroBanner();
                    });
                }
            );
        });

        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            logoUploadPreview.innerHTML = '';
            logoUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                logoUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview" style="max-width:120px;max-height:80px;"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `logo/logo_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            logoUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    logoUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    logoUploadMessage.textContent = 'Upload failed. See console for details.';
                    logoUploadMessage.className = 'upload-message error';
                    logoUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { logoUrl: downloadURL }, { merge: true });
                        logoUploadProgress.style.display = 'none';
                        logoImageUploadInput.value = '';
                        logoUploadPreview.innerHTML = '';
                        logoUploadMessage.textContent = 'Logo image uploaded and set!';
                        logoUploadMessage.className = 'upload-message success';
                        logoUploadMessage.style.display = 'block';
                    });
                }
            );
        });
        // --- End of Firebase logic ---

        // --- Website Editor Logic ---
        // Services as an array for reordering
        let services = [
            { id: 'siding', label: 'Siding', value: '', textarea: null, icon: 'home' },
            { id: 'decks', label: 'Decks', value: '', textarea: null, icon: 'tool' },
            { id: 'dumpster', label: 'Dumpster Rentals', value: '', textarea: null, icon: 'truck' }
        ];
        const aboutText = document.getElementById('about-text');
        const contactAddress = document.getElementById('contact-address');
        const contactPhone = document.getElementById('contact-phone');
        const contactEmail = document.getElementById('contact-email');
        const previewBtn = document.getElementById('preview-btn');
        const downloadBtn = document.getElementById('download-html-btn');
        const sitePreview = document.getElementById('site-preview');
        // Replace static service fields with dynamic ones
        const servicesContainer = document.getElementById('services-fields');
        const form = document.getElementById('site-editor-form');
        // Remove old service fields
        ['services-siding','services-decks','services-dumpster'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.closest('.form-group').remove();
        });
        // No need to create or insert servicesContainer, it already exists in the DOM
        function renderServiceFields() {
            servicesContainer.innerHTML = '';
            services.forEach((service, idx) => {
                const group = document.createElement('div');
                group.className = 'form-group service-group';
                group.style.display = 'flex';
                group.style.alignItems = 'flex-start';
                group.style.gap = '0.5rem';
                group.innerHTML = `
                    <div style="flex:1;min-width:0;">
                        <label for="service-${service.id}" style="flex:0 0 140px;">${service.label} Description</label>
                        <textarea id="service-${service.id}" rows="2" class="field-element" style="width:100%;">${service.value}</textarea>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.2rem; align-items:center;">
                        <button type="button" class="move-up" data-idx="${idx}" ${idx===0?'disabled':''} title="Move Up">‚¨ÜÔ∏è</button>
                        <button type="button" class="move-down" data-idx="${idx}" ${idx===services.length-1?'disabled':''} title="Move Down">‚¨áÔ∏è</button>
                        <button type="button" class="remove-service" data-idx="${idx}" title="Remove Service" style="color:#e63946;">‚ûñ</button>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:0.5rem; min-width:180px; max-width:220px;">
                        <div style="margin-bottom:0.3rem;width:100%;">
                            <label for="service-icon-select-${service.id}" style="font-size:0.95rem; color:var(--primary-color);">Icon</label>
                            <select id="service-icon-select-${service.id}" class="service-icon-select" style="width:100%;margin-bottom:0.3rem;padding:0.3rem 0.5rem;border-radius:6px;border:1.5px solid #d1e3f8;">
                                ${iconOptions.map(opt => `<option value="${opt.value}" ${service.icon===opt.value?'selected':''}>${opt.name}</option>`).join('')}
                            </select>
                            <div class="icon-preview" style="margin-top:0.2rem;text-align:center;">${serviceIconSVGs[service.icon] || ''}</div>
                        </div>
                        <div class="upload-area service-upload-area" style="min-width:160px;max-width:200px;">
                            <div class="upload-preview" id="service-upload-preview-${service.id}">${service.imageUrl ? `<img src="${service.imageUrl}" alt="Service Image" style="max-width:120px;max-height:80px;">` : ''}</div>
                            <input type="file" id="service-image-upload-input-${service.id}" accept="image/jpeg, image/png, image/webp, image/svg+xml" hidden>
                            <button type="button" class="btn service-upload-btn" data-idx="${idx}" style="width:auto;background:var(--secondary-color);margin-top:0.3rem;">Upload Image</button>
                            <progress id="service-upload-progress-${service.id}" value="0" max="100" style="display:none;"></progress>
                            <div class="upload-message" id="service-upload-message-${service.id}"></div>
                        </div>
                    </div>
                `;
                servicesContainer.appendChild(group);
                // Icon select logic
                const iconSelect = group.querySelector(`#service-icon-select-${service.id}`);
                const iconPreview = group.querySelector('.icon-preview');
                iconSelect.addEventListener('change', e => {
                    service.icon = e.target.value;
                    iconPreview.innerHTML = serviceIconSVGs[service.icon] || '';
                    renderPreview();
                });
            });
            // Add + button at the bottom
            const addBtnGroup = document.createElement('div');
            addBtnGroup.className = 'form-group';
            addBtnGroup.style.textAlign = 'center';
            addBtnGroup.innerHTML = '<button type="button" id="add-service-btn" class="btn" style="width:auto;font-size:1.5rem;">‚ûï Add Service</button>';
            servicesContainer.appendChild(addBtnGroup);

            // Attach upload listeners for each service
            services.forEach((service, idx) => {
                const uploadBtn = document.querySelector(`.service-upload-btn[data-idx='${idx}']`);
                const uploadInput = document.getElementById(`service-image-upload-input-${service.id}`);
                const uploadPreview = document.getElementById(`service-upload-preview-${service.id}`);
                const uploadProgress = document.getElementById(`service-upload-progress-${service.id}`);
                const uploadMessage = document.getElementById(`service-upload-message-${service.id}`);
                if (uploadBtn && uploadInput) {
                    uploadBtn.onclick = () => uploadInput.click();
                    uploadInput.onchange = (e) => {
                        const file = e.target.files[0];
                        uploadPreview.innerHTML = '';
                        uploadMessage.style.display = 'none';
                        if (!file) return;
                        // Preview
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            uploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview" style="max-width:120px;max-height:80px;"><div>${file.name}</div>`;
                        };
                        reader.readAsDataURL(file);
                        // Upload
                        const storagePath = `serviceImages/${service.id}_${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, storagePath);
                        const uploadTask = uploadBytesResumable(storageRef, file);
                        uploadProgress.style.display = 'block';
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                uploadProgress.value = progress;
                            },
                            (error) => {
                                uploadMessage.textContent = 'Upload failed. See console for details.';
                                uploadMessage.className = 'upload-message error';
                                uploadMessage.style.display = 'block';
                            },
                            () => {
                                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                                    service.imageUrl = downloadURL;
                                    uploadProgress.style.display = 'none';
                                    uploadInput.value = '';
                                    uploadPreview.innerHTML = `<img src="${downloadURL}" alt="Service Image" style="max-width:120px;max-height:80px;">`;
                                    uploadMessage.textContent = 'Image uploaded!';
                                    uploadMessage.className = 'upload-message success';
                                    uploadMessage.style.display = 'block';
                                });
                            }
                        );
                    };
                }
            });
        }
        // Initial values (should match your current site)
        aboutText.value = "For over 20 years, Cusumano Home Improvements has been a family-owned and operated business proudly serving the Monroe, MI area. We are dedicated to delivering the highest quality of work, specializing in residential construction and convenient dumpster rentals. Our commitment is to our craft and, most importantly, to our customers' satisfaction.";
        services[0].value = "Enhance your home's curb appeal and protection with our wide variety of siding options, including vinyl, wood, and fiber cement.";
        services[1].value = "We design and build custom decks or repair existing ones, creating beautiful and lasting outdoor living spaces for you to enjoy.";
        services[2].value = "Convenient and competitively priced dumpster rentals for your project needs, with various sizes and flexible scheduling.";
        contactAddress.value = "Monroe, MI";
        contactPhone.value = "734-777-8158";
        contactEmail.value = "copernan@yahoo.com";
        renderServiceFields();
        // Attach textarea refs and listeners
        function updateServiceRefsAndListeners() {
            services.forEach((service, idx) => {
                service.textarea = document.getElementById(`service-${service.id}`);
                if (service.textarea) {
                    service.textarea.value = service.value;
                    // Remove previous listeners if any (optional, for robustness)
                    service.textarea.oninput = null;
                    service.textarea.addEventListener('input', () => {
                        service.value = service.textarea.value;
                        renderPreview();
                    });
                }
            });
        }
        updateServiceRefsAndListeners();
        // Move up/down logic
        servicesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('move-up')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx > 0) {
                    [services[idx-1], services[idx]] = [services[idx], services[idx-1]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('move-down')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx < services.length-1) {
                    [services[idx], services[idx+1]] = [services[idx+1], services[idx]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('remove-service')) {
                const idx = parseInt(e.target.dataset.idx);
                if (services.length > 1 && confirm(`Remove service: ${services[idx].label}?`)) {
                    services.splice(idx, 1);
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.id === 'add-service-btn') {
                const label = prompt('Enter new service name:');
                if (!label) return;
                if (services.some(s => s.label.toLowerCase() === label.toLowerCase())) {
                    alert('Service already exists.');
                    return;
                }
                const value = prompt('Enter service description:') || '';
                // Always generate a unique id (slug + timestamp)
                const baseId = label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                let id = baseId;
                let counter = 1;
                while (services.some(s => s.id === id)) {
                    id = `${baseId}-${Date.now()}-${counter++}`;
                }
                services.push({ id, label, value, textarea: null, icon: '' });
                renderServiceFields();
                updateServiceRefsAndListeners();
                renderPreview();
            }
        });
        // Live preview on all changes
        [aboutText, contactAddress, contactPhone, contactEmail].forEach(el => {
            el.addEventListener('input', renderPreview);
        });
        function renderPreview() {
            sitePreview.innerHTML = `
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;">About</h2>
                <p>${aboutText.value}</p>
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;">Services</h2>
                <div style="display:flex;flex-wrap:wrap;gap:2rem;">
                    ${services.map(service => `
                        <div style="background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(10,77,104,0.06);padding:1.2rem;min-width:220px;max-width:320px;flex:1;display:flex;flex-direction:column;align-items:center;">
                            <div style="margin-bottom:0.7rem;">
                                ${service.imageUrl ? `<img src="${service.imageUrl}" alt="Service Image" style="max-width:80px;max-height:60px;display:block;margin:0 auto 0.5rem auto;">` : (service.icon ? serviceIconSVGs[service.icon] : '')}
                            </div>
                            <div style="font-weight:700;font-size:1.1rem;color:var(--primary-color);margin-bottom:0.3rem;">${service.label}</div>
                            <div style="font-size:1rem;color:var(--dark-gray);">${service.textarea ? service.textarea.value : service.value}</div>
                        </div>
                    `).join('')}
                </div>
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;margin-top:2rem;">Contact</h2>
                <div><strong>Address:</strong> ${contactAddress.value}</div>
                <div><strong>Phone:</strong> ${contactPhone.value}</div>
                <div><strong>Email:</strong> ${contactEmail.value}</div>
            `;
        }
        // Initial preview
        renderPreview();
        previewBtn.addEventListener('click', renderPreview);
        downloadBtn.addEventListener('click', () => {
            // This is a basic HTML snippet for manual replacement
            const html = `<!-- About Section -->\n<p>${aboutText.value}</p>\n<!-- Services Section -->\n<ul>\n${services.map(s => `<li><strong>${s.label}:</strong> ${s.value}</li>`).join('\n')}\n</ul>\n<!-- Contact Info -->\n<ul>\n<li><strong>Address:</strong> ${contactAddress.value}</li>\n<li><strong>Phone:</strong> ${contactPhone.value}</li>\n<li><strong>Email:</strong> ${contactEmail.value}</li>\n</ul>`;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'site-content.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        // --- Firestore Live Save ---
        saveBtn.addEventListener('click', async () => {
            const about = aboutText.value;
            const contactIntro = "Contact us today for a free, no-obligation quote. We're ready to help bring your vision to life. You can reach out via the form below, or call us directly!";
            const contactAddress = document.getElementById('contact-address').value;
            const contactPhone = document.getElementById('contact-phone').value;
            const contactEmail = document.getElementById('contact-email').value;
            const servicesArr = services.map(s => ({ label: s.label, value: s.value, icon: s.icon || '', imageUrl: s.imageUrl || '' }));
            try {
                // Use merge:true to preserve heroBannerUrl, logoUrl, and any other fields
                await setDoc(doc(db, 'siteContent', 'main'), {
                    about,
                    services: servicesArr,
                    contactIntro,
                    contactAddress,
                    contactPhone,
                    contactEmail
                }, { merge: true });
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            } catch (e) {
                saveBtn.textContent = 'Error!';
                alert('Failed to save site content. Please check your connection and try again.');
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            }
        });

        // When loading from Firestore, also load imageUrl for each service
        async function loadSiteContentFromFirestore() {
            try {
                const docRef = doc(db, 'siteContent', 'main');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.services)) {
                        services = data.services.map((s, idx) => {
                            let id = s.id;
                            if (!id || typeof id !== 'string' || id === 'undefined') {
                                // Generate a unique id if missing or invalid
                                const base = (s.label || 'service').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                                id = `${base}-${Date.now()}-${idx}`;
                            }
                            return {
                                ...s,
                                id,
                                textarea: null,
                                imageUrl: s.imageUrl || '',
                                icon: s.icon || ''
                            };
                        });
                    }
                    aboutText.value = data.about || '';
                    contactAddress.value = data.contactAddress || '';
                    contactPhone.value = data.contactPhone || '';
                    contactEmail.value = data.contactEmail || '';
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } catch (e) {
                // fallback: do nothing
            }
        }

        // On page load, call loadSiteContentFromFirestore instead of just renderServiceFields
        loadSiteContentFromFirestore();

        // --- Grant Chips to Player by Dropdown ---
const grantChipsForm = document.getElementById('grant-chips-form');
const grantChipsMsg = document.getElementById('grant-chips-message');
const grantPlayerSelect = document.getElementById('grant-player-select');

async function populatePlayerDropdown() {
    grantPlayerSelect.innerHTML = '<option value="" disabled selected>Loading players...</option>';
    try {
        const usersRef = collection(db, 'construction21_users');
        const q = query(usersRef, orderBy('displayName'));
        const snap = await getDocs(q);
        if (snap.empty) {
            grantPlayerSelect.innerHTML = '<option value="" disabled>No players found</option>';
            return;
        }
        grantPlayerSelect.innerHTML = '<option value="" disabled selected>Select a player...</option>';
        snap.forEach(doc => {
            const d = doc.data();
            const label = d.displayName + (d.email ? ` (${d.email})` : '');
            grantPlayerSelect.innerHTML += `<option value="${doc.id}">${label}</option>`;
        });
    } catch (err) {
        grantPlayerSelect.innerHTML = '<option value="" disabled>Error loading players</option>';
    }
}

populatePlayerDropdown();

grantChipsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    grantChipsMsg.style.display = 'none';
    const userId = grantPlayerSelect.value;
    const chipsToAdd = parseInt(document.getElementById('grant-chips-amount').value, 10);
    if (!userId || isNaN(chipsToAdd) || chipsToAdd <= 0) {
        grantChipsMsg.textContent = 'Select a player and enter a valid chip amount.';
        grantChipsMsg.className = 'upload-message error';
        grantChipsMsg.style.display = 'block';
        return;
    }
    try {
        // Get the user document directly instead of querying all users
        const userDocRef = doc(db, 'construction21_users', userId);
        const userSnap = await getDoc(userDocRef);
        if (!userSnap.exists()) throw new Error('User not found');
        const userData = userSnap.data();
        const newChips = (userData.chips || 0) + chipsToAdd;
        await setDoc(userDocRef, { chips: newChips }, { merge: true });
        grantChipsMsg.textContent = `Granted ${chipsToAdd} chips to ${userData.displayName}. New balance: ${newChips}`;
        grantChipsMsg.className = 'upload-message success';
        grantChipsMsg.style.display = 'block';
        grantChipsForm.reset();
        populatePlayerDropdown();
    } catch (err) {
        grantChipsMsg.textContent = 'Error: ' + (err.message || err);
        grantChipsMsg.className = 'upload-message error';
        grantChipsMsg.style.display = 'block';
    }
});
    </script>
</body>
</html>
