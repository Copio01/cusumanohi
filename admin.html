<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Cusumano Home Improvements</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0a4d68;
            --secondary-color: #088395;
            --accent-color: #f5a623;
            --light-bg: #f7f8fc;
            --dark-gray: #222b45;
            --medium-gray: #6c757d;
            --white: #ffffff;
            --danger-color: #e63946;
            --success-color: #2a9d8f;
            --glass-bg: rgba(255,255,255,0.75);
            --glass-blur: 16px;
            --shadow-md: 0 8px 32px rgba(10,77,104,0.10);
            --shadow-lg: 0 16px 48px rgba(10,77,104,0.18);
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Roboto', sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--font-body);
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #login-screen {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--shadow-lg);
            border-radius: 18px;
            padding: 3rem 2.5rem 2.5rem 2.5rem;
            max-width: 420px;
            width: 100%;
            text-align: center;
            border: 1.5px solid #e9ecef;
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }
        .login-logo {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #b2d8f7;
        }
        .form-group {
            margin-bottom: 1.7rem;
            text-align: left;
            position: relative;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-color);
            letter-spacing: 0.5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 1rem 1.1rem;
            border: 1.5px solid #d1e3f8;
            border-radius: 10px;
            font-size: 1.08rem;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            transition: border 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus {
            border: 1.5px solid var(--secondary-color);
            outline: none;
            box-shadow: 0 4px 16px rgba(10,77,104,0.10);
        }
        .btn {
            display: inline-block;
            padding: 1rem 2.2rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            font-size: 1.13rem;
            font-family: var(--font-heading);
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: var(--white);
            box-shadow: 0 2px 8px rgba(10,77,104,0.10);
            transition: box-shadow 0.2s, background 0.2s, color 0.2s, transform 0.1s;
            margin-bottom: 0.2rem;
        }
        .btn:hover, .btn:focus {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 6px 24px rgba(10,77,104,0.13);
            filter: brightness(1.07);
            transform: translateY(-2px) scale(1.03);
        }
        .logout-btn {
            background: transparent;
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.05rem;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .logout-btn:hover, .logout-btn:focus {
            background: var(--danger-color);
            color: var(--white);
            box-shadow: 0 4px 16px rgba(230,57,70,0.13);
        }
        #login-error {
            color: var(--danger-color);
            background: rgba(230, 57, 70, 0.13);
            margin-top: 1.5rem;
            padding: 0.9rem;
            border-radius: 10px;
            display: none;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        #admin-dashboard {
            width: 100vw;
            min-height: 100vh;
            display: none;
            flex-direction: column;
            background: linear-gradient(120deg, #e0eafc 0%, #f7f8fc 100%);
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }
        .admin-header {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            padding: 1.2rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1.5px solid #e9ecef;
            box-shadow: 0 2px 12px rgba(10,77,104,0.06);
        }
        .admin-header h1 {
            font-size: 2rem;
            color: var(--primary-color);
            font-family: var(--font-heading);
            font-weight: 700;
            letter-spacing: 1px;
        }
        .admin-main {
            padding: 3.5rem 2.5rem 2.5rem 2.5rem;
            flex-grow: 1;
            overflow-y: auto;
            background: none;
        }
        .control-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            padding: 2.5rem 2rem;
            border-radius: 18px;
            box-shadow: var(--shadow-md);
            border: 1.5px solid #e9ecef;
            margin-bottom: 2.5rem;
            transition: box-shadow 0.2s, transform 0.2s;
            animation: fadeInUp 0.7s cubic-bezier(.4,0,.2,1);
        }
        .control-card:hover, .control-card:focus-within {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px) scale(1.012);
        }
        .form-actions {
            display: flex;
            gap: 1.2rem;
            flex-wrap: wrap;
            margin-top: 2.2rem;
        }
        .upload-area {
            border: 2.5px dashed var(--secondary-color);
            background: rgba(240,246,250,0.85);
            border-radius: 12px;
            padding: 2.2rem 1.2rem;
            text-align: center;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            margin-bottom: 0.5rem;
            position: relative;
        }
        .upload-area:focus-within, .upload-area:hover {
            border-color: var(--accent-color);
            background: #f7f8fc;
            box-shadow: 0 4px 16px rgba(245,166,35,0.08);
        }
        .upload-preview {
            margin-bottom: 1.1rem;
            text-align: center;
        }
        .upload-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(10,77,104,0.10);
            margin-bottom: 0.5rem;
            background: #fff;
        }
        .upload-message {
            margin-top: 1rem;
            font-size: 1.05rem;
            border-radius: 10px;
            padding: 0.7rem 1.1rem;
            display: none;
            font-weight: 600;
        }
        .upload-message.success {
            background: rgba(42,157,143,0.12);
            color: var(--success-color);
            border: 1.5px solid var(--success-color);
        }
        .upload-message.error {
            background: rgba(230,57,70,0.12);
            color: var(--danger-color);
            border: 1.5px solid var(--danger-color);
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.7rem;
            margin-bottom: 2rem;
        }
        .img-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(10,77,104,0.10);
            background: var(--white);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .img-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
            border-radius: 12px 12px 0 0;
        }
        .img-card .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--danger-color), #ffb3b3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 34px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(230,57,70,0.13);
            transition: background 0.2s, transform 0.1s;
        }
        .img-card .delete-btn:hover {
            background: var(--danger-color);
            transform: scale(1.08);
        }
        .image-count {
            font-size: 1.08rem;
            color: var(--medium-gray);
            margin-bottom: 1rem;
            text-align: right;
            font-weight: 600;
        }
        .service-group {
            background: rgba(255,255,255,0.85);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(10,77,104,0.04);
            padding: 1.2rem 1rem 1.2rem 1.2rem;
            margin-bottom: 1.2rem;
            border: 1.5px solid #e9ecef;
            transition: box-shadow 0.2s, border 0.2s;
        }
        .service-group:hover, .service-group:focus-within {
            box-shadow: 0 4px 16px rgba(10,77,104,0.10);
            border: 1.5px solid var(--secondary-color);
        }
        .service-group label {
            color: var(--primary-color);
            font-size: 1.05rem;
        }
        .service-upload-area {
            background: rgba(240,246,250,0.92);
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 1.1rem 0.7rem;
            min-width: 160px;
            max-width: 200px;
            margin-left: 0.5rem;
            margin-top: 0.2rem;
        }
        .service-upload-btn {
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: var(--white);
            border-radius: 8px;
            font-size: 1rem;
            padding: 0.6rem 1.2rem;
            margin-top: 0.3rem;
            width: 100%;
        }
        .service-upload-btn:hover {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .move-up, .move-down, .remove-service {
            background: var(--white);
            border: 1.5px solid #d1e3f8;
            color: var(--primary-color);
            border-radius: 8px;
            font-size: 1.2rem;
            padding: 0.3rem 0.7rem;
            margin-bottom: 0.2rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s, transform 0.1s;
        }
        .move-up:disabled, .move-down:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .move-up:hover:not(:disabled), .move-down:hover:not(:disabled) {
            background: var(--secondary-color);
            color: var(--white);
            border: 1.5px solid var(--secondary-color);
            transform: scale(1.08);
        }
        .remove-service {
            color: var(--danger-color);
            border: 1.5px solid var(--danger-color);
        }
        .remove-service:hover {
            background: var(--danger-color);
            color: var(--white);
            transform: scale(1.08);
        }
        #add-service-btn {
            background: var(--secondary-color);
            color: var(--white);
            border-radius: 10px;
            font-size: 1.3rem;
            padding: 0.7rem 2rem;
            margin-top: 0.7rem;
            width: auto;
            box-shadow: 0 2px 8px rgba(245,166,35,0.10);
        }
        #add-service-btn:hover {
            background: var(--primary-color);
        }
        .toggle-password {
            position: absolute;
            right: 1.1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--medium-gray);
            font-size: 1.2rem;
            padding: 0;
            transition: color 0.2s;
        }
        .toggle-password:hover {
            color: var(--primary-color);
        }
        #site-preview {
            background: rgba(255,255,255,0.92);
            border-radius: 12px;
            padding: 1.7rem 1.2rem;
            box-shadow: 0 2px 8px rgba(10,77,104,0.06);
            font-size: 1.08rem;
            color: var(--dark-gray);
            margin-top: 2rem;
            animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        }
        .site-return-float {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
        }
        .site-return-float a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--white);
            border-radius: 50%;
            text-decoration: none;
            box-shadow: 0 4px 16px rgba(10,77,104,0.18);
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1.5rem;
        }
        .site-return-float a:hover {
            transform: scale(1.13);
            box-shadow: 0 8px 32px rgba(10,77,104,0.22);
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: none; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(32px); }
            to { opacity: 1; transform: none; }
        }
        /* Responsive Design */
        @media (max-width: 900px) {
            .admin-main {
                padding: 1.2rem 0.5rem;
            }
            .control-card {
                padding: 1.2rem 0.7rem;
            }
        }
        @media (max-width: 600px) {
            #login-screen {
                padding: 1.2rem 0.5rem;
            }
            .admin-header {
                padding: 0.7rem 0.7rem;
            }
            .admin-header h1 {
                font-size: 1.3rem;
            }
            .admin-main {
                padding: 0.5rem 0.1rem;
            }
            .control-card {
                padding: 0.7rem 0.3rem;
            }
            .image-gallery {
                gap: 0.7rem;
            }
            .service-group {
                flex-direction: column;
                padding: 0.7rem 0.3rem;
            }
            .service-upload-area {
                min-width: 100px;
                max-width: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="login-logo">Cusumano</h1>
        <p>Admin Panel</p>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group password-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password">
            <button type="button" class="toggle-password" id="toggle-password" aria-label="Show password" title="Show/Hide Password">👁️</button>
        </div>
        <button id="login-btn" class="btn">Login</button>
        <p id="login-error">Error logging in. Check email/password.</p>
    </div>

    <div id="admin-dashboard">
        <header class="admin-header">
            <h1>Dashboard</h1>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </header>

        <main class="admin-main">
            <div class="control-card">
                <h2>Homepage Slider</h2>
                <p>Add or remove photos from the main image slider. Changes will appear on the live site instantly.</p>
                <div class="image-count" id="image-count"></div>
                <div class="image-gallery" id="image-gallery-container">
                    <!-- Images from Firebase will be loaded here -->
                </div>
                <div class="upload-area">
                    <div class="upload-preview" id="upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="upload-btn" class="btn" style="width: auto; background: var(--success-color);">Choose Image</button>
                    <progress id="upload-progress" value="0" max="100"></progress>
                    <div class="upload-message" id="upload-message"></div>
                </div>
            </div>

            <div class="control-card">
                <h2>Hero Banner Image</h2>
                <p>Upload or change the homepage hero banner image. This image appears at the top of the homepage.</p>
                <div class="upload-area" id="hero-upload-area">
                    <div class="upload-preview" id="hero-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="hero-image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <button id="hero-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Banner Image</button>
                    <progress id="hero-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="hero-upload-message"></div>
                </div>
                <div id="current-hero-banner" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card">
                <h2>Logo Image</h2>
                <p>Upload or change the company logo. This logo will appear on the homepage and admin panel.</p>
                <div class="upload-area" id="logo-upload-area">
                    <div class="upload-preview" id="logo-upload-preview"></div>
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="logo-image-upload-input" accept="image/jpeg, image/png, image/webp, image/svg+xml" hidden>
                    <button id="logo-upload-btn" class="btn" style="width: auto; background: var(--primary-color);">Choose Logo Image</button>
                    <progress id="logo-upload-progress" value="0" max="100" style="display:none;"></progress>
                    <div class="upload-message" id="logo-upload-message"></div>
                </div>
                <div id="current-logo-image" style="margin-top:1rem; text-align:center;"></div>
            </div>

            <div class="control-card" id="site-editor-card">
                <h2>Edit Website Text</h2>
                <form id="site-editor-form" autocomplete="off">
                    <div class="form-group">
                        <label for="about-text">About Section</label>
                        <textarea id="about-text" rows="4" class="field-element"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="contact-address">Contact Address</label>
                        <input type="text" id="contact-address" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">Contact Phone</label>
                        <input type="text" id="contact-phone" class="field-element">
                    </div>
                    <div class="form-group">
                        <label for="contact-email">Contact Email</label>
                        <input type="email" id="contact-email" class="field-element">
                    </div>
                    <div class="form-group" id="services-fields">
                        <!-- Dynamic service fields will be inserted here -->
                    </div>
                    <div class="form-actions">
                        <button type="button" id="preview-btn" class="btn" style="width:auto; background: var(--primary-color);">Preview</button>
                        <button type="button" id="download-html-btn" class="btn" style="width:auto; background: var(--accent-color);">Download HTML</button>
                        <button type="button" id="save-btn" class="btn" style="width:auto; background: var(--success-color); margin-left:1rem;">Save to Website</button>
                    </div>
                </form>
                <div id="site-preview" style="margin-top:2rem; background:#f7f8fc; border-radius:8px; padding:1.5rem; box-shadow:0 2px 8px rgba(10,77,104,0.06);"></div>
            </div>
        </main>
        
        <div class="site-return-float">
            <a href="index.html" title="Return to Main Site">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-storage.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",
            authDomain: "cusumano-website.firebaseapp.com",
            projectId: "cusumano-website",
            storageBucket: "cusumano-website.firebasestorage.app",
            messagingSenderId: "20051552210",
            appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"
        };
        // ----------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const galleryContainer = document.getElementById('image-gallery-container');
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const imageCount = document.getElementById('image-count');
        const uploadPreview = document.getElementById('upload-preview');
        const uploadMessage = document.getElementById('upload-message');
        const saveBtn = document.getElementById('save-btn');
        const heroImageUploadInput = document.getElementById('hero-image-upload-input');
        const heroUploadBtn = document.getElementById('hero-upload-btn');
        const heroUploadPreview = document.getElementById('hero-upload-preview');
        const heroUploadProgress = document.getElementById('hero-upload-progress');
        const heroUploadMessage = document.getElementById('hero-upload-message');
        const currentHeroBanner = document.getElementById('current-hero-banner');
        const logoImageUploadInput = document.getElementById('logo-image-upload-input');
        const logoUploadBtn = document.getElementById('logo-upload-btn');
        const logoUploadPreview = document.getElementById('logo-upload-preview');
        const logoUploadProgress = document.getElementById('logo-upload-progress');
        const logoUploadMessage = document.getElementById('logo-upload-message');
        const currentLogoImage = document.getElementById('current-logo-image');

        // --- Static SVG Icon Picker ---
        const iconOptions = [
            { name: 'Home', value: 'home', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>' },
            { name: 'Tool', value: 'tool', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0-1.4 0l-1.3 1.3a1 1 0 0 0 0 1.4l1.3 1.3a1 1 0 0 0 1.4 0l1.3-1.3a1 1 0 0 0 0-1.4l-1.3-1.3z"></path><path d="M19.4 15.4a7 7 0 1 1-9.9-9.9"></path></svg>' },
            { name: 'Truck', value: 'truck', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>' },
            { name: 'Hammer', value: 'hammer', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M17 3a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2v-2H7a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2V7H7a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h10z"></path></svg>' },
            { name: 'Wrench', value: 'wrench', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22.7 19.3a1 1 0 0 1-1.4 0l-7.3-7.3a1 1 0 0 1 0-1.4l7.3-7.3a1 1 0 0 1 1.4 1.4l-6.6 6.6 6.6 6.6a1 1 0 0 1 0 1.4z"></path></svg>' },
            { name: 'Paint', value: 'paint', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Ruler', value: 'ruler', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Saw', value: 'saw', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 16v-2a2 2 0 0 0-2-2h-4V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2z"></path></svg>' },
            { name: 'Clipboard', value: 'clipboard', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="4" rx="1"></rect><rect x="3" y="6" width="18" height="16" rx="2"></rect></svg>' },
            { name: 'Check', value: 'check', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>' },
            { name: 'Users', value: 'users', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>' },
            { name: 'Phone', value: 'phone', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92V21a2 2 0 0 1-2.18 2A19.72 19.72 0 0 1 3 5.18 2 2 0 0 1 5 3h4.09a2 2 0 0 1 2 1.72c.13 1.13.37 2.23.72 3.28a2 2 0 0 1-.45 2.11l-1.27 1.27a16 16 0 0 0 6.29 6.29l1.27-1.27a2 2 0 0 1 2.11-.45c1.05.35 2.15.59 3.28.72A2 2 0 0 1 21 18.91V21z"></path></svg>' },
            { name: 'Mail', value: 'mail', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" rx="2"></rect><polyline points="3 7 12 13 21 7"></polyline></svg>' },
            { name: 'Calendar', value: 'calendar', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' },
            { name: 'Star', value: 'star', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>' },
            { name: 'Shield', value: 'shield', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' },
            { name: 'Briefcase', value: 'briefcase', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"></rect><path d="M16 3v4"></path><path d="M8 3v4"></path></svg>' },
            { name: 'Award', value: 'award', svg: '<svg width="36" height="36" fill="none" stroke="#0a4d68" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20.13 17 23 15.79 13.88"></polyline></svg>' }
        ];
        const serviceIconSVGs = Object.fromEntries(iconOptions.map(opt => [opt.value, opt.svg]));

        // --- Firebase logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.style.display = 'none';
                adminDashboard.style.display = 'flex';
                setupImageListener();
                setupHeroBannerListener();
                setupLogoListener();
            } else {
                adminDashboard.style.display = 'none';
                loginScreen.style.display = 'block';
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => { loginError.style.display = 'block'; });
        });

        logoutBtn.addEventListener('click', (e) => {
            if (confirm('Are you sure you want to log out?')) {
                signOut(auth);
            }
        });
        uploadBtn.addEventListener('click', () => imageUploadInput.click());
        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());
        logoUploadBtn.addEventListener('click', () => logoImageUploadInput.click());

        togglePasswordBtn.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePasswordBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                togglePasswordBtn.textContent = '👁️';
            }
        });

        function setupImageListener() {
            const imagesCol = collection(db, 'sliderImages');
            onSnapshot(imagesCol, (snapshot) => {
                galleryContainer.innerHTML = '';
                imageCount.textContent = `Total Images: ${snapshot.size}`;
                snapshot.docs.forEach(doc => {
                    const imgData = doc.data();
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `<img src="${imgData.url}" alt="Slider Image"><button class="delete-btn" data-id="${doc.id}" data-path="${imgData.path}">&times;</button>`;
                    galleryContainer.appendChild(card);
                });
            });
        }

        function setupHeroBannerListener() {
            const heroBannerDoc = doc(db, 'siteContent', 'main');
            onSnapshot(heroBannerDoc, (doc) => {
                const data = doc.data();
                currentHeroBanner.innerHTML = data.heroBanner ? `<img src="${data.heroBanner}" alt="Current Hero Banner" style="max-width:100%; border-radius:8px;">` : 'No hero banner set.';
            });
        }

        function setupLogoListener() {
            const logoDoc = doc(db, 'siteContent', 'main');
            onSnapshot(logoDoc, (docSnap) => {
                const data = docSnap.data();
                if (data && data.logoUrl) {
                    currentLogoImage.innerHTML = `<img src="${data.logoUrl}" alt="Current Logo" style="max-width:180px;max-height:120px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;">`;
                } else {
                    currentLogoImage.innerHTML = '<em>No logo image set.</em>';
                }
            });
        }
        
        galleryContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                const storagePath = e.target.dataset.path;
                if(confirm('Are you sure you want to delete this image?')){
                    try {
                        await deleteDoc(doc(db, 'sliderImages', docId));
                        const storageRef = ref(storage, storagePath);
                        await deleteObject(storageRef);
                    } catch (error) {
                        console.error("Error deleting image:", error);
                        alert("Could not delete image. See console for details.");
                    }
                }
            }
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            uploadPreview.innerHTML = '';
            uploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                uploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `sliderImages/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgress.style.display = 'block';
                    uploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    uploadMessage.textContent = 'Upload failed. See console for details.';
                    uploadMessage.className = 'upload-message error';
                    uploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        await addDoc(collection(db, 'sliderImages'), {
                            url: downloadURL,
                            path: storagePath,
                            createdAt: new Date()
                        });
                        uploadProgress.style.display = 'none';
                        imageUploadInput.value = '';
                        uploadPreview.innerHTML = '';
                        uploadMessage.textContent = 'Image uploaded successfully!';
                        uploadMessage.className = 'upload-message success';
                        uploadMessage.style.display = 'block';
                    });
                }
            );
        });

        // Load current hero banner image from Firestore
        async function loadHeroBanner() {
            try {
                const docRef = doc(db, 'siteContent', 'main');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.heroBannerUrl) {
                        currentHeroBanner.innerHTML = `<img src="${data.heroBannerUrl}" alt="Current Hero Banner" style="max-width:100%;max-height:180px;border-radius:8px;box-shadow:0 2px 8px rgba(10,77,104,0.10);margin-bottom:0.5rem;">`;
                    } else {
                        currentHeroBanner.innerHTML = '<em>No hero banner image set.</em>';
                    }
                }
            } catch (e) {
                currentHeroBanner.innerHTML = '<em>Error loading hero banner.</em>';
            }
        }

        // Initial load
        loadHeroBanner();

        heroUploadBtn.addEventListener('click', () => heroImageUploadInput.click());

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            heroUploadPreview.innerHTML = '';
            heroUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                heroUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });

        heroImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `banner/main-banner_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            heroUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    heroUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    heroUploadMessage.textContent = 'Upload failed. See console for details.';
                    heroUploadMessage.className = 'upload-message error';
                    heroUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { heroBannerUrl: downloadURL }, { merge: true });
                        heroUploadProgress.style.display = 'none';
                        heroImageUploadInput.value = '';
                        heroUploadPreview.innerHTML = '';
                        heroUploadMessage.textContent = 'Hero banner image uploaded and set!';
                        heroUploadMessage.className = 'upload-message success';
                        heroUploadMessage.style.display = 'block';
                        loadHeroBanner();
                    });
                }
            );
        });

        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            logoUploadPreview.innerHTML = '';
            logoUploadMessage.style.display = 'none';
            if (!file) return;
            // Preview
            const reader = new FileReader();
            reader.onload = function(evt) {
                logoUploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview" style="max-width:120px;max-height:80px;"><div>${file.name}</div>`;
            };
            reader.readAsDataURL(file);
        });
        logoImageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storagePath = `logo/logo_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            logoUploadProgress.style.display = 'block';
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    logoUploadProgress.value = progress;
                },
                (error) => {
                    console.error("Upload failed", error);
                    logoUploadMessage.textContent = 'Upload failed. See console for details.';
                    logoUploadMessage.className = 'upload-message error';
                    logoUploadMessage.style.display = 'block';
                    alert("Upload failed. See console for details.");
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        // Save URL to Firestore
                        await setDoc(doc(db, 'siteContent', 'main'), { logoUrl: downloadURL }, { merge: true });
                        logoUploadProgress.style.display = 'none';
                        logoImageUploadInput.value = '';
                        logoUploadPreview.innerHTML = '';
                        logoUploadMessage.textContent = 'Logo image uploaded and set!';
                        logoUploadMessage.className = 'upload-message success';
                        logoUploadMessage.style.display = 'block';
                    });
                }
            );
        });
        // --- End of Firebase logic ---

        // --- Website Editor Logic ---
        // Services as an array for reordering
        let services = [
            { id: 'siding', label: 'Siding', value: '', textarea: null, icon: 'home' },
            { id: 'decks', label: 'Decks', value: '', textarea: null, icon: 'tool' },
            { id: 'dumpster', label: 'Dumpster Rentals', value: '', textarea: null, icon: 'truck' }
        ];
        const aboutText = document.getElementById('about-text');
        const contactAddress = document.getElementById('contact-address');
        const contactPhone = document.getElementById('contact-phone');
        const contactEmail = document.getElementById('contact-email');
        const previewBtn = document.getElementById('preview-btn');
        const downloadBtn = document.getElementById('download-html-btn');
        const sitePreview = document.getElementById('site-preview');
        // Replace static service fields with dynamic ones
        const servicesContainer = document.getElementById('services-fields');
        const form = document.getElementById('site-editor-form');
        // Remove old service fields
        ['services-siding','services-decks','services-dumpster'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.closest('.form-group').remove();
        });
        // No need to create or insert servicesContainer, it already exists in the DOM
        function renderServiceFields() {
            servicesContainer.innerHTML = '';
            services.forEach((service, idx) => {
                const group = document.createElement('div');
                group.className = 'form-group service-group';
                group.style.display = 'flex';
                group.style.alignItems = 'flex-start';
                group.style.gap = '0.5rem';
                group.innerHTML = `
                    <div style="flex:1;min-width:0;">
                        <label for="service-${service.id}" style="flex:0 0 140px;">${service.label} Description</label>
                        <textarea id="service-${service.id}" rows="2" class="field-element" style="width:100%;">${service.value}</textarea>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.2rem; align-items:center;">
                        <button type="button" class="move-up" data-idx="${idx}" ${idx===0?'disabled':''} title="Move Up">⬆️</button>
                        <button type="button" class="move-down" data-idx="${idx}" ${idx===services.length-1?'disabled':''} title="Move Down">⬇️</button>
                        <button type="button" class="remove-service" data-idx="${idx}" title="Remove Service" style="color:#e63946;">➖</button>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:0.5rem; min-width:180px; max-width:220px;">
                        <div style="margin-bottom:0.3rem;width:100%;">
                            <label for="service-icon-select-${service.id}" style="font-size:0.95rem; color:var(--primary-color);">Icon</label>
                            <select id="service-icon-select-${service.id}" class="service-icon-select" style="width:100%;margin-bottom:0.3rem;padding:0.3rem 0.5rem;border-radius:6px;border:1px solid #d1e3f8;">
                                ${iconOptions.map(opt => `<option value="${opt.value}" ${service.icon===opt.value?'selected':''}>${opt.name}</option>`).join('')}
                            </select>
                            <div class="icon-preview" style="margin-top:0.2rem;text-align:center;">${serviceIconSVGs[service.icon] || ''}</div>
                        </div>
                        <div class="upload-area service-upload-area" style="min-width:160px;max-width:200px;">
                            <div class="upload-preview" id="service-upload-preview-${service.id}">${service.imageUrl ? `<img src="${service.imageUrl}" alt="Service Image" style="max-width:120px;max-height:80px;">` : ''}</div>
                            <input type="file" id="service-image-upload-input-${service.id}" accept="image/jpeg, image/png, image/webp, image/svg+xml" hidden>
                            <button type="button" class="btn service-upload-btn" data-idx="${idx}" style="width:auto;background:var(--secondary-color);margin-top:0.3rem;">Upload Image</button>
                            <progress id="service-upload-progress-${service.id}" value="0" max="100" style="display:none;"></progress>
                            <div class="upload-message" id="service-upload-message-${service.id}"></div>
                        </div>
                    </div>
                `;
                servicesContainer.appendChild(group);
                // Icon select logic
                const iconSelect = group.querySelector(`#service-icon-select-${service.id}`);
                const iconPreview = group.querySelector('.icon-preview');
                iconSelect.addEventListener('change', e => {
                    service.icon = e.target.value;
                    iconPreview.innerHTML = serviceIconSVGs[service.icon] || '';
                    renderPreview();
                });
            });
            // Add + button at the bottom
            const addBtnGroup = document.createElement('div');
            addBtnGroup.className = 'form-group';
            addBtnGroup.style.textAlign = 'center';
            addBtnGroup.innerHTML = '<button type="button" id="add-service-btn" class="btn" style="width:auto;font-size:1.5rem;">➕ Add Service</button>';
            servicesContainer.appendChild(addBtnGroup);

            // Attach upload listeners for each service
            services.forEach((service, idx) => {
                const uploadBtn = document.querySelector(`.service-upload-btn[data-idx='${idx}']`);
                const uploadInput = document.getElementById(`service-image-upload-input-${service.id}`);
                const uploadPreview = document.getElementById(`service-upload-preview-${service.id}`);
                const uploadProgress = document.getElementById(`service-upload-progress-${service.id}`);
                const uploadMessage = document.getElementById(`service-upload-message-${service.id}`);
                if (uploadBtn && uploadInput) {
                    uploadBtn.onclick = () => uploadInput.click();
                    uploadInput.onchange = (e) => {
                        const file = e.target.files[0];
                        uploadPreview.innerHTML = '';
                        uploadMessage.style.display = 'none';
                        if (!file) return;
                        // Preview
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            uploadPreview.innerHTML = `<img src="${evt.target.result}" alt="Preview" style="max-width:120px;max-height:80px;"><div>${file.name}</div>`;
                        };
                        reader.readAsDataURL(file);
                        // Upload
                        const storagePath = `serviceImages/${service.id}_${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, storagePath);
                        const uploadTask = uploadBytesResumable(storageRef, file);
                        uploadProgress.style.display = 'block';
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                uploadProgress.value = progress;
                            },
                            (error) => {
                                uploadMessage.textContent = 'Upload failed. See console for details.';
                                uploadMessage.className = 'upload-message error';
                                uploadMessage.style.display = 'block';
                            },
                            () => {
                                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                                    service.imageUrl = downloadURL;
                                    uploadProgress.style.display = 'none';
                                    uploadInput.value = '';
                                    uploadPreview.innerHTML = `<img src="${downloadURL}" alt="Service Image" style="max-width:120px;max-height:80px;">`;
                                    uploadMessage.textContent = 'Image uploaded!';
                                    uploadMessage.className = 'upload-message success';
                                    uploadMessage.style.display = 'block';
                                });
                            }
                        );
                    };
                }
            });
        }
        // Initial values (should match your current site)
        aboutText.value = "For over 20 years, Cusumano Home Improvements has been a family-owned and operated business proudly serving the Monroe, MI area. We are dedicated to delivering the highest quality of work, specializing in residential construction and convenient dumpster rentals. Our commitment is to our craft and, most importantly, to our customers' satisfaction.";
        services[0].value = "Enhance your home's curb appeal and protection with our wide variety of siding options, including vinyl, wood, and fiber cement.";
        services[1].value = "We design and build custom decks or repair existing ones, creating beautiful and lasting outdoor living spaces for you to enjoy.";
        services[2].value = "Convenient and competitively priced dumpster rentals for your project needs, with various sizes and flexible scheduling.";
        contactAddress.value = "Monroe, MI";
        contactPhone.value = "734-777-8158";
        contactEmail.value = "copernan@yahoo.com";
        renderServiceFields();
        // Attach textarea refs and listeners
        function updateServiceRefsAndListeners() {
            services.forEach((service, idx) => {
                service.textarea = document.getElementById(`service-${service.id}`);
                if (service.textarea) {
                    service.textarea.value = service.value;
                    // Remove previous listeners if any (optional, for robustness)
                    service.textarea.oninput = null;
                    service.textarea.addEventListener('input', () => {
                        service.value = service.textarea.value;
                        renderPreview();
                    });
                }
            });
        }
        updateServiceRefsAndListeners();
        // Move up/down logic
        servicesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('move-up')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx > 0) {
                    [services[idx-1], services[idx]] = [services[idx], services[idx-1]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('move-down')) {
                const idx = parseInt(e.target.dataset.idx);
                if (idx < services.length-1) {
                    [services[idx], services[idx+1]] = [services[idx+1], services[idx]];
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.classList.contains('remove-service')) {
                const idx = parseInt(e.target.dataset.idx);
                if (services.length > 1 && confirm(`Remove service: ${services[idx].label}?`)) {
                    services.splice(idx, 1);
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } else if (e.target.id === 'add-service-btn') {
                const label = prompt('Enter new service name:');
                if (!label) return;
                if (services.some(s => s.label.toLowerCase() === label.toLowerCase())) {
                    alert('Service already exists.');
                    return;
                }
                const value = prompt('Enter service description:') || '';
                // Always generate a unique id (slug + timestamp)
                const baseId = label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                let id = baseId;
                let counter = 1;
                while (services.some(s => s.id === id)) {
                    id = `${baseId}-${Date.now()}-${counter++}`;
                }
                services.push({ id, label, value, textarea: null, icon: '' });
                renderServiceFields();
                updateServiceRefsAndListeners();
                renderPreview();
            }
        });
        // Live preview on all changes
        [aboutText, contactAddress, contactPhone, contactEmail].forEach(el => {
            el.addEventListener('input', renderPreview);
        });
        function renderPreview() {
            sitePreview.innerHTML = `
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;">About</h2>
                <p>${aboutText.value}</p>
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;">Services</h2>
                <div style="display:flex;flex-wrap:wrap;gap:2rem;">
                    ${services.map(service => `
                        <div style="background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(10,77,104,0.06);padding:1.2rem;min-width:220px;max-width:320px;flex:1;display:flex;flex-direction:column;align-items:center;">
                            <div style="margin-bottom:0.7rem;">
                                ${service.imageUrl ? `<img src="${service.imageUrl}" alt="Service Image" style="max-width:80px;max-height:60px;display:block;margin:0 auto 0.5rem auto;">` : (service.icon ? serviceIconSVGs[service.icon] : '')}
                            </div>
                            <div style="font-weight:700;font-size:1.1rem;color:var(--primary-color);margin-bottom:0.3rem;">${service.label}</div>
                            <div style="font-size:1rem;color:var(--dark-gray);">${service.textarea ? service.textarea.value : service.value}</div>
                        </div>
                    `).join('')}
                </div>
                <h2 style="font-family:var(--font-heading);color:var(--primary-color);font-size:1.5rem;margin-top:2rem;">Contact</h2>
                <div><strong>Address:</strong> ${contactAddress.value}</div>
                <div><strong>Phone:</strong> ${contactPhone.value}</div>
                <div><strong>Email:</strong> ${contactEmail.value}</div>
            `;
        }
        // Initial preview
        renderPreview();
        previewBtn.addEventListener('click', renderPreview);
        downloadBtn.addEventListener('click', () => {
            // This is a basic HTML snippet for manual replacement
            const html = `<!-- About Section -->\n<p>${aboutText.value}</p>\n<!-- Services Section -->\n<ul>\n${services.map(s => `<li><strong>${s.label}:</strong> ${s.value}</li>`).join('\n')}\n</ul>\n<!-- Contact Info -->\n<ul>\n<li><strong>Address:</strong> ${contactAddress.value}</li>\n<li><strong>Phone:</strong> ${contactPhone.value}</li>\n<li><strong>Email:</strong> ${contactEmail.value}</li>\n</ul>`;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'site-content.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        // --- Firestore Live Save ---
        saveBtn.addEventListener('click', async () => {
            const about = aboutText.value;
            const contactIntro = "Contact us today for a free, no-obligation quote. We're ready to help bring your vision to life. You can reach out via the form below, or call us directly!";
            const contactAddress = document.getElementById('contact-address').value;
            const contactPhone = document.getElementById('contact-phone').value;
            const contactEmail = document.getElementById('contact-email').value;
            const servicesArr = services.map(s => ({ label: s.label, value: s.value, icon: s.icon || '', imageUrl: s.imageUrl || '' }));
            try {
                // Use merge:true to preserve heroBannerUrl, logoUrl, and any other fields
                await setDoc(doc(db, 'siteContent', 'main'), {
                    about,
                    services: servicesArr,
                    contactIntro,
                    contactAddress,
                    contactPhone,
                    contactEmail
                }, { merge: true });
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            } catch (e) {
                saveBtn.textContent = 'Error!';
                alert('Failed to save site content. Please check your connection and try again.');
                setTimeout(() => { saveBtn.textContent = 'Save to Website'; }, 2000);
            }
        });

        // When loading from Firestore, also load imageUrl for each service
        async function loadSiteContentFromFirestore() {
            try {
                const docRef = doc(db, 'siteContent', 'main');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.services)) {
                        services = data.services.map((s, idx) => {
                            let id = s.id;
                            if (!id || typeof id !== 'string' || id === 'undefined') {
                                // Generate a unique id if missing or invalid
                                const base = (s.label || 'service').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                                id = `${base}-${Date.now()}-${idx}`;
                            }
                            return {
                                ...s,
                                id,
                                textarea: null,
                                imageUrl: s.imageUrl || '',
                                icon: s.icon || ''
                            };
                        });
                    }
                    aboutText.value = data.about || '';
                    contactAddress.value = data.contactAddress || '';
                    contactPhone.value = data.contactPhone || '';
                    contactEmail.value = data.contactEmail || '';
                    renderServiceFields();
                    updateServiceRefsAndListeners();
                    renderPreview();
                }
            } catch (e) {
                // fallback: do nothing
            }
        }

        // On page load, call loadSiteContentFromFirestore instead of just renderServiceFields
        loadSiteContentFromFirestore();
    </script>
</body>
</html>
