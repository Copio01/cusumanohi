<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Cusumano Home Improvements</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0a4d68; --secondary-color: #088395; --accent-color: #f5a623;
            --light-bg: #f7f8fc; --dark-gray: #333333; --medium-gray: #6c757d;
            --white: #ffffff; --danger-color: #e63946; --success-color: #2a9d8f;
            --font-heading: 'Poppins', sans-serif; --font-body: 'Roboto', sans-serif;
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { margin: 0; font-family: var(--font-body); background: linear-gradient(to top right, #eef2f3, #f7f8fc); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-screen { background-color: var(--white); padding: 3rem; border-radius: 12px; box-shadow: var(--shadow-md); width: 100%; max-width: 420px; text-align: center; border: 1px solid #e9ecef; }
        .login-logo { font-family: var(--font-heading); font-weight: 700; font-size: 1.8rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; position: relative; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
        .btn { display: inline-block; width: 100%; padding: 0.9rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 1.1rem; font-family: var(--font-heading); background: linear-gradient(45deg, var(--secondary-color), var(--primary-color)); color: var(--white); }
        #login-error { color: var(--danger-color); background-color: rgba(230, 57, 70, 0.1); margin-top: 1.5rem; padding: 0.8rem; border-radius: 8px; display: none; }
        #admin-dashboard { width: 100%; height: 100vh; display: none; flex-direction: column; background-color: var(--light-bg); }
        .admin-header { background-color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; }
        .admin-header h1 { font-size: 1.5rem; color: var(--primary-color); }
        .logout-btn { background-color: transparent; color: var(--danger-color); border: 2px solid var(--danger-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 700; }
        .admin-main { padding: 2.5rem; flex-grow: 1; overflow-y: auto; }
        .control-card { background-color: var(--white); padding: 2rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .control-card h2 { display: flex; align-items: center; gap: 0.75rem; margin-top: 0; font-size: 1.3rem; }
        
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .img-card { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .img-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .img-card .img-title { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; text-align: center; }
        .img-card .delete-btn { position: absolute; top: 8px; right: 8px; background-color: rgba(230, 57, 70, 0.8); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1rem; line-height: 30px; text-align: center; }
        .upload-area { border: 2px dashed #ced4da; border-radius: 8px; padding: 2rem; text-align: center; background-color: #f8f9fa; }
        .upload-progress-container { margin-top: 1rem; }
        #upload-progress { width: 100%; display: none; }

        /* Category selector */
        .image-category { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; }
        .category-btn { padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--primary-color); background: none; cursor: pointer; }
        .category-btn.active { background: var(--primary-color); color: white; }
        
        /* Button styles */
        .save-gallery-btn { margin-top: 1.5rem; background-color: var(--success-color); width: auto; padding-left: 2rem; padding-right: 2rem; }
        .action-btn-group { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
        .action-btn-group .btn { width: auto; padding-left: 1.5rem; padding-right: 1.5rem; }
        
        /* Storage meter */
        .storage-meter-container { margin-top: 1.5rem; padding: 1rem; border: 1px solid #e9ecef; border-radius: 8px; background-color: var(--light-bg); }
        .storage-meter-label { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--medium-gray); margin-bottom: 0.5rem; }
        .storage-meter { height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; }
        .storage-meter-fill { height: 100%; width: 0%; background-color: var(--secondary-color); transition: width 0.3s ease; }

        /* Message display */
        .status-message { padding: 0.75rem; border-radius: 6px; margin-top: 1rem; display: none; }
        .status-message.success { background-color: rgba(42, 157, 143, 0.2); color: #2a9d8f; display: block; }
        .status-message.info { background-color: rgba(10, 77, 104, 0.1); color: #0a4d68; display: block; }
        .status-message.error { background-color: rgba(230, 57, 70, 0.2); color: #e63946; display: block; }
        
        /* Floating Button on Admin Page */
        .site-return-float { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .site-return-float a { display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: var(--secondary-color); color: var(--white); border-radius: 50%; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .site-return-float a:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 class="login-logo">Cusumano</h1>
        <p>Admin Panel</p>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>
        <button id="login-btn" class="btn">Login</button>
        <p id="login-error">Error logging in. Check username/password.</p>
    </div>

    <div id="admin-dashboard">
        <header class="admin-header">
            <h1>Dashboard</h1>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </header>

        <main class="admin-main">
            <div class="control-card">
                <h2>"Our Work" Gallery Slider</h2>
                <p>Add or remove photos from the "Our Work" image slider on the homepage. Changes will appear on the live site when you click save.</p>
                
                <div class="image-gallery" id="image-gallery-container">
                    <!-- Images will be loaded here -->
                </div>
                
                <div class="upload-area">
                    <p>Click or drag file to this area to upload</p>
                    <input type="file" id="image-upload-input" accept="image/jpeg, image/png, image/webp" hidden>
                    <div>
                        <button id="upload-btn" class="btn" style="width: auto; background: var(--secondary-color);">Choose Image</button>
                    </div>
                    
                    <div class="image-category">
                        <p>Select category:</p>
                        <button class="category-btn active" data-category="siding">Siding</button>
                        <button class="category-btn" data-category="windows">Windows</button>
                        <button class="category-btn" data-category="decks">Decks</button>
                        <button class="category-btn" data-category="dumpsters">Dumpsters</button>
                        <button class="category-btn" data-category="other">Other</button>
                    </div>
                    
                    <div class="upload-progress-container">
                        <progress id="upload-progress" value="0" max="100"></progress>
                    </div>
                    
                    <p id="status-message" class="status-message"></p>
                </div>
                
                <!-- Storage usage meter -->
                <div class="storage-meter-container">
                    <h3>Storage Usage</h3>
                    <div class="storage-meter-label">
                        <span>0 MB</span>
                        <span id="storage-usage-text">0 MB used</span>
                        <span>5 MB (max)</span>
                    </div>
                    <div class="storage-meter">
                        <div id="storage-meter-fill" class="storage-meter-fill"></div>
                    </div>
                    <p class="storage-info" id="storage-info-message">LocalStorage has a ~5MB limit. Large images may cause you to hit this limit.</p>
                </div>
                
                <div class="action-btn-group">
                    <button id="save-gallery-btn" class="btn save-gallery-btn">Save Changes</button>
                    <button id="export-btn" class="btn" style="background-color: var(--accent-color);">Export Backup</button>
                    <input type="file" id="import-input" accept="application/json" hidden>
                    <button id="import-btn" class="btn" style="background-color: var(--medium-gray);">Import Backup</button>
                </div>
            </div>
        </main>
        
        <div class="site-return-float">
            <a href="index.html" title="Return to Main Site">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </a>
        </div>
    </div>

    <script>
        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const galleryContainer = document.getElementById('image-gallery-container');
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadProgress = document.getElementById('upload-progress');
        const statusMessage = document.getElementById('status-message');
        const saveGalleryBtn = document.getElementById('save-gallery-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importInput = document.getElementById('import-input');
        const storageMeterFill = document.getElementById('storage-meter-fill');
        const storageUsageText = document.getElementById('storage-usage-text');
        const storageInfoMessage = document.getElementById('storage-info-message');
        
        // Gallery images array
        let galleryImages = [];
        
        // Default admin credentials
        const ADMIN_USERNAME = 'copio01@yahoo.com';
        const SALT = 'cusumano-salt-20250609'; // A unique salt for this application
        // SHA-256 hash of SALT + "HellaLarge01!"
        // Calculated as: await hashPassword("HellaLarge01!", SALT)
        // For "cusumano-salt-20250609HellaLarge01!", the SHA-256 hash is:
        const ADMIN_PASSWORD_HASH = '2b9308c99b0791f691e4730989f8e3789904005195019003f06fd8998018ac80';

        // Helper function to convert ArrayBuffer to hex string
        function bufferToHex(buffer) {
            return Array.from(new Uint8Array(buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Async function to hash password with a salt
        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(salt + password); // Prepend salt to password
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return bufferToHex(hashBuffer);
        }
        
        // IndexedDB setup - for larger storage capacity (up to 50MB-several GB)
        const DB_NAME = 'cusumanoGallery';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';
        let db;

        // Initialize IndexedDB
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject("Could not open IndexedDB");
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB opened successfully");
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        console.log("IndexedDB store created");
                    }
                };
            });
        }
        
        // Save gallery images to IndexedDB
        function saveToIndexedDB(images) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject("IndexedDB not initialized");
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // Clear existing data
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    console.log("Cleared existing images from IndexedDB");
                    
                    // Use small localStorage object as a reference to images in IndexedDB
                    const imageRefs = images.map((img, index) => ({
                        id: index + 1,
                        category: img.category,
                        alt: img.alt
                    }));
                    localStorage.setItem('galleryImageRefs', JSON.stringify(imageRefs));
                    
                    // Add all images one by one
                    let completed = 0;
                    images.forEach((img, index) => {
                        const imageData = {
                            id: index + 1,
                            dataUrl: img.dataUrl,
                            alt: img.alt || '',
                            category: img.category || 'other'
                        };
                        
                        const addRequest = store.put(imageData);
                        
                        addRequest.onsuccess = () => {
                            completed++;
                            if (completed === images.length) {
                                resolve();
                            }
                        };
                        
                        addRequest.onerror = (event) => {
                            console.error("Error adding image to IndexedDB:", event.target.error);
                            reject(event.target.error);
                        };
                    });
                };
                
                clearRequest.onerror = (event) => {
                    console.error("Error clearing IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
                
                transaction.oncomplete = () => {
                    console.log("All images saved to IndexedDB");
                    resolve();
                };
            });
        }
        
        // Load gallery images from IndexedDB
        function loadFromIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject("IndexedDB not initialized");
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const images = event.target.result;
                    console.log("Loaded from IndexedDB:", images.length, "images");
                    resolve(images);
                };
                
                request.onerror = (event) => {
                    console.error("Error loading from IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // Session management
        function checkLoginStatus() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                loginScreen.style.display = 'none';
                adminDashboard.style.display = 'flex';
                loadGalleryImages();
                updateStorageMeter();
            } else {
                adminDashboard.style.display = 'none';
                loginScreen.style.display = 'block';
            }
        }
        
        // Initialize app - start with IndexedDB
        async function initApp() {
            try {
                await initIndexedDB();
                checkLoginStatus();
            } catch (error) {
                console.error("Error initializing app:", error);
                // Fall back to localStorage if IndexedDB fails
                checkLoginStatus();
            }
        }
        
        // Call initApp instead of checkLoginStatus directly
        initApp();
        
        // Login button click
        loginBtn.addEventListener('click', async () => { // Made async
            const username = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            loginError.style.display = 'none';
            
            const enteredPasswordHash = await hashPassword(pass, SALT);
            
            if (username === ADMIN_USERNAME && enteredPasswordHash === ADMIN_PASSWORD_HASH) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                checkLoginStatus();
            } else {
                loginError.style.display = 'block';
            }
        });

        // Password field: press Enter to login
        document.getElementById('password').addEventListener('keypress', async (e) => { // Made async
            if (e.key === 'Enter') {
                // Simulate login button click behavior
                const username = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                loginError.style.display = 'none';

                const enteredPasswordHash = await hashPassword(pass, SALT);

                if (username === ADMIN_USERNAME && enteredPasswordHash === ADMIN_PASSWORD_HASH) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    checkLoginStatus();
                } else {
                    loginError.style.display = 'block';
                }
            }
        });

        // Logout button click
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('adminLoggedIn');
            checkLoginStatus();
        });
        
        // Image upload button click
        uploadBtn.addEventListener('click', () => {
            imageUploadInput.click();
        });
        
        // Handle image file selection
        imageUploadInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                
                // Get selected category
                const categoryBtn = document.querySelector('.category-btn.active');
                const category = categoryBtn ? categoryBtn.getAttribute('data-category') : 'other';
                
                // Create image object
                const img = {
                    dataUrl,
                    alt: file.name,
                    category
                };
                
                // Add to gallery and save
                galleryImages.push(img);
                await saveToIndexedDB(galleryImages);
                loadGalleryImages();
                
                // Show success message
                showStatusMessage('Image uploaded successfully!', 'success');
            };
            
            reader.readAsDataURL(file);
        });
        
        // Load and display gallery images
        async function loadGalleryImages() {
            const images = await loadFromIndexedDB();
            galleryContainer.innerHTML = ''; // Clear existing images
            
            images.forEach((img) => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.innerHTML = `
                    <img src="${img.dataUrl}" alt="${img.alt}">
                    <div class="img-title">${img.alt}</div>
                    <button class="delete-btn" data-id="${img.id}">&times;</button>
                `;
                galleryContainer.appendChild(div);
            });
        }
        
        // Delete image from gallery and IndexedDB
        galleryContainer.addEventListener('click', async (e) => {
            if (!e.target.classList.contains('delete-btn')) return;
            
            const id = parseInt(e.target.getAttribute('data-id'));
            galleryImages = galleryImages.filter(img => img.id !== id);
            await saveToIndexedDB(galleryImages);
            loadGalleryImages();
            
            showStatusMessage('Image deleted successfully!', 'success');
        });
        
        // Show status message
        function showStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }
        
        // Save gallery button click
        saveGalleryBtn.addEventListener('click', async () => {
            await saveToIndexedDB(galleryImages);
            showStatusMessage('Gallery saved successfully!', 'success');
        });
        
        // Export backup button click
        exportBtn.addEventListener('click', () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(galleryImages));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "gallery_backup.json");
            downloadAnchor.click();
            
            showStatusMessage('Backup exported successfully!', 'success');
        });
        
        // Import backup button click
        importBtn.addEventListener('click', () => {
            importInput.click();
        });
        
        // Handle backup file import
        importInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const importedImages = JSON.parse(e.target.result);
                    galleryImages = importedImages;
                    
                    await saveToIndexedDB(galleryImages);
                    loadGalleryImages();
                    
                    showStatusMessage('Backup imported successfully!', 'success');
                } catch (error) {
                    console.error("Error importing backup:", error);
                    showStatusMessage('Error importing backup. Please try again.', 'error');
                }
            };
            
            reader.readAsText(file);
        });
        
        // Update storage meter
        function updateStorageMeter() {
            const usage = calculateLocalStorageUsage(); // Calculates localStorage usage for refs and other data
            
            storageMeterFill.style.width = `${usage.percentUsed}%`; // Meter reflects localStorage usage
            
            if (db) { // If IndexedDB is available (primary storage for image data)
                storageUsageText.textContent = `${usage.usedMB.toFixed(2)}MB localStorage (refs) + IndexedDB (images)`;
                storageInfoMessage.textContent = 'Images are stored in IndexedDB, offering significantly more space. Uploads are capped at 5MB per image for performance. The meter above shows localStorage usage for image references and other site data.';
                storageInfoMessage.style.color = 'var(--medium-gray)'; // Use CSS variable correctly
                
                // Color of meter based on localStorage usage
                if (usage.percentUsed > 80) {
                    storageMeterFill.style.backgroundColor = 'var(--danger-color)';
                } else if (usage.percentUsed > 60) {
                    storageMeterFill.style.backgroundColor = 'var(--accent-color)';
                } else {
                    storageMeterFill.style.backgroundColor = 'var(--success-color)';
                }
            } else { // Fallback to localStorage only for images
                storageUsageText.textContent = `${usage.usedMB.toFixed(2)}MB used (${usage.galleryMB.toFixed(2)}MB gallery)`;
                storageInfoMessage.textContent = 'Images are stored in localStorage, which has a ~5MB limit. Large images may cause issues.';
                
                // Color changes based on localStorage usage
                if (usage.percentUsed > 80) {
                    storageMeterFill.style.backgroundColor = 'var(--danger-color)';
                    storageInfoMessage.style.color = 'var(--danger-color)'; // Use CSS variable correctly
                } else if (usage.percentUsed > 60) {
                    storageMeterFill.style.backgroundColor = 'var(--accent-color)';
                    storageInfoMessage.style.color = 'var(--medium-gray)'; // Use CSS variable correctly
                } else {
                    storageMeterFill.style.backgroundColor = 'var(--success-color)';
                    storageInfoMessage.style.color = 'var(--medium-gray)'; // Use CSS variable correctly
                }
            }
        }
    </script>
</body>
</html>
